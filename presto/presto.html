<!DOCTYPE html>
<html lang="zh_cn">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<meta name="keywords" content="TDP, Hadoop, bigdata, Spark">
<meta name="author" content="湖南天云魔方数据科技有限公司">
<title>Presto 使用文档</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments, .listingblock .pygments code { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Presto 使用文档</h1>
<div class="details">
<span id="author" class="author">湖南天云魔方数据科技有限公司</span><br>
<span id="revdate">2015</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">目录</div>
<ul class="sectlevel1">
<li><a href="#_概述">1. 概述</a>
<ul class="sectlevel2">
<li><a href="#_用例">1.1. 用例</a></li>
</ul>
</li>
<li><a href="#_安装">2. 安装</a>
<ul class="sectlevel2">
<li><a href="#_部署presto">2.1. 部署Presto</a></li>
<li><a href="#_命令行接口">2.2. 命令行接口</a></li>
<li><a href="#_jdbc驱动">2.3. JDBC驱动</a></li>
<li><a href="#_presto校验器">2.4. Presto校验器</a></li>
<li><a href="#_基准测试驱动">2.5. 基准测试驱动</a></li>
<li><a href="#_队列配置">2.6. 队列配置</a></li>
</ul>
</li>
<li><a href="#_连接器">3. 连接器</a>
<ul class="sectlevel2">
<li><a href="#_cassandra连接器">3.1. Cassandra连接器</a></li>
<li><a href="#_hive连接器">3.2. Hive连接器</a></li>
<li><a href="#_jmx连接器">3.3. JMX连接器</a></li>
<li><a href="#_kafka连接器">3.4. Kafka连接器</a></li>
<li><a href="#_kafka连接器教程">3.5. Kafka连接器教程</a></li>
<li><a href="#_mysql连接器">3.6. MySQL连接器</a></li>
<li><a href="#_postgresql连接器">3.7. PostgreSQL连接器</a></li>
<li><a href="#_系统方案">3.8. 系统方案</a></li>
<li><a href="#_tpch连接器">3.9. TPCH连接器</a></li>
<li><a href="#_逻辑运算符">3.10. 逻辑运算符</a></li>
<li><a href="#_比较函数和运算符">3.11. 比较函数和运算符</a></li>
<li><a href="#_条件表达式">3.12. 条件表达式</a></li>
<li><a href="#_转换函数">3.13. 转换函数</a></li>
<li><a href="#_数学函数和运算符">3.14. 数学函数和运算符</a></li>
<li><a href="#_字符串函数和运算符">3.15. 字符串函数和运算符</a></li>
<li><a href="#_二进制函数">3.16. 二进制函数</a></li>
<li><a href="#_日期时间函数和运算符">3.17. 日期时间函数和运算符</a></li>
<li><a href="#_正则表达式函数">3.18. 正则表达式函数</a></li>
<li><a href="#_json函数">3.19. JSON函数</a></li>
<li><a href="#_url函数">3.20. URL函数</a></li>
<li><a href="#_聚合函数">3.21. 聚合函数</a></li>
<li><a href="#_窗口函数">3.22. 窗口函数</a></li>
<li><a href="#_颜色函数">3.23. 颜色函数</a></li>
<li><a href="#_数组函数和运算符">3.24. 数组函数和运算符</a></li>
<li><a href="#_map函数和运算符">3.25. Map函数和运算符</a></li>
<li><a href="#_数据类型">3.26. 数据类型</a></li>
</ul>
</li>
<li><a href="#_sql语法声明">4. SQL语法声明</a>
<ul class="sectlevel2">
<li><a href="#_修改表">4.1. 修改表</a></li>
<li><a href="#_建表">4.2. 建表</a></li>
<li><a href="#_建视图">4.3. 建视图</a></li>
<li><a href="#_查看表结构">4.4. 查看表结构</a></li>
<li><a href="#_删表">4.5. 删表</a></li>
<li><a href="#_删视图">4.6. 删视图</a></li>
<li><a href="#_解释">4.7. 解释</a></li>
<li><a href="#_插入">4.8. 插入</a></li>
<li><a href="#_重置会话">4.9. 重置会话</a></li>
<li><a href="#_查询">4.10. 查询</a></li>
<li><a href="#_设置会话">4.11. 设置会话</a></li>
<li><a href="#_显示catalog">4.12. 显示CATALOG</a></li>
<li><a href="#_显示列">4.13. 显示列</a></li>
<li><a href="#_显示函数">4.14. 显示函数</a></li>
<li><a href="#_显示分区">4.15. 显示分区</a></li>
<li><a href="#_显示库">4.16. 显示库</a></li>
<li><a href="#_显示会话">4.17. 显示会话</a></li>
<li><a href="#_显示表">4.18. 显示表</a></li>
<li><a href="#_使用">4.19. 使用</a></li>
</ul>
</li>
<li><a href="#_迁移">5. 迁移</a>
<ul class="sectlevel2">
<li><a href="#_从hive迁移">5.1. 从Hive迁移</a></li>
</ul>
</li>
<li><a href="#_开发者指南">6. 开发者指南</a>
<ul class="sectlevel2">
<li><a href="#_spi概述">6.1. SPI概述</a></li>
<li><a href="#_http连接器示例">6.2. HTTP连接器示例</a></li>
<li><a href="#_类型系统">6.3. 类型系统</a></li>
<li><a href="#_函数">6.4. 函数</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_概述">1. 概述</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Presto是一个分布式SQL查询引擎，用于查询分布在一个或多个不同数据源中的大数据集。</p>
</div>
<div class="sect2">
<h3 id="_用例">1.1. 用例</h3>
<div class="paragraph">
<p>这一章将会细致的分析一下Presto，从而可以让管理员和终端用户深入的了解什么是Presto。</p>
</div>
<div class="paragraph">
<p><strong>Presto不是什么</strong></p>
</div>
<div class="paragraph">
<p>虽然Presto一直被一些个人或者团体称为 数据库 ，但是Presto并不是数据库。</p>
</div>
<div class="paragraph">
<p>千万不要以为Presto可以解析SQL，那么Presto就是一个标准的数据库。Presto并不是传统意义上的数据库。Presto并不是MySQL、PostgreSQL或者Oracle的代替品。Presto并不能用来处理在线事务。其实很多其他的数据库产品也是被用来设计为数据仓库或者数据分析工具，但是也不能处理在线事务</p>
</div>
<div class="paragraph">
<p><strong>Presto是什么</strong></p>
</div>
<div class="paragraph">
<p>Presto通过使用分布式查询，可以快速高效的完成海量数据的查询。如果你需要处理TB或者PB级别的数据，那么你可能更希望借助于Hadoop和HDFS来完成这些数据的处理。作为Hive和Pig（Hive和Pig都是通过MapReduce的管道流来完成HDFS数据的查询）的替代者，Presto不仅可以访问HDFS，也可以操作不同的数据源，包括：RDBMS和其他的数据源（例如：Cassandra）。</p>
</div>
<div class="paragraph">
<p>Presto被设计为数据仓库和数据分析产品：数据分析、大规模数据聚集和生成报表。这些工作经常通常被认为是线上分析处理操作。</p>
</div>
<div class="paragraph">
<p><strong>谁使用Presto？</strong></p>
</div>
<div class="paragraph">
<p>Presto是FaceBook开源的一个开源项目。Presto在FaceBook诞生，并且由FaceBook内部工程师和开源社区的工程师公共维护和改进。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_安装">2. 安装</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_部署presto">2.1. 部署Presto</h3>
<div class="paragraph">
<p><strong>安装Presto</strong></p>
</div>
<div class="paragraph">
<p>下载 <code>Presto server tarball</code>,<mark><a href="http://presto-server-0.100.tar.gzhttp" class="bare">http://presto-server-0.100.tar.gzhttp</a></mark>,将它解压。它包含一个顶级目录,<code>presto-server-$0.180</code>，我们叫它安装目录。</p>
</div>
<div class="paragraph">
<p>Presto需要一个用于存储日志、本地元数据等的数据目录。 建议在安装目录的外面创建一个数据目录。这样方便Presto进行升级。</p>
</div>
<div class="paragraph">
<p><strong>配置Presto</strong></p>
</div>
<div class="paragraph">
<p>在安装目录中创建一个etc目录。 在这个etc目录中放入以下配置信息：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>节点属性：每个节点的环境配置信息</p>
</li>
<li>
<p>JVM 配置：JVM的命令行选项</p>
</li>
<li>
<p>配置属性：Presto server的配置信息</p>
</li>
<li>
<p>Catalog属性：<code>configuration forConnectors</code>（数据源）的配置信息</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Node Properties</strong></p>
</div>
<div class="paragraph">
<p>节点属性配置文件：<code>etc/node.properties</code> 包含针对于每个节点的特定的配置信息。一个节点就是在一台机器上安装的Presto实例。 这份配置文件一般情况下是在Presto第一次安装的时候，由部署系统创建的。一个 <code>etc/node.properties</code> 配置文件至少包含如下配置信息：</p>
</div>
<div class="listingblock">
<div class="content">
<pre> node.environment=production
 node.id=ffffffff-ffff-ffff-ffff-ffffffffffff
 node.data-dir=/var/presto/data</pre>
</div>
</div>
<div class="paragraph">
<p>针对上面的配置信息描述如下：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>node.environment： 集群名称。所有在同一个集群中的Presto节点必须拥有相同的集群名称。</p>
</li>
<li>
<p>node.id： 每个Presto节点的唯一标示。每个节点的node.id都必须是唯一的。在Presto进行重启或者升级过程中每个节点的node.id必须保持不变。
如果在一个节点上安装多个Presto实例（例如：在同一台机器上安装多个Presto节点），那么每个Presto节点必须拥有唯一的node.id。</p>
</li>
<li>
<p>node.data-dir： 数据存储目录的位置（操作系统上的路径）。Presto将会把日期和数据存储在这个目录下。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>JVM配置</strong></p>
</div>
<div class="paragraph">
<p>JVM配置文件，<code>etc/jvm.config</code>， 包含一系列在启动JVM的时候需要使用的命令行选项。这份配置文件的格式是：一系列的选项，每行配置一个单独的选项。由于这些选项不在shell命令中使用。因此即使将每个选项通过空格或者其他的分隔符分开，java程序也不会将这些选项分开，而是作为一个命令行选项处理。（就想下面例子中的OnOutOfMemoryError选项）</p>
</div>
<div class="paragraph">
<p>一个典型的 <code>etc/jvm.config</code> 配置文件如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre> -server
-Xmx16G
-XX:+UseConcMarkSweepGC
-XX:+ExplicitGCInvokesConcurrent
-XX:+CMSClassUnloadingEnabled
-XX:+AggressiveOpts
-XX:+HeapDumpOnOutOfMemoryError
-XX:OnOutOfMemoryError=kill -9 %p
-XX:ReservedCodeCacheSize=150M</pre>
</div>
</div>
<div class="paragraph">
<p>由于OutOfMemoryError将会导致JVM处于不一致状态，所以遇到这种错误的时候我们一般的处理措施就是将dump headp中的信息（用于debugging），然后强制终止进程。</p>
</div>
<div class="paragraph">
<p>Presto会将查询编译成字节码文件，因此Presto会生成很多class，因此我们我们应该增大Perm区的大小（在Perm中主要存储class）并且要允许Jvm class unloading。</p>
</div>
<div class="paragraph">
<p><strong>Config Properties</strong></p>
</div>
<div class="paragraph">
<p>Presto的配置文件：<code>etc/config.properties</code> 包含了Presto server的所有配置信息。每个Presto server既是一个coordinator也是一个worker。 但是在大型集群中，处于性能考虑，建议单独用一台机器作为 coordinator。</p>
</div>
<div class="paragraph">
<p>一个coordinator的 <code>etc/config.properties</code> 应该至少包含以下信息：</p>
</div>
<div class="listingblock">
<div class="content">
<pre> coordinator=true
node-scheduler.include-coordinator=false
http-server.http.port=8080
task.max-memory=1GB
discovery-server.enabled=true
discovery.uri=http://example.net:8080</pre>
</div>
</div>
<div class="paragraph">
<p>以下是最基本的worker配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>coordinator=false
http-server.http.port=8080
task.max-memory=1GB
discovery.uri=http://example.net:8080</pre>
</div>
</div>
<div class="paragraph">
<p>但是如果你用一台机器进行测试，那么这一台机器将会即作为coordinator，也作为worker。配置文件将会如下所示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>coordinator=true
node-scheduler.include-coordinator=true
http-server.http.port=8080
task.max-memory=1GB
discovery-server.enabled=true
discovery.uri=http://example.net:8080</pre>
</div>
</div>
<div class="paragraph">
<p>对配置项解释如下：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>coordinator：指定是否运维Presto实例作为一个coordinator(接收来自客户端的查询情切管理每个查询的执行过程)。</p>
</li>
<li>
<p>node-scheduler.include-coordinator：是否允许在coordinator服务中进行调度工作。对于大型的集群，在一个节点上的Presto server即作为coordinator又作为worke将会降低查询性能。因为如果一个服务器作为worker使用，那么大部分的资源都不会被worker占用，那么就不会有足够的资源进行关键任务调度、管理和监控查询执行。</p>
</li>
<li>
<p>http-server.http.port：指定HTTP server的端口。Presto 使用 HTTP进行内部和外部的所有通讯。</p>
</li>
<li>
<p>task.max-memory=1GB：一个单独的任务使用的最大内存 (一个查询计划的某个执行部分会在一个特定的节点上执行)。这个配置参数限制的GROUP BY语句中的Group的数目、JOIN关联中的右关联表的大小、ORDER BY语句中的行数和一个窗口函数中处理的行数。该参数应该根据并发查询的数量和查询的复杂度进行调整。如果该参数设置的太低，很多查询将不能执行；但是如果设置的太高将会导致JVM把内存耗光。</p>
</li>
<li>
<p>discovery-server.enabled：Presto 通过Discovery 服务来找到集群中所有的节点。为了能够找到集群中所有的节点，每一个Presto实例都会在启动的时候将自己注册到discovery服务。Presto为了简化部署，并且也不想再增加一个新的服务进程，Presto coordinator 可以运行一个内嵌在coordinator 里面的Discovery 服务。这个内嵌的Discovery 服务和Presto共享HTTP server并且使用同样的端口。</p>
</li>
<li>
<p>discovery.uri：Discovery server的URI。由于启用了Presto coordinator内嵌的Discovery 服务，因此这个uri就是Presto coordinator的uri。修改example.net:8080，根据你的实际环境设置该URI。注意：这个URI一定不能以“/“结尾。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>日志级别</strong></p>
</div>
<div class="paragraph">
<p>日志配置文件：<code>etc/log.properties</code>。在这个配置文件中允许你根据不同的日志结构设置不同的日志级别。每个logger都有一个名字（通常是使用logger的类的全标示类名）. Loggers通过名字中的“.“来表示层级和集成关系。 (像java里面的包). 如下面的log配置信息：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>com.facebook.presto=INFO</pre>
</div>
</div>
<div class="paragraph">
<p>这将为 <code>com.facebook.presto.server</code> 和 <code>com.facebook.presto.hive</code> 设定最低水平INFO。默认的最小级别是 <code>INFO</code>（因此上面的例子实际上并没有改变任何东西）。有四个级别：<code>DEBUG</code>，<code>INFO</code>，<code>WARN</code> 和 <code>ERROR</code>。</p>
</div>
<div class="paragraph">
<p><strong>Catalog Properties</strong></p>
</div>
<div class="paragraph">
<p>Presto通过connectors访问数据。这些connectors挂载在catalogs上。 connector 可以提供一个catalog中所有的schema和表。例如： Hive connector 将每个hive的database都映射成为一个schema,所以如果hive connector挂载到了名为hive的catalog， 并且在hive的web有一张名为clicks的表，那么在Presto中可以通过 <code>hive.web.clicks</code> 来访问这张表。</p>
</div>
<div class="paragraph">
<p>通过在 <code>etc/catalog</code> 目录下创建catalog属性文件来完成catalogs的注册。例如：可以先创建一个 <code>etc/catalog/jmx.properties</code> 文件，文件中的内容如下，完成在jmxcatalog上挂载一个jmxconnector：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>connector.name=jmx</pre>
</div>
</div>
<div class="paragraph">
<p>查看Connectors的详细配置选项。</p>
</div>
<div class="paragraph">
<p><strong>运行Presto</strong></p>
</div>
<div class="paragraph">
<p>在安装目录的bin/launcher文件，就是启动脚本。Presto可以使用如下命令作为一个后台进程启动：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bin/launcher start</pre>
</div>
</div>
<div class="paragraph">
<p>另外，也可以在前台运行， 日志和相关输出将会写入stdout/stderr（可以使用类似daemontools的工具捕捉这两个数据流）：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bin/launcher run</pre>
</div>
</div>
<div class="paragraph">
<p>运行bin/launcher–help，Presto将会列出支持的命令和命令行选项。 另外可以通过运行bin/launcher–verbose命令，来调试安装是否正确。</p>
</div>
<div class="paragraph">
<p>启动完之后，日志将会写在var/log目录下，该目录下有如下文件：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>launcher.log：这个日志文件由launcher创建，并且server的stdout和stderr都被重定向到了这个日志文件中。这份日志文件中只会有很少的信息，包括：</p>
</li>
<li>
<p>在server日志系统初始化的时候产生的日志和JVM产生的诊断和测试信息。</p>
</li>
<li>
<p>server.log：这个是Presto使用的主要日志文件。一般情况下，该文件中将会包括server初始化失败时产生的相关信息。这份文件会被自动轮转和压缩。</p>
</li>
<li>
<p>http-request.log：这是HTTP请求的日志文件，包括server收到的每个HTTP请求信息，这份文件会被自动轮转和压缩。</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_命令行接口">2.2. 命令行接口</h3>
<div class="paragraph">
<p>Presto CLI为用户提供了一个用于查询的可交互终端窗口。CLI是一个 <mark>可执行</mark> JAR文件, 这也就意味着你可以像UNIX终端窗口一样来使用CLI。</p>
</div>
<div class="paragraph">
<p>下载 <mark>presto-cli-0.100-executable.jar</mark> ，重名名为 presto ， 使用 chmod +x 命令设置可执行权限，然后执行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./presto --server localhost:8080 --catalog hive --schema default</pre>
</div>
</div>
<div class="paragraph">
<p>使用 <code>--help</code> 选项运行CLI，可以看到可用的选项。</p>
</div>
<div class="paragraph">
<p>默认情况下，查询的结果是分页的。而这种分页的实现不需要你去编写什么代码，而是通过配置一系列的配置信息来实现的。你也可以通过将环境变量：PRESTO_PAGER 设置为你自己的程序名称来自己实现分页或者也可以PRESTO_PAGER 的值设置为空，从而禁止分页。</p>
</div>
</div>
<div class="sect2">
<h3 id="_jdbc驱动">2.3. JDBC驱动</h3>
<div class="paragraph">
<p>通过使用JDBC驱动，可以访问Presto。下载 <mark>presto-jdbc-0.100.jar</mark> 并将这个jar文件添加到你的java应用程序的classpath中，Presto支持的URL格式如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>jdbc:presto://host:port
jdbc:presto://host:port/catalog
jdbc:presto://host:port/catalog/schema</pre>
</div>
</div>
<div class="paragraph">
<p>例如，可以使用下面的URL来连接运行在example.net服务器8080端口上的Presto的hive catalog中的sales schema：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>jdbc:presto://example.net:8080/hive/sales</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_presto校验器">2.4. Presto校验器</h3>
<div class="paragraph">
<p>我们可以使用Presto Verifier 来将Presto与其他的数据库（例如：MySql）进行对比测试或者将两个Presto集群相互进行对比测试。如果我们需要对Presto进行二次开发，那么我们将会使用Presto Verifier不间断的与Presto的前一版本进行对比测试。</p>
</div>
<div class="paragraph">
<p>第一步：创建一个MySQL数据库，并且在数据库中用如下语句创建一个表：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span class="tok-k">CREATE</span> <span class="tok-k">TABLE</span> <span class="tok-n">verifier_queries</span><span class="tok-p">(</span>
    <span class="tok-n">id</span> <span class="tok-nb">INT</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span> <span class="tok-n">AUTO_INCREMENT</span><span class="tok-p">,</span>
    <span class="tok-n">suite</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">256</span><span class="tok-p">)</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
    <span class="tok-n">name</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">256</span><span class="tok-p">),</span>
    <span class="tok-n">test_catalog</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">256</span><span class="tok-p">)</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
    <span class="tok-n">test_schema</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">256</span><span class="tok-p">)</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
    <span class="tok-n">test_query</span> <span class="tok-nb">TEXT</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
    <span class="tok-n">control_catalog</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">256</span><span class="tok-p">)</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
    <span class="tok-n">control_schema</span> <span class="tok-nb">VARCHAR</span><span class="tok-p">(</span><span class="tok-mi">256</span><span class="tok-p">)</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
    <span class="tok-n">control_query</span> <span class="tok-nb">TEXT</span> <span class="tok-k">NOT</span> <span class="tok-k">NULL</span><span class="tok-p">,</span>
    <span class="tok-k">PRIMARY</span> <span class="tok-k">KEY</span> <span class="tok-p">(</span><span class="tok-n">id</span><span class="tok-p">)</span>
<span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>第二步，创建一个属性文件，通过该属性文件来配置校验器：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>suite=my_suite
query-database=jdbc:mysql://localhost:3306/my_database?user=my_username&amp;password=my_password
control.gateway=jdbc:presto://localhost:8080
test.gateway=jdbc:presto://localhost:8081
thread-count=1</pre>
</div>
</div>
<div class="paragraph">
<p>最后一步, 下载 <mark>presto-verifier-0.100-executable.jar</mark>，并将其重命名为：verifier，通过命令：chmod +x为其赋予执行权限，然后运行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>./verifier config.properties</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_基准测试驱动">2.5. 基准测试驱动</h3>
<div class="paragraph">
<p>基准驱动程序可用于测量Presto群集中查询的性能。我们用它来连续测量 <mark>trunk</mark> 的性能。</p>
</div>
<div class="paragraph">
<p>下载 <mark>presto-benchmark-driver-0.100-executable.jar</mark>，将其重命名为presto-benchmark-driver，然后使其可执行chmod + x</p>
</div>
<div class="paragraph">
<p><strong>Suites</strong></p>
</div>
<div class="paragraph">
<p>创建一个suite.json文件：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "file_formats": {
        "query": ["single_.*", "tpch_.*"],
        "schema": [ "tpch_sf(?&lt;scale&gt;.*)_(?&lt;format&gt;.*)_(?&lt;compression&gt;.*?)" ]
    },
    "legacy_orc": {
        "query": ["single_.*", "tpch_.*"],
        "schema": [ "tpch_sf(?&lt;scale&gt;.*)_(?&lt;format&gt;orc)_(?&lt;compression&gt;.*?)" ],
        "session": {
            "hive.optimized_reader_enabled": "false"
        }
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>此示例包含两个suites文件file_formats和legacy_orc，在和正则表达式tpch_sf.<strong><em>.*</em>.</strong>?匹配的所有模式中 file_formats suite将运行具有与正则表达式suite single_.<strong>或tpch_.*的名称匹配的查询。
该legacy_orc suite增加了一个会话属性，以停用优化ORC读者只有在运行tpch_sf.*<em>orc</em>.</strong>? 架构。</p>
</div>
<div class="paragraph">
<p><strong>查询</strong></p>
</div>
<div class="paragraph">
<p>SQL文件包含在名为sql的目录中，并且必须具有 .sql文件扩展名。查询的名称是没有扩展名的文件的名称。</p>
</div>
<div class="paragraph">
<p><strong>输出</strong></p>
</div>
<div class="paragraph">
<p>基准驱动程序将测量所有Presto进程使用的停留时间，总CPU时间以及查询使用的CPU时间。对于每个时序，驱动程序会报告查询运行的中位数，平均值和标准偏差。进程和查询CPU时间之间的区别是查询开销，通常来自垃圾回收。以下是上面的 <code>file_formats</code> suite的输出 ：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>suite        query          compression format scale wallTimeP50 wallTimeMean wallTimeStd processCpuTimeP50 processCpuTimeMean processCpuTimeStd queryCpuTimeP50 queryCpuTimeMean queryCpuTimeStd
============ ============== =========== ====== ===== =========== ============ =========== ================= ================== ================= =============== ================ ===============
file_formats single_varchar none        orc    100   597         642          101         100840            97180              6373              98296           94610            6628
file_formats single_bigint  none        orc    100   238         242          12          33930             34050              697               32452           32417            460
file_formats single_varchar snappy      orc    100   530         525          14          99440             101320             7713              97317           99139            7682
file_formats single_bigint  snappy      orc    100   218         238          35          34650             34606              83                33198           33188            83
file_formats single_varchar zlib        orc    100   547         543          38          105680            103373             4038              103029          101021           3773
file_formats single_bigint  zlib        orc    100   282         269          23          38990             39030              282               37574</pre>
</div>
</div>
<div class="paragraph">
<p>请注意，上述输出已经从驱动程序输出的标准TSV重新格式化为可读性。</p>
</div>
<div class="paragraph">
<p>驱动程序可以通过从模式名称或SQL文件中提取值来向输出添加其他列。在上面的suite文件中，模式名称包含用于压缩，格式化和缩放的命名正则表达式捕获组，因此，如果我们在包含模式 <code>tpch_sf100_orc_none</code>，<code>tpch_sf100_orc_snappy</code> 和 <code>tpch_sf100_orc_zlib</code> 的目录中运行查询，我们得到上述输出。</p>
</div>
<div class="paragraph">
<p>创建其他输出列的另一种方法是将标记添加到SQL文件。例如，以下SQL文件声明了两个标签， 投影和过滤器：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>projection=true
filter=false
=================
SELECT SUM(LENGTH(comment))
FROM lineitem</pre>
</div>
</div>
<div class="paragraph">
<p>这将导致驱动程序为此查询的每次运行输出这些值。</p>
</div>
<div class="paragraph">
<p><strong>CLI 参数</strong></p>
</div>
<div class="paragraph">
<p>该基准测试驱动程序包含了许多CLI参数用来控制suites和查询的运行，热身运行的次数和测量运行的次数。所有的命令行参数都可以通过&#8212;&#8203;help选项看到。
== Administration</p>
</div>
</div>
<div class="sect2">
<h3 id="_队列配置">2.6. 队列配置</h3>
<div class="paragraph">
<p>排队规则定义在一个Json文件中，用于控制能够提交给Presto的查询的个数，以及每个队列中能够同时运行的查询的个数。用config.properties中的 <code>query.queue-config-file</code> 来指定Json配置文件的名字。</p>
</div>
<div class="paragraph">
<p>排队规则如果定义了多个队列，查询会按顺序依次进入不同的队列中。排队规则将按照顺序进行处理，并且使用第一个匹配上的规则。
在以下的配置例子中，有5个队列模板，在 <code>user.${USER}</code> 队列中， <code>${USER}</code> 表示着提交查询的用户名。同样的 <code>${SOURCE}</code> 表示提交查询的来源。</p>
</div>
<div class="paragraph">
<p>同样有五条规则定义了哪一类查询会进入哪一个队列中：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>第一条规则将使 <code>bob</code> 成为管理员，<code>bob</code> 提交的查询进入admin队列。</p>
</li>
<li>
<p>第二条规则表示，所有使用了 <code>experimental_big_querysession</code> 参数并且来源包含 <code>pipeline</code> 的查询将首先进入用户的个人队列中，然后进入 <code>pipeline</code> 队列，最后进入big队列中。
当一个查询进入一个新的队列后，直到查询结束 才会离开之前的队列。</p>
</li>
<li>
<p>第三条规则同上一条类似，但是没有 <code>experimental_big_query</code> 的要求，同时用 <code>global</code> 队列替换了 <code>big</code> 队列。</p>
</li>
<li>
<p>最后两条规则跟以上两条规则类似，但是没有了 <code>pipeline</code> 来源的要求。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>所有这些规则实现了这样的策略，<code>bob</code> 是一个管理员，而其他用户需要遵循以下的限制：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>每个用户最多能同时运行5个查询。</p>
</li>
<li>
<p><code>big</code> 查询同时只能运行一个</p>
</li>
<li>
<p>最多能同时运行10个 <code>pipeline</code> 来源的查询。</p>
</li>
<li>
<p>最多能同时运行100个非 <code>big</code> 查询</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  "queues": {
    "user.${USER}": {
      "maxConcurrent": 5,
      "maxQueued": 20
    },
    "pipeline": {
      "maxConcurrent": 10,
      "maxQueued": 100
    },
    "admin": {
      "maxConcurrent": 100,
      "maxQueued": 100
    },
    "global": {
      "maxConcurrent": 100,
      "maxQueued": 1000
    },
    "big": {
      "maxConcurrent": 1,
      "maxQueued": 10
    }
  },
  "rules": [
    {
      "user": "bob",
      "queues": ["admin"]
    },
    {
      "session.experimental_big_query": "true",
      "source": ".*pipeline.*",
      "queues": [
        "user.${USER}",
        "pipeline",
        "big"
      ]
    },
    {
      "source": ".*pipeline.*",
      "queues": [
        "user.${USER}",
        "pipeline",
        "global"
      ]
    },
    {
      "session.experimental_big_query": "true",
      "queues": [
        "user.${USER}",
        "big"
      ]
    },
    {
      "queues": [
        "user.${USER}",
        "global"
      ]
    }
  ]
}</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_连接器">3. 连接器</h2>
<div class="sectionbody">
<div class="paragraph">
<p>本章介绍Presto连接器， 用于访问不同数据源的数据。</p>
</div>
<div class="sect2">
<h3 id="_cassandra连接器">3.1. Cassandra连接器</h3>
<div class="paragraph">
<p>Cassandra连接器</p>
</div>
<div class="paragraph">
<p>可以使用 Cassandra connector 查询存储在Cassandra中的数据。</p>
</div>
<div class="paragraph">
<p><strong>配置</strong></p>
</div>
<div class="paragraph">
<p>创建一个文件 etc/catalog/cassandra.properties ，该文件的内容如下</p>
</div>
<div class="listingblock">
<div class="content">
<pre>connector.name=cassandra
cassandra.contact-points=host1,host2</pre>
</div>
</div>
<div class="paragraph">
<p>以上配置项将会在cassandra catalog 上挂载一个cassandra connector。根据实际环境修改host1,host2 。
cassandra.contact-points 的内容必须是以逗号分隔的Cassandra 节点，这些节点用来发现集群的逻辑结构。如果cassandra不使用默认的9142端口，你还要设置 <code>cassandra.native-protocol-port</code> 的值。</p>
</div>
<div class="paragraph">
<p>多个Cassandra群集</p>
</div>
<div class="paragraph">
<p>您可以根据需要拥有尽可能多的目录，所以如果您有其他的Cassandra群集，只需将其他属性文件添加到etc/catalog中， 并以不同的名称（确保以.properties结尾）。
例如，如果您将属性文件命名为sales.properties，Presto将使用配置的连接器创建一个名为sales的目录。</p>
</div>
<div class="paragraph">
<p>配置属性</p>
</div>
<div class="paragraph">
<p>以下配置属性可用：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.contact-points</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comma-separated list of hosts in a Cassandra cluster. The Cassandra driver will use these contact points to discover cluster topology. At least one Cassandra host is required.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.native-protocol-port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Cassandra server port running the native client protocol (defaults to 9042).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.thrift-port</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The Cassandra server port running the Thrift client protocol (defaults to 9160).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.limit-for-partition-key-select</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limit of rows to read for finding all partition keys. If a Cassandra table has more rows than this value, splits based on token ranges are used instead. Note that for larger values you may need to adjust read timeout for Cassandra.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.max-schema-refresh-threads</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum number of schema cache refresh threads. This property corresponds to the maximum number of parallel requests.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.schema-cache-ttl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum time that information about a schema will be cached (defaults to 1h).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.schema-refresh-interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The schema information cache will be refreshed in the background when accessed if the cached data is at least this old (defaults to 2m).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.consistency-level</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Consistency levels in Cassandra refer to the level of consistency to be used for both read and write operations. More information about consistency levels can be found in the Cassandra consistency documentation. This property defaults to a consistency level of ONE. Possible values include ALL, EACH_QUORUM, QUORUM, LOCAL_QUORUM, ONE, TWO, THREE, LOCAL_ONE, ANY, SERIAL, LOCAL_SERIAL.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.allow-drop-table</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set to true to allow dropping Cassandra tables from Presto via 删表 (defaults to false).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Username used for authentication to the Cassandra cluster. This is a global setting used for all connections, regardless of the user who is connected to Presto.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Password used for authentication to the Cassandra cluster. This is a global setting used for all connections, regardless of the user who is connected to Presto.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>以下高级配置属性可用：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.fetch-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of rows fetched at a time in a Cassandra query.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.fetch-size-for-partition-key-select</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of rows fetched at a time in a Cassandra query that selects partition keys.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.partition-size-for-batch-select</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of partitions batched together into a single select for a single partion key column table.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.split-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of keys per split when querying Cassandra.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.partitioner</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Partitioner to use for hashing and data distribution. This property defaults to Murmur3Partitioner. The other supported values are RandomPartitioner and ByteOrderedPartitioner.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.thrift-connection-factory-class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for the specification of a custom implementation of org.apache.cassandra.thrift.ITransportFactory to be used to connect to Cassandra using the Thrift protocol.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.transport-factory-options</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows for the specification of arbitrary options to be passed to the Thrift connection factory.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.client.read-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum time the Cassandra driver will wait for an answer to a query from one Cassandra node. Note that the underlying Cassandra driver may retry a query against more than one node in the event of a read timeout. Increasing this may help with queries that use an index.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.client.connect-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maximum time the Cassandra driver will wait to establish a connection to a Cassandra node. Increasing this may help with heavily loaded Cassandra clusters.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.client.so-linger</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of seconds to linger on close if unsent data is queued. If set to zero, the socket will be closed immediately. When this option is non-zero, a socket will linger that many seconds for an acknowledgement that all data was written to a peer. This option can be used to avoid consuming sockets on a Cassandra server by immediately closing connections when they are no longer needed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cassandra.retry-policy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Policy used to retry failed requests to Cassandra. This property defaults to DEFAULT. Using BACKOFF may help when queries fail with “not enough replicas”. The other possible values are DOWNGRADING_CONSISTENCY and FALLTHROUGH.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>查询Cassandra表</strong></p>
</div>
<div class="paragraph">
<p>在用户表是从Cassandra的一个例子卡桑德拉表 入门指南。它可以 使用Cassandra的cqlsh（CQL交互式终端）与mykeyspace键空间一起创建：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>cqlsh&gt; CREATE KEYSPACE mykeyspace
   ... WITH REPLICATION = { 'class' : 'SimpleStrategy', 'replication_factor' : 1 };
cqlsh&gt; USE mykeyspace;
cqlsh:mykeyspace&gt; CREATE TABLE users (
              ...   user_id int PRIMARY KEY,
              ...   fname text,
              ...   lname text
              ... );</pre>
</div>
</div>
<div class="paragraph">
<p>这个表可以在Presto中描述：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>DESCRIBE cassandra.mykeyspace.users;</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre> Column  |  Type   | Null | Partition Key | Comment
---------+---------+------+---------------+---------
 user_id | bigint  | true | true          |
 fname   | varchar | true | false         |
 lname   | varchar | true | false         |
(3 rows)</pre>
</div>
</div>
<div class="paragraph">
<p>然后可以在Presto中查询此表：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT * FROM cassandra.mykeyspace.users;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hive连接器">3.2. Hive连接器</h3>
<div class="paragraph">
<p>Hive连接器允许查询存储在Hive数据仓库中的数据。蜂巢是三个组件的组合：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>通常存储在Hadoop分布式文件系统（HDFS）或Amazon S3中的不同格式的数据文件。</p>
</li>
<li>
<p>关于数据文件如何映射到模式和表的元数据。该元数据存储在MySQL等数据库中，并通过Hive转移服务进行访问。</p>
</li>
<li>
<p>一种称为HiveQL的查询语言。此查询语言在分布式计算框架（如MapReduce或Tez）上执行。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Presto只使用前两个组件：数据和元数据。它不使用HiveQL或Hive的执行环境的任何部分。</p>
</div>
<div class="paragraph">
<p><strong>配置</strong></p>
</div>
<div class="paragraph">
<p>针对不同的hadoop版本，Presto都有对应的hive连接器：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>hive-hadoop1：Apache Hadoop 1.x</p>
</li>
<li>
<p>hive-hadoop2：Apache Hadoop 2.x</p>
</li>
<li>
<p>hive-cdh4：Cloudera CDH 4</p>
</li>
<li>
<p>hive-cdh5：Cloudera CDH 5</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>创建一个包含有以下内容的文件：<code>etc / catalog / hive.properties</code>，从而在 <code>hive</code> 目录中挂载 <code>hive-cdh4</code> 的连接器根据你实际的hadoop版本和环境替换掉 <code>hive-cdh4</code> 和 <code>example.net:9083</code>：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>connector.name=hive-cdh4
hive.metastore.uri=thrift://example.net:9083</pre>
</div>
</div>
<div class="paragraph">
<p><strong>多个Hive群集</strong></p>
</div>
<div class="paragraph">
<p>如果需要你可以设置很多目录，所以若你现在又多了一个蜂巢集群，你只需要在等/目录目录下添加一个另一个配置文件就行了（切记：配置文件一定要以。的.properties结尾）例如，如果您将属性文件命名为sales.properties，Presto将使用已配置的连接器创建名为sales的目录。如果连接到多个Hive metastore，您可以创建配置Hive连接器多个实例的任意数量的属性文件。</p>
</div>
<div class="paragraph">
<p><strong>HDFS配置</strong></p>
</div>
<div class="paragraph">
<p>如果hive metastore的引用文件存放在一个存在联邦的HDFS上，或者你是通过其他非标准的客户端来访问HDFS集群的，请添加以下配置信息来指向你的HDFS配置文件:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>hive.config.resources=/etc/hadoop/conf/core-site.xml,/etc/hadoop/conf/hdfs-site.xml</pre>
</div>
</div>
<div class="paragraph">
<p>大多数情况下，Presto会在安装过程中自动完成HDFS客户端的配置。 如果确实需要特殊配置，只需要添加一些额外的配置文件，并且需要指定这些新加的配置文件。
建议将配置文件中的配置属性最小化。尽量少添加一些配置属性，因为过多的添加配置属性会引起其他问题。</p>
</div>
<div class="paragraph">
<p><strong>配置属性</strong></p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Example</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hive.metastore.uri</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The URI of the Hive Metastore to connect to using the Thrift protocol. This property is required.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">thrift://192.0.2.3:9083</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hive.config.resources</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An optional comma-separated list of HDFS configuration files. These files must exist on the machines running Presto. Only specify this if absolutely necessary to access HDFS.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/etc/hdfs-site.xml</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hive.storage-format	The default file format used when creating new tables</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RCBINARY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hive.force-local-scheduling</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>查询Hive表</strong></p>
</div>
<div class="paragraph">
<p>下表是Hive教程中的示例Hive表。可以使用以下Hive CREATE TABLE命令在Hive（不在Presto中）创建它：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>hive&gt; CREATE TABLE page_view (
    &gt;   viewTime INT,
    &gt;   userid BIGINT,
    &gt;   page_url STRING,
    &gt;   referrer_url STRING,
    &gt;   ip STRING COMMENT 'IP Address of the User')
    &gt; COMMENT 'This is the page view table'
    &gt; PARTITIONED BY (dt STRING, country STRING)
    &gt; STORED AS SEQUENCEFILE;
OK
Time taken: 3.644 seconds</pre>
</div>
</div>
<div class="paragraph">
<p>假设这个表是在Hive 的web模式中创建的，这个表可以在Presto描述：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>DESCRIBE hive.web.page_view;</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>    Column    |  Type   | Null | Partition Key |        Comment
--------------+---------+------+---------------+------------------------
 viewtime     | bigint  | true | false         |
 userid       | bigint  | true | false         |
 page_url     | varchar | true | false         |
 referrer_url | varchar | true | false         |
 ip           | varchar | true | false         | IP Address of the User
 dt           | varchar | true | true          |
 country      | varchar | true | true          |
(7 rows)</pre>
</div>
</div>
<div class="paragraph">
<p>然后可以在Presto中查询此表：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT * FROM hive.web.page_view;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jmx连接器">3.3. JMX连接器</h3>
<div class="paragraph">
<p>JMX连接器可以从Presto群集中的所有节点查询JMX信息。这对于监视或调试非常有用。Java管理扩展（JMX）提供有关Java虚拟机及其内部运行的所有软件的信息。Presto本身是通过JMX进行大量测试的。</p>
</div>
<div class="paragraph">
<p><strong>配置</strong></p>
</div>
<div class="paragraph">
<p>要配置JMX连接器，请创建目录属性文件 etc / catalog / jmx.properties，其中包含以下内容：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>connector.name = JMX</pre>
</div>
</div>
<div class="paragraph">
<p><strong>查询JMX</strong></p>
</div>
<div class="paragraph">
<p>JMX连接器提供了一个包含Presto集群中每个节点的Managed Bean（MBean）的单一架构jmx。您可以通过运行SHOW TABLES来查看所有可用的MBean ：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW TABLES FROM jmx.jmx;</pre>
</div>
</div>
<div class="paragraph">
<p>MBean名称映射到非标准表名称，并在引用查询时引用双引号。例如，以下查询显示每个节点的JVM版本：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT node, vmname, vmversion
FROM jmx.jmx."java.lang:type=runtime";</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>node                 |              vmname               | vmversion
--------------------------------------+-----------------------------------+-----------
ddc4df17-0b8e-4843-bb14-1b8af1a7451a | Java HotSpot(TM) 64-Bit Server VM | 24.60-b09
(1 row)</pre>
</div>
</div>
<div class="paragraph">
<p>以下查询显示每个节点的打开和最大文件描述符计数：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT openfiledescriptorcount, maxfiledescriptorcount
FROM jmx.jmx."java.lang:type=operatingsystem";</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>openfiledescriptorcount | maxfiledescriptorcount
-------------------------+------------------------
                    329 |                  10240
(1 row)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_kafka连接器">3.4. Kafka连接器</h3>
<div class="paragraph">
<p>该连接器允许在Presto中使用Apache Kafka主题作为表。每个消息都在Presto中作为一行显示。</p>
</div>
<div class="paragraph">
<p>主题可以是实时的：当数据到达时，行会随着数据段的删除而消失。如果在单个查询中多次访问相同的表（例如执行自身连接），这可能会导致奇怪的行为。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
支持Apache Kafka 0.8+，尽管它强烈建议使用0.8.1或更高版本。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>配置</strong></p>
</div>
<div class="paragraph">
<p>要配置Kafka连接器，请使用以下内容创建目录属性文件 etc / catalog / kafka.properties，并根据需要替换属性：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>connector.name=kafka
kafka.table-names=table1,table2
kafka.nodes=host1:port,host2:port</pre>
</div>
</div>
<div class="paragraph">
<p><strong>多个kafka群集</strong></p>
</div>
<div class="paragraph">
<p>您可以根据需要拥有尽可能多的目录，因此如果您还有其他Kafka群集，只需将其他属性文件添加到etc / catalog中， 并以不同的名称（确保以.properties结尾）。例如，如果您将属性文件命名为sales.properties，Presto将使用配置的连接器创建一个名为sales的目录。</p>
</div>
<div class="paragraph">
<p><strong>配置属性</strong></p>
</div>
<div class="paragraph">
<p>以下配置属性可用：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Property Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafka.table-names</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of all tables provided by the catalog</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafka.default-schema	Default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">schema name for tables</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafka.nodes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of nodes in the Kafka cluster</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafka.connect-timeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timeout for connecting to the Kafka cluster</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafka.buffer-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka read buffer size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafka.table-description-dir</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Directory containing topic description files</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">kafka.hide-internal-columns</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Controls whether internal columns are part of the table schema or not</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>kafka.table-names</strong></p>
</div>
<div class="paragraph">
<p>此目录提供的所有表的逗号分隔列表。表名称可以是不合格的（简单名称），并将被放入默认模式（见下文）或限定模式名称（&lt;schema-name&gt;。&lt;table-name&gt;）。</p>
</div>
<div class="paragraph">
<p>对于这里定义的每个表，可能存在表描述文件（见下文）。如果没有表描述文件存在，则表名用作Kafka上的主题名称，并且没有数据列映射到表中。该表仍将包含所有内部列（见下文）。</p>
</div>
<div class="paragraph">
<p>此属性是必需的; 没有默认值，必须至少定义一个表。</p>
</div>
<div class="paragraph">
<p><strong>kafka.default-schema</strong></p>
</div>
<div class="paragraph">
<p>定义将包含没有限定模式名称定义的所有表的模式。</p>
</div>
<div class="paragraph">
<p>此属性是可选的; 默认是default。</p>
</div>
<div class="paragraph">
<p><strong>kafka.nodes</strong></p>
</div>
<div class="paragraph">
<p>Kafka数据节点的主机名：端口对的逗号分隔列表。</p>
</div>
<div class="paragraph">
<p>此属性是必需的; 没有默认值，必须至少定义一个节点。</p>
</div>
<div class="paragraph">
<p>NOTE:
即使在此处仅指定了一个子集，Presto仍然可以连接到集群的所有节点，因为段文件可能仅位于特定节点上。</p>
</div>
<div class="paragraph">
<p><strong>kafka.connect-timeout</strong></p>
</div>
<div class="paragraph">
<p>连接到数据节点的超时。忙碌的卡夫卡群集可能需要相当长的时间才能接受连接; 当由于超时而看到失败的查询时，增加此值是一个很好的策略。</p>
</div>
<div class="paragraph">
<p>此属性是可选的; 默认值为10秒（10秒）。</p>
</div>
<div class="paragraph">
<p><strong>kafka.buffer-size</strong></p>
</div>
<div class="paragraph">
<p>用于从卡夫卡读取数据的内部数据缓冲区的大小。数据缓冲区必须能够保存至少一个消息，理想情况下可以容纳许多消息。每个工作者和数据节点分配一个数据缓冲区。</p>
</div>
<div class="paragraph">
<p>此属性是可选的; 默认为64kb。</p>
</div>
<div class="paragraph">
<p><strong>kafka.table-description-dir</strong></p>
</div>
<div class="paragraph">
<p>引用Presto部署中的一个文件夹，其中包含一个或多个包含表描述文件的JSON文件（必须以.json结尾）。</p>
</div>
<div class="paragraph">
<p>此属性是可选的; 默认是etc / kafka。</p>
</div>
<div class="paragraph">
<p><strong>kafka.hide-internal-columns</strong></p>
</div>
<div class="paragraph">
<p>除了表描述文件中定义的数据列之外，连接器还为每个表维护了一些附加列。如果这些列被隐藏，它们仍然可以在查询中使用，但不会显示在DESCRIBE &lt;table-name&gt;或SELECT *中。</p>
</div>
<div class="paragraph">
<p>此属性是可选的; 默认为true。</p>
</div>
<div class="paragraph">
<p><strong>Internal Columns</strong></p>
</div>
<div class="paragraph">
<p>对于每个定义的表，连接器维护以下列：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Column name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_partition_id</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIGINT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID of the Kafka partition which contains this row.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_partition_offset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIGINT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Offset within the Kafka partition for this row.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_segment_start</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIGINT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lowest offset in the segment (inclusive) which contains this row. This offset is partition specific.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_segment_end</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIGINT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Highest offset in the segment (exclusive) which contains this row. The offset is partition specific. This is the same value as _segment_start of the next segment (if it exists).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_segment_count</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIGINT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Running count of for the current row within the segment. For an uncompacted topic, _segment_start + _segment_count is equal to _partition_offset.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_message_corrupt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BOOLEAN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if the decoder could not decode the message for this row. When true, data columns mapped from the message should be treated as invalid.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">_message	VARCHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message bytes as an UTF-8 encoded string. This is only useful for a text topic.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_message_length</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIGINT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Number of bytes in the message.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_key_corrupt</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BOOLEAN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if the key decode could not decode the key for this row. When true, data columns mapped from the key should be treated as invalid.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_key</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARCHAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key bytes as an UTF-8 encoded string. This is only useful for textual keys.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">_key_length</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>对于没有表定义文件的表，_key_corrupt和 _message_corrupt列将始终为false。</p>
</div>
<div class="paragraph">
<p><strong>Table Definition Files</strong></p>
</div>
<div class="paragraph">
<p>Kafka仅将主题维护为字节消息，并将其留给生产者和消费者来定义消息应如何解释。对于Presto，此数据必须映射到列以允许对数据进行查询。</p>
</div>
<div class="paragraph">
<p>NOTE:
对于包含JSON数据的文本主题，完全可以不使用任何表定义文件，而是使用Presto JSON函数来解析包含映射到UTF-8字符串的字节的_message列。然而，这是非常麻烦的，使得编写SQL查询变得困难。</p>
</div>
<div class="paragraph">
<p>表定义文件由表的JSON定义组成。该文件的名称可以是任意的，但必须以.json结尾。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "tableName": ...,
    "schemaName": ...,
    "topicName": ...,
    "key": {
        "dataFormat": ...,
        "fields": [
            ...
        ]
    },
    "message": {
        "dataFormat": ...,
        "fields": [
            ...
       ]
    }
}</pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tableName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Presto table name defined by this file.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">schemaName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Schema which will contain the table. If omitted, the default schema name is used.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">topicName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kafka topic that is mapped.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">key</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field definitions for data columns mapped to the message key.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON object</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field definitions for data columns mapped to the message itself.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Key and Message in Kafka</strong></p>
</div>
<div class="paragraph">
<p>从Kafka 0.8开始，主题中的每个消息都可以有一个可选的键。表定义文件包含键和消息的部分，用于将数据映射到表列。</p>
</div>
<div class="paragraph">
<p>表定义中的每个键和消息字段都是必须包含两个字段的JSON对象：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dataFormat</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selects the decoder for this group of fields.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">fields</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of field definitions. Each field definition creates a new column in the Presto table.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>每个字段定义都是一个JSON对象：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "name": ...,
    "type": ...,
    "dataFormat": ...,
    "mapping": ...,
    "formatHint": ...,
    "hidden": ...,
    "comment": ...
}</pre>
</div>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the column in the Presto table.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">required</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Presto type of the column.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dataFormat</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Selects the column decoder for this field. Default to the default decoder for this row data format and column type.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mapping</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapping information for the column. This is decoder specific, see below.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">formatHint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets a column specifc format hint to the column decoder.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hidden</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hides the column from DESCRIBE &lt;table name&gt; and SELECT *. Defaults to false.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">comment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">optional</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">string</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add a column comment which is shown with DESCRIBE &lt;table name&gt;.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>密钥或消息的字段描述没有限制。</p>
</div>
<div class="paragraph">
<p><strong>Row Decoding</strong></p>
</div>
<div class="paragraph">
<p>对于密钥和消息，解码器用于将数据映射到列。如果表中没有表定义文件，则使用虚拟解码器。</p>
</div>
<div class="paragraph">
<p>Kafka连接器包含以下解码器：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>raw - 不转换行数据，用作原始字节</p>
</li>
<li>
<p>csv - 将值解释为CSV</p>
</li>
<li>
<p>json - 将值转换为JSON对象</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>解码器的主要目的是选择适当的字段解码器来解释消息或密钥数据。</p>
</div>
<div class="paragraph">
<p>Presto仅支持Presto类型映射的四种物理数据类型：布尔型，长型和双列类型，并将其视为字符串。</p>
</div>
<div class="paragraph">
<p><strong>raw Decoder</strong></p>
</div>
<div class="paragraph">
<p>原始解码器支持从消息或密钥读取原始（基于字节）的值，并将其转换为Presto列。</p>
</div>
<div class="paragraph">
<p>对于字段，支持以下属性：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>type - 支持所有Presto数据类型</p>
</li>
<li>
<p>dataFormat - 仅支持 _default，可以省略。</p>
</li>
<li>
<p>mapping - 选择转换的数据类型的宽度</p>
</li>
<li>
<p>formatHint - 可选， &lt;start&gt; [：&lt;end&gt;] ; 要转换字节的开始和结束位置</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>所述映射列选择转换的字节数。如果不存在，则假定BYTE。所有值都已标记。</p>
</div>
<div class="paragraph">
<p>支持的值有：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>BYTE - 一个字节</p>
</li>
<li>
<p>SHORT - 两个字节</p>
</li>
<li>
<p>INT - 四个字节</p>
</li>
<li>
<p>LONG - 八字节</p>
</li>
<li>
<p>FLOAT - 四字节（IEEE 754格式）</p>
</li>
<li>
<p>DOUBLE - 八个字节（IEEE 754格式）</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>type的列定义在其上的值被映射到的的Presto数据类型。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>基于布尔的类型需要映射到BYTE，SHORT，INT或LONG。任何其他类型将抛出转换错误。值为0返回false，其他都为true。</p>
</li>
<li>
<p>长基类型需要映射到BYTE，SHORT，INT或LONG。任何其他类型将抛出转换错误。</p>
</li>
<li>
<p>双基类型需要映射到FLOAT或DOUBLE。任何其他类型将抛出转换错误。</p>
</li>
<li>
<p>基于字符串的类型需要映射到BYTE。任何其他类型将抛出转换错误。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>所述formatHint字段指定的字节中的一个关键或消息的位置。它可以是一个或两个由冒号分隔的数字（&lt;start&gt; [：&lt;end&gt;]）。如果只给出一个起始位置，列将使用适当数量的字节（见上文）。基于字符串的类型（VARCHAR）将使用所有字节到消息的结尾。如果给定了起始和终点位置，则对于固定类型，大小必须至少为类型的大小。对于基于字符串的类型，使用start（包括）和end（exclusive）之间的所有字节。</p>
</div>
<div class="paragraph">
<p><strong>csv Decoder</strong></p>
</div>
<div class="paragraph">
<p>NOTE:
CSV解码器具有beta质量，应谨慎使用。</p>
</div>
<div class="paragraph">
<p>CSV解码器使用UTF-8编码将表示消息或键的字节转换为字符串，然后将结果解释为CSV（逗号分隔值）行。</p>
</div>
<div class="paragraph">
<p>对于字段，支持以下属性：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>type - 支持所有Presto数据类型</p>
</li>
<li>
<p>dataFormat - 仅支持 _default，可以省略</p>
</li>
<li>
<p>mapping - 用于列的字段索引。必须给予</p>
</li>
<li>
<p>formatHint - 不支持，被忽略</p>
</li>
<li>
<p>如果字段值为字符串“true”（不区分大小写），则基于布尔类型的返回true，否则返回false。</p>
</li>
<li>
<p>根据Java long和double解析规则，长和双基类型分析字段值。</p>
</li>
<li>
<p>字符串类型使用现场（使用UTF-8编码的文本）</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>json Decoder</strong></p>
</div>
<div class="paragraph">
<p>JSON解码器将表示消息或密钥的字节转换为JSON RFC 4627。请注意，消息或键必须转换为JSON对象，而不是数组或简单类型。</p>
</div>
<div class="paragraph">
<p>对于字段，支持以下属性：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>type - 支持所有Presto数据类型</p>
</li>
<li>
<p>dataFormat - _default, custom-date-time, iso8601, rfc2822, milliseconds-since-epoch, seconds-since-epoch. If missing, _default is used.</p>
</li>
<li>
<p>mapping - 用于从JSON对象中选择字段的字段名称的斜杠分隔列表。</p>
</li>
<li>
<p>formatHint - 仅适用于自定义日期时间，请参见下文。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>JSON解码器支持多个字段解码器，_default用于标准表列和多个基于日期和时间的类型的解码器。</p>
</div>
<div class="paragraph">
<p><strong>_default Field decoder</strong></p>
</div>
<div class="paragraph">
<p>这是支持所有Presto物理数据类型的标准字段解码器。字段值将被JSON转换规则强制为布尔值，长整数，双精度值或字符串值。对于非日期/时间的列，应使用该解码器。</p>
</div>
<div class="paragraph">
<p><strong>Date and Time Decoders</strong></p>
</div>
<div class="paragraph">
<p>要将值从JSON对象转换为Presto DATE，TIME或 TIMESTAMP列，可以使用字段定义的dataFormat属性来选择特殊解码器 。</p>
</div>
<div class="paragraph">
<p><strong>Text Decoders</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>iso8601 - 基于文本，将文本字段解析为ISO 8601时间戳。</p>
</li>
<li>
<p>rfc2822 - 基于文本，解析为一个文本字段RFC 2822时间戳。</p>
</li>
<li>
<p>custom-date-time - 基于文本，需要格式化提示，将其解析为Joda-Time格式化字符串。</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Presto Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON Long</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">string type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">as-is</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">parse according to format type, return millis since epoch</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">long-based</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">type	parse according to format type, return millis since epoch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">return as millis since epoch</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>Number Decoders</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>milliseconds-since-epoch -基于数字，解释一个文本或编号作为从epoch毫秒数。</p>
</li>
<li>
<p>seconds-since-epoch -将文本或数字解释为自时代以来的毫秒数。</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Presto Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON Long</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">string type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">parse as long, format as ISO8601</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">format as ISO8601</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">long-based type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">parse as long, return millis since epoch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">return millis since epoch</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_kafka连接器教程">3.5. Kafka连接器教程</h3>
<div class="paragraph">
<p><strong>介绍</strong></p>
</div>
<div class="paragraph">
<p>Presto的Kafka Connector可以使用Presto访问Apache Kafka的实时主题数据。本教程将介绍如何设置主题以及如何创建返回Presto表的主题描述文件。</p>
</div>
<div class="paragraph">
<p><strong>安装</strong></p>
</div>
<div class="paragraph">
<p>本教程假定您熟悉Presto和本地Presto安装（参见部署Presto）。它将专注于设置Apache Kafka并将其与Presto进行集成。</p>
</div>
<div class="paragraph">
<p>步骤1：安装Apache Kafka</p>
</div>
<div class="paragraph">
<p>下载并解压缩Apache Kafka。</p>
</div>
<div class="paragraph">
<p>NOTE:
本教程使用Apache Kafka 0.8.1进行了测试。它应该适用于任何0.8.x版本的Apache Kafka。</p>
</div>
<div class="paragraph">
<p>启动ZooKeeper和Kafka服务器：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bin/zookeeper-server-start.sh config/zookeeper.properties
[2013-04-22 15:01:37,495] INFO Reading configuration from: config/zookeeper.properties (org.apache.zookeeper.server.quorum.QuorumPeerConfig)
...</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bin/kafka-server-start.sh config/server.properties
[2013-04-22 15:01:47,028] INFO Verifying properties (kafka.utils.VerifiableProperties)
[2013-04-22 15:01:47,051] INFO Property socket.send.buffer.bytes is overridden to 1048576 (kafka.utils.VerifiableProperties)
...</pre>
</div>
</div>
<div class="paragraph">
<p>这将启动端口2181上的Zookeeper 和9092端口的Kafka 。</p>
</div>
<div class="paragraph">
<p>步骤2：加载数据</p>
</div>
<div class="paragraph">
<p>从Maven中心下载tpch-kafka loader：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ curl -o kafka-tpch https://repo1.maven.org/maven2/de/softwareforge/kafka_tpch_0811/1.0/kafka_tpch_0811-1.0.sh
$ chmod 755 kafka-tpch</pre>
</div>
</div>
<div class="paragraph">
<p>现在运行kafka-tpch程序，用tpch数据预先加载一些主题：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./kafka-tpch load --brokers localhost:9092 --prefix tpch. --tpch-type tiny
2014-07-28T17:17:07.594-0700     INFO    main    io.airlift.log.Logging    Logging to stderr
2014-07-28T17:17:07.623-0700     INFO    main    de.softwareforge.kafka.LoadCommand    Processing tables: [customer, orders, lineitem, part, partsupp, supplier, nation, region]
2014-07-28T17:17:07.981-0700     INFO    pool-1-thread-1    de.softwareforge.kafka.LoadCommand    Loading table 'customer' into topic 'tpch.customer'...
2014-07-28T17:17:07.981-0700     INFO    pool-1-thread-2    de.softwareforge.kafka.LoadCommand    Loading table 'orders' into topic 'tpch.orders'...
2014-07-28T17:17:07.981-0700     INFO    pool-1-thread-3    de.softwareforge.kafka.LoadCommand    Loading table 'lineitem' into topic 'tpch.lineitem'...
2014-07-28T17:17:07.982-0700     INFO    pool-1-thread-4    de.softwareforge.kafka.LoadCommand    Loading table 'part' into topic 'tpch.part'...
2014-07-28T17:17:07.982-0700     INFO    pool-1-thread-5    de.softwareforge.kafka.LoadCommand    Loading table 'partsupp' into topic 'tpch.partsupp'...
2014-07-28T17:17:07.982-0700     INFO    pool-1-thread-6    de.softwareforge.kafka.LoadCommand    Loading table 'supplier' into topic 'tpch.supplier'...
2014-07-28T17:17:07.982-0700     INFO    pool-1-thread-7    de.softwareforge.kafka.LoadCommand    Loading table 'nation' into topic 'tpch.nation'...
2014-07-28T17:17:07.982-0700     INFO    pool-1-thread-8    de.softwareforge.kafka.LoadCommand    Loading table 'region' into topic 'tpch.region'...
2014-07-28T17:17:10.612-0700    ERROR    pool-1-thread-8    kafka.producer.async.DefaultEventHandler    Failed to collate messages by topic, partition due to: Failed to fetch topic metadata for topic: tpch.region
2014-07-28T17:17:10.781-0700     INFO    pool-1-thread-8    de.softwareforge.kafka.LoadCommand    Generated 5 rows for table 'region'.
2014-07-28T17:17:10.797-0700    ERROR    pool-1-thread-3    kafka.producer.async.DefaultEventHandler    Failed to collate messages by topic, partition due to: Failed to fetch topic metadata for topic: tpch.lineitem
2014-07-28T17:17:10.932-0700    ERROR    pool-1-thread-1    kafka.producer.async.DefaultEventHandler    Failed to collate messages by topic, partition due to: Failed to fetch topic metadata for topic: tpch.customer
2014-07-28T17:17:11.068-0700    ERROR    pool-1-thread-2    kafka.producer.async.DefaultEventHandler    Failed to collate messages by topic, partition due to: Failed to fetch topic metadata for topic: tpch.orders
2014-07-28T17:17:11.200-0700    ERROR    pool-1-thread-6    kafka.producer.async.DefaultEventHandler    Failed to collate messages by topic, partition due to: Failed to fetch topic metadata for topic: tpch.supplier
2014-07-28T17:17:11.319-0700     INFO    pool-1-thread-6    de.softwareforge.kafka.LoadCommand    Generated 100 rows for table 'supplier'.
2014-07-28T17:17:11.333-0700    ERROR    pool-1-thread-4    kafka.producer.async.DefaultEventHandler    Failed to collate messages by topic, partition due to: Failed to fetch topic metadata for topic: tpch.part
2014-07-28T17:17:11.466-0700    ERROR    pool-1-thread-5    kafka.producer.async.DefaultEventHandler    Failed to collate messages by topic, partition due to: Failed to fetch topic metadata for topic: tpch.partsupp
2014-07-28T17:17:11.597-0700    ERROR    pool-1-thread-7    kafka.producer.async.DefaultEventHandler    Failed to collate messages by topic, partition due to: Failed to fetch topic metadata for topic: tpch.nation
2014-07-28T17:17:11.706-0700     INFO    pool-1-thread-7    de.softwareforge.kafka.LoadCommand    Generated 25 rows for table 'nation'.
2014-07-28T17:17:12.180-0700     INFO    pool-1-thread-1    de.softwareforge.kafka.LoadCommand    Generated 1500 rows for table 'customer'.
2014-07-28T17:17:12.251-0700     INFO    pool-1-thread-4    de.softwareforge.kafka.LoadCommand    Generated 2000 rows for table 'part'.
2014-07-28T17:17:12.905-0700     INFO    pool-1-thread-2    de.softwareforge.kafka.LoadCommand    Generated 15000 rows for table 'orders'.
2014-07-28T17:17:12.919-0700     INFO    pool-1-thread-5    de.softwareforge.kafka.LoadCommand    Generated 8000 rows for table 'partsupp'.
2014-07-28T17:17:13.877-0700     INFO    pool-1-thread-3    de.softwareforge.kafka.LoadCommand    Generated 60175 rows for table 'lineitem'.</pre>
</div>
</div>
<div class="paragraph">
<p>卡夫卡现在有一些预先加载数据的主题可以查询。</p>
</div>
<div class="paragraph">
<p>步骤3：使Presto知道Kafka主题</p>
</div>
<div class="paragraph">
<p>在您的Presto安装中，为Kafka连接器添加目录属性文件 etc / catalog / kafka.properties。此文件列出了Kafka节点和主题：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>connector.name=kafka
kafka.nodes=localhost:9092
kafka.table-names=tpch.customer,tpch.orders,tpch.lineitem,tpch.part,tpch.partsupp,tpch.supplier,tpch.nation,tpch.region
kafka.hide-internal-columns-hidden=false</pre>
</div>
</div>
<div class="paragraph">
<p>现在开始Presto：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ bin/launcher start</pre>
</div>
</div>
<div class="paragraph">
<p>因为卡夫卡桌子上都有tpch。前缀在配置中，表格在tpch模式中。连接器已安装到 kafka目录中，因为属性文件名为kafka.properties。</p>
</div>
<div class="paragraph">
<p>启动Presto CLI：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./presto --catalog kafka --schema tpch</pre>
</div>
</div>
<div class="paragraph">
<p>列出表以验证事情是否正常：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>presto:tpch&gt; SHOW TABLES;
  Table
----------
 customer
 lineitem
 nation
 orders
 part
 partsupp
 region
 supplier
(8 rows)</pre>
</div>
</div>
<div class="paragraph">
<p>步骤4：基本数据查询</p>
</div>
<div class="paragraph">
<p>Kafka数据是非结构化的，它没有元数据来描述消息的格式。没有进一步的配置，Kafka连接器可以访问数据并以原始形式映射，但除了内置的数据之外，没有实际的列：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>presto:tpch&gt; DESCRIBE customer;
      Column       |  Type   | Null | Partition Key |                   Comment
-------------------+---------+------+---------------+---------------------------------------------
 _partition_id     | bigint  | true | false         | Partition Id
 _partition_offset | bigint  | true | false         | Offset for the message within the partition
 _segment_start    | bigint  | true | false         | Segment start offset
 _segment_end      | bigint  | true | false         | Segment end offset
 _segment_count    | bigint  | true | false         | Running message count per segment
 _key              | varchar | true | false         | Key text
 _key_corrupt      | boolean | true | false         | Key data is corrupt
 _key_length       | bigint  | true | false         | Total number of key bytes
 _message          | varchar | true | false         | Message text
 _message_corrupt  | boolean | true | false         | Message data is corrupt
 _message_length   | bigint  | true | false         | Total number of message bytes
(11 rows)

presto:tpch&gt; SELECT count(*) FROM customer;
 _col0
-------
  1500

presto:tpch&gt; SELECT _message FROM customer LIMIT 5;
                                                                                                                                                 _message
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 {"rowNumber":1,"customerKey":1,"name":"Customer#000000001","address":"IVhzIApeRb ot,c,E","nationKey":15,"phone":"25-989-741-2988","accountBalance":711.56,"marketSegment":"BUILDING","comment":"to the even, regular platelets. regular, ironic epitaphs nag e"}
 {"rowNumber":3,"customerKey":3,"name":"Customer#000000003","address":"MG9kdTD2WBHm","nationKey":1,"phone":"11-719-748-3364","accountBalance":7498.12,"marketSegment":"AUTOMOBILE","comment":" deposits eat slyly ironic, even instructions. express foxes detect slyly. blithel
 {"rowNumber":5,"customerKey":5,"name":"Customer#000000005","address":"KvpyuHCplrB84WgAiGV6sYpZq7Tj","nationKey":3,"phone":"13-750-942-6364","accountBalance":794.47,"marketSegment":"HOUSEHOLD","comment":"n accounts will have to unwind. foxes cajole accor"}
 {"rowNumber":7,"customerKey":7,"name":"Customer#000000007","address":"TcGe5gaZNgVePxU5kRrvXBfkasDTea","nationKey":18,"phone":"28-190-982-9759","accountBalance":9561.95,"marketSegment":"AUTOMOBILE","comment":"ainst the ironic, express theodolites. express, even pinto bean
 {"rowNumber":9,"customerKey":9,"name":"Customer#000000009","address":"xKiAFTjUsCuxfeleNqefumTrjS","nationKey":8,"phone":"18-338-906-3675","accountBalance":8324.07,"marketSegment":"FURNITURE","comment":"r theodolites according to the requests wake thinly excuses: pending
(5 rows)

presto:tpch&gt; SELECT sum(cast(json_extract_scalar(_message, '$.accountBalance') AS double)) FROM customer LIMIT 10;
   _col0
------------
 6681865.59
(1 row)
presto：tpch&gt; SELECT sum（cast（json_extract_scalar（_message，'$ .accountBalance'）AS double））FROM customer LIMIT 10;
   _col0
------------
 6681865.59
（1排）</pre>
</div>
</div>
<div class="paragraph">
<p>来自Kafka的数据可以使用Presto进行查询，但是还没有实际的表格形状。原始数据可通过_message和 _key列获得，但不会被解码成列。由于样本数据采用JSON格式，Presto内置的JSON函数可用于分割数据。</p>
</div>
<div class="paragraph">
<p>步骤5：添加主题描述文件</p>
</div>
<div class="paragraph">
<p>Kafka连接器支持主题描述文件将原始数据转换成表格式。这些文件位于Presto安装中的etc / kafka文件夹中，必须以.json结尾。建议文件名与表名匹配，但这不是必需的。</p>
</div>
<div class="paragraph">
<p>将以下文件添加为etc / kafka / tpch.customer.json并重新启动Presto：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "tableName": "customer",
    "schemaName": "tpch",
    "topicName": "tpch.customer",
    "key": {
        "dataFormat": "raw",
        "fields": [
            {
                "name": "kafka_key",
                "dataFormat": "LONG",
                "type": "BIGINT",
                "hidden": "false"
            }
        ]
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>客户表现在有一个附加列：kafka_key。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>presto:tpch&gt; DESCRIBE customer;
      Column       |  Type   | Null | Partition Key |                   Comment
-------------------+---------+------+---------------+---------------------------------------------
 kafka_key         | bigint  | true | false         |
 _partition_id     | bigint  | true | false         | Partition Id
 _partition_offset | bigint  | true | false         | Offset for the message within the partition
 _segment_start    | bigint  | true | false         | Segment start offset
 _segment_end      | bigint  | true | false         | Segment end offset
 _segment_count    | bigint  | true | false         | Running message count per segment
 _key              | varchar | true | false         | Key text
 _key_corrupt      | boolean | true | false         | Key data is corrupt
 _key_length       | bigint  | true | false         | Total number of key bytes
 _message          | varchar | true | false         | Message text
 _message_corrupt  | boolean | true | false         | Message data is corrupt
 _message_length   | bigint  | true | false         | Total number of message bytes
(12 rows)

presto:tpch&gt; SELECT kafka_key FROM customer ORDER BY kafka_key LIMIT 10;
 kafka_key
-----------
         0
         1
         2
         3
         4
         5
         6
         7
         8
         9
(10 rows)</pre>
</div>
</div>
<div class="paragraph">
<p>主题定义文件将内部Kafka密钥（其为8个字节的原始长度）映射到Presto BIGINT列。</p>
</div>
<div class="paragraph">
<p>步骤6：将主题消息中的所有值映射到列</p>
</div>
<div class="paragraph">
<p>更新etc / kafka / tpch.customer.json文件以添加消息的字段并重新启动Presto。消息中的字段是JSON，它使用json数据格式。这是一个示例，其中使用不同的数据格式的密钥和消息。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "tableName": "customer",
    "schemaName": "tpch",
    "topicName": "tpch.customer",
    "key": {
        "dataFormat": "raw",
        "fields": [
            {
                "name": "kafka_key",
                "dataFormat": "LONG",
                "type": "BIGINT",
                "hidden": "false"
            }
        ]
    },
    "message": {
        "dataFormat": "json",
        "fields": [
            {
                "name": "row_number",
                "mapping": "rowNumber",
                "type": "BIGINT"
            },
            {
                "name": "customer_key",
                "mapping": "customerKey",
                "type": "BIGINT"
            },
            {
                "name": "name",
                "mapping": "name",
                "type": "VARCHAR"
            },
            {
                "name": "address",
                "mapping": "address",
                "type": "VARCHAR"
            },
            {
                "name": "nation_key",
                "mapping": "nationKey",
                "type": "BIGINT"
            },
            {
                "name": "phone",
                "mapping": "phone",
                "type": "VARCHAR"
            },
            {
                "name": "account_balance",
                "mapping": "accountBalance",
                "type": "DOUBLE"
            },
            {
                "name": "market_segment",
                "mapping": "marketSegment",
                "type": "VARCHAR"
            },
            {
                "name": "comment",
                "mapping": "comment",
                "type": "VARCHAR"
            }
        ]
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>现在对于消息的JSON中的所有字段，定义了列，并且前面的和查询可以直接在account_balance列上运行：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>presto:tpch&gt; DESCRIBE customer;
      Column       |  Type   | Null | Partition Key |                   Comment
-------------------+---------+------+---------------+---------------------------------------------
 kafka_key         | bigint  | true | false         |
 row_number        | bigint  | true | false         |
 customer_key      | bigint  | true | false         |
 name              | varchar | true | false         |
 address           | varchar | true | false         |
 nation_key        | bigint  | true | false         |
 phone             | varchar | true | false         |
 account_balance   | double  | true | false         |
 market_segment    | varchar | true | false         |
 comment           | varchar | true | false         |
 _partition_id     | bigint  | true | false         | Partition Id
 _partition_offset | bigint  | true | false         | Offset for the message within the partition
 _segment_start    | bigint  | true | false         | Segment start offset
 _segment_end      | bigint  | true | false         | Segment end offset
 _segment_count    | bigint  | true | false         | Running message count per segment
 _key              | varchar | true | false         | Key text
 _key_corrupt      | boolean | true | false         | Key data is corrupt
 _key_length       | bigint  | true | false         | Total number of key bytes
 _message          | varchar | true | false         | Message text
 _message_corrupt  | boolean | true | false         | Message data is corrupt
 _message_length   | bigint  | true | false         | Total number of message bytes
(21 rows)

presto:tpch&gt; SELECT * FROM customer LIMIT 5;
 kafka_key | row_number | customer_key |        name        |                address                | nation_key |      phone      | account_balance | market_segment |                                                      comment
-----------+------------+--------------+--------------------+---------------------------------------+------------+-----------------+-----------------+----------------+---------------------------------------------------------------------------------------------------------
         1 |          2 |            2 | Customer#000000002 | XSTf4,NCwDVaWNe6tEgvwfmRchLXak        |         13 | 23-768-687-3665 |          121.65 | AUTOMOBILE     | l accounts. blithely ironic theodolites integrate boldly: caref
         3 |          4 |            4 | Customer#000000004 | XxVSJsLAGtn                           |          4 | 14-128-190-5944 |         2866.83 | MACHINERY      |  requests. final, regular ideas sleep final accou
         5 |          6 |            6 | Customer#000000006 | sKZz0CsnMD7mp4Xd0YrBvx,LREYKUWAh yVn  |         20 | 30-114-968-4951 |         7638.57 | AUTOMOBILE     | tions. even deposits boost according to the slyly bold packages. final accounts cajole requests. furious
         7 |          8 |            8 | Customer#000000008 | I0B10bB0AymmC, 0PrRYBCP1yGJ8xcBPmWhl5 |         17 | 27-147-574-9335 |         6819.74 | BUILDING       | among the slyly regular theodolites kindle blithely courts. carefully even theodolites haggle slyly alon
         9 |         10 |           10 | Customer#000000010 | 6LrEaV6KR6PLVcgl2ArL Q3rqzLzcT1 v2    |          5 | 15-741-346-9870 |         2753.54 | HOUSEHOLD      | es regular deposits haggle. fur
(5 rows)

presto:tpch&gt; SELECT sum(account_balance) FROM customer LIMIT 10;
   _col0
------------
 6681865.59
(1 row)</pre>
</div>
</div>
<div class="paragraph">
<p>现在，客户主题消息中的所有字段都可用作Presto表列。</p>
</div>
<div class="paragraph">
<p>步骤7：使用实时数据</p>
</div>
<div class="paragraph">
<p>Presto可以在Kafka到达时查询实时数据。为了模拟数据的实时数据，本教程将向Kafka提供实时推文。</p>
</div>
<div class="paragraph">
<p>设置一个现场Twitter Feed</p>
</div>
<div class="ulist">
<ul>
<li>
<p>下载扭曲工具</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ curl -o twistr https://repo1.maven.org/maven2/de/softwareforge/twistr_kafka_0811/1.2/twistr_kafka_0811-1.2.sh
$ chmod 755 twistr</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>在https://dev.twitter.com/创建开发者帐户，并设置访问和消费者令牌。</p>
</li>
<li>
<p>创建一个twistr.properties文件，并将访问和消费者密钥和秘密放入其中：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>twistr.access-token-key=...
twistr.access-token-secret=...
twistr.consumer-key=...
twistr.consumer-secret=...
twistr.kafka.brokers=localhost:9092</pre>
</div>
</div>
<div class="paragraph">
<p><strong>在Presto上创建一个tweets表</strong></p>
</div>
<div class="paragraph">
<p>将tweets表添加到etc / catalog / kafka.properties文件中：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>connector.name=kafka
kafka.nodes=localhost:9092
kafka.table-names=tpch.customer,tpch.orders,tpch.lineitem,tpch.part,tpch.partsupp,tpch.supplier,tpch.nation,tpch.region,tweets
kafka.hide-internal-columns=false</pre>
</div>
</div>
<div class="paragraph">
<p>为Twitter feed添加主题定义文件等等/ kafka / tweets.json：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
    "tableName": "tweets",
    "topicName": "twitter_feed",
    "dataFormat": "json",
    "key": {
        "dataFormat": "raw",
        "fields": [
            {
                "name": "kafka_key",
                "dataFormat": "LONG",
                "type": "BIGINT",
                "hidden": "false"
            }
        ]
    },
    "message": {
        "dataFormat":"json",
        "fields": [
            {
                "name": "text",
                "mapping": "text",
                "type": "VARCHAR"
            },
            {
                "name": "user_name",
                "mapping": "user/screen_name",
                "type": "VARCHAR"
            },
            {
                "name": "lang",
                "mapping": "lang",
                "type": "VARCHAR"
            },
            {
                "name": "created_at",
                "mapping": "created_at",
                "type": "TIMESTAMP",
                "dataFormat": "rfc2822"
            },
            {
                "name": "favorite_count",
                "mapping": "favorite_count",
                "type": "BIGINT"
            },
            {
                "name": "retweet_count",
                "mapping": "retweet_count",
                "type": "BIGINT"
            },
            {
                "name": "favorited",
                "mapping": "favorited",
                    "type": "BOOLEAN"
            },
            {
                "name": "id",
                "mapping": "id_str",
                "type": "VARCHAR"
            },
            {
                "name": "in_reply_to_screen_name",
                "mapping": "in_reply_to_screen_name",
                "type": "VARCHAR"
            },
            {
                "name": "place_name",
                "mapping": "place/full_name",
                "type": "VARCHAR"
            }
        ]
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>由于此表没有显式的模式名称，它将被放置到默认模式中。</p>
</div>
<div class="paragraph">
<p><strong>提供实时数据</strong></p>
</div>
<div class="paragraph">
<p>启动扭曲工具：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ java -Dness.config.location=file:$(pwd) -Dness.config=twistr -jar ./twistr</pre>
</div>
</div>
<div class="paragraph">
<p>扭曲器连接到Twitter API，并将“示例推文”馈送到名为 twitter_feed的Kafka主题。</p>
</div>
<div class="paragraph">
<p>现在可以对实时数据进行查询：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ ./presto-cli --catalog kafka --schema default

presto:default&gt; SELECT count(*) FROM tweets;
 _col0
-------
  4467
(1 row)

presto:default&gt; SELECT count(*) FROM tweets;
 _col0
-------
  4517
(1 row)

presto:default&gt; SELECT count(*) FROM tweets;
 _col0
-------
  4572
(1 row)

presto:default&gt; SELECT kafka_key, user_name, lang, created_at FROM tweets LIMIT 10;
     kafka_key      |    user_name    | lang |       created_at
--------------------+-----------------+------+-------------------------
 494227746231685121 | burncaniff      | en   | 2014-07-29 14:07:31.000
 494227746214535169 | gu8tn           | ja   | 2014-07-29 14:07:31.000
 494227746219126785 | pequitamedicen  | es   | 2014-07-29 14:07:31.000
 494227746201931777 | josnyS          | ht   | 2014-07-29 14:07:31.000
 494227746219110401 | Cafe510         | en   | 2014-07-29 14:07:31.000
 494227746210332673 | Da_JuanAnd_Only | en   | 2014-07-29 14:07:31.000
 494227746193956865 | Smile_Kidrauhl6 | pt   | 2014-07-29 14:07:31.000
 494227750426017793 | CashforeverCD   | en   | 2014-07-29 14:07:32.000
 494227750396653569 | FilmArsivimiz   | tr   | 2014-07-29 14:07:32.000
 494227750388256769 | jmolas          | es   | 2014-07-29 14:07:32.000
(10 rows)</pre>
</div>
</div>
<div class="paragraph">
<p>现在有一个可以使用Presto查询的卡夫卡的现场饲料。</p>
</div>
<div class="paragraph">
<p><strong>Epilogue: Time stamps</strong></p>
</div>
<div class="paragraph">
<p>在最后一步中设置的tweets feed在RFC 2822格式中包含每个tweet中的created_at属性的时间戳。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>presto:default&gt; SELECT DISTINCT json_extract_scalar(_message, '$.created_at')) AS raw_date
             -&gt; FROM tweets LIMIT 5;
            raw_date
--------------------------------
 Tue Jul 29 21:07:31 +0000 2014
 Tue Jul 29 21:07:32 +0000 2014
 Tue Jul 29 21:07:33 +0000 2014
 Tue Jul 29 21:07:34 +0000 2014
 Tue Jul 29 21:07:35 +0000 2014
(5 rows)</pre>
</div>
</div>
<div class="paragraph">
<p>tweets表的主题定义文件包含使用rfc2822转换器到时间戳的映射：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>...
{
    "name": "created_at",
    "mapping": "created_at",
    "type": "TIMESTAMP",
    "dataFormat": "rfc2822"
},
...</pre>
</div>
</div>
<div class="paragraph">
<p>这允许将原始数据映射到Presto时间戳列：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>presto:default&gt; SELECT created_at, raw_date FROM (
             -&gt;   SELECT created_at, json_extract_scalar(_message, '$.created_at') AS raw_date
             -&gt;   FROM tweets)
             -&gt; GROUP BY 1, 2 LIMIT 5;
       created_at        |            raw_date
-------------------------+--------------------------------
 2014-07-29 14:07:20.000 | Tue Jul 29 21:07:20 +0000 2014
 2014-07-29 14:07:21.000 | Tue Jul 29 21:07:21 +0000 2014
 2014-07-29 14:07:22.000 | Tue Jul 29 21:07:22 +0000 2014
 2014-07-29 14:07:23.000 | Tue Jul 29 21:07:23 +0000 2014
 2014-07-29 14:07:24.000 | Tue Jul 29 21:07:24 +0000 2014
(5 rows)</pre>
</div>
</div>
<div class="paragraph">
<p>Kafka连接器包含用于ISO 8601，RFC 2822文本格式的转换器，以及从时代开始使用秒或毫秒的基于数字的时间戳。还有一个通用的，基于文本的格式化程序，它使用Joda-Time格式的字符串来解析文本列。</p>
</div>
</div>
<div class="sect2">
<h3 id="_mysql连接器">3.6. MySQL连接器</h3>
<div class="paragraph">
<p>MySQL连接器允许在外部MySQL数据库中查询和创建表。这可以用于加入不同系统之间的数据，如MySQL和Hive，或两个不同的MySQL实例之间的数据。</p>
</div>
<div class="paragraph">
<p><strong>配置</strong></p>
</div>
<div class="paragraph">
<p>要配置MySQL连接器，请在etc / catalog中创建一个目录属性文件，例如mysql.properties，将MySQL连接器作为mysql目录安装。创建具有以下内容的文件，根据您的设置替换连接属性：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>connector.name=mysql
connection-url=jdbc:mysql://example.net:3306
connection-user=root
connection-password=secret</pre>
</div>
</div>
<div class="paragraph">
<p><strong>多个MySQL服务器</strong></p>
</div>
<div class="paragraph">
<p>您可以根据需要拥有尽可能多的目录，因此如果您有其他MySQL服务器，只需将其他属性文件添加到etc / catalog中， 并以不同的名称（确保以.properties结尾）。例如，如果您将属性文件命名为sales.properties，Presto将使用配置的连接器创建一个名为sales的目录。</p>
</div>
<div class="paragraph">
<p><strong>查询MySQL</strong></p>
</div>
<div class="paragraph">
<p>MySQL连接器为每个MySQL 数据库提供一个模式。您可以通过运行SHOW SCHEMAS来查看可用的MySQL数据库：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW SCHEMAS FROM mysql;</pre>
</div>
</div>
<div class="paragraph">
<p>如果您有一个名为web的MySQL数据库，您可以通过运行SHOW TABLES来查看此数据库中的表：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW TABLES FROM mysql.web;</pre>
</div>
</div>
<div class="paragraph">
<p>最后，您可以访问Web数据库中的点击表：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT * FROM mysql.web.clicks;</pre>
</div>
</div>
<div class="paragraph">
<p>如果您为目录属性文件使用了其他名称，请在上述示例中使用该目录名称而不是mysql。</p>
</div>
</div>
<div class="sect2">
<h3 id="_postgresql连接器">3.7. PostgreSQL连接器</h3>
<div class="paragraph">
<p>PostgreSQL连接器允许在外部PostgreSQL数据库中查询和创建表。这可以用于连接不同系统之间的数据，如PostgreSQL和Hive，或两个不同的PostgreSQL实例之间。</p>
</div>
<div class="paragraph">
<p><strong>配置</strong></p>
</div>
<div class="paragraph">
<p>要配置PostgreSQL连接器，请在etc / catalog中创建一个目录属性文件，例如postgresql.properties，以挂载PostgreSQL连接器作为postgreSQL目录。创建具有以下内容的文件，根据您的设置替换连接属性：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>connector.name=postgresql
connection-url=jdbc:postgresql://example.net:5432/database
connection-user=root
connection-password=secret</pre>
</div>
</div>
<div class="paragraph">
<p><strong>多个PostgreSQL数据库或服务器</strong></p>
</div>
<div class="paragraph">
<p>PostgreSQL连接器只能访问PostgreSQL服务器中的单个数据库。因此，如果您有多个PostgreSQL数据库，或者想要连接到多个PostgreSQL服务器，则必须配置PostgreSQL连接器的多个实例。</p>
</div>
<div class="paragraph">
<p>要添加另一个目录，只需将另一个属性文件添加到 具有不同名称的etc / catalog中（确保以.properties结尾）。例如，如果您将属性文件命名为sales.properties，Presto将使用配置的连接器创建一个名为sales的目录。</p>
</div>
<div class="paragraph">
<p><strong>查询PostgreSQL</strong></p>
</div>
<div class="paragraph">
<p>PostgreSQL连接器为每个PostgreSQL模式提供一个模式。您可以通过运行SHOW SCHEMAS来查看可用的PostgreSQL模式：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW SCHEMAS FROM postgresql;</pre>
</div>
</div>
<div class="paragraph">
<p>如果您有一个名为Web的PostgreSQL模式，则可以通过运行SHOW TABLES来查看此模式中的表：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW TABLES FROM postgresql.web;</pre>
</div>
</div>
<div class="paragraph">
<p>最后，您可以访问Web架构中的点击表：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT * FROM postgresql.web.clicks;</pre>
</div>
</div>
<div class="paragraph">
<p>如果您为目录属性文件使用其他名称，请在上述示例中使用该目录名称而不是postgresql。</p>
</div>
</div>
<div class="sect2">
<h3 id="_系统方案">3.8. 系统方案</h3>

</div>
<div class="sect2">
<h3 id="_tpch连接器">3.9. TPCH连接器</h3>
<div class="paragraph">
<p>TPCH连接器提供了一组支持TPC Benchmark™H（TPC-H）的模式。TPC-H是用于衡量高复杂决策支持数据库性能的数据库基准。</p>
</div>
<div class="paragraph">
<p>此连接器还可用于测试Presto的功能和查询语法，而无需配置对外部数据源的访问。当查询TPCH模式时，连接器使用确定性算法即时生成数据。</p>
</div>
<div class="paragraph">
<p><strong>配置</strong></p>
</div>
<div class="paragraph">
<p>要配置TPCH连接器，请创建目录属性文件 etc / catalog / tpch.properties，其中包含以下内容：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>connector.name=tpch</pre>
</div>
</div>
<div class="paragraph">
<p><strong>TPCH Schemas</strong></p>
</div>
<div class="paragraph">
<p>TPCH连接器提供几种模式：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW SCHEMAS FROM tpch;</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>        Schema
--------------------
 information_schema
 sf1
 sf100
 sf1000
 sf10000
 sf100000
 sf300
 sf3000
 sf30000
 sys
 tiny
(11 rows)</pre>
</div>
</div>
<div class="paragraph">
<p>忽略由Presto提供并存在于每个目录中的特殊的information_schema和sys模式。</p>
</div>
<div class="paragraph">
<p>每个TPCH模式提供相同的表集合。所有模式中的某些表格是相同的。其他表根据基于 模式名称确定的比例因子而变化。
例如，模式 sf1对应于比例因子1，而模式sf300 对应于比例因子300。TPCH连接器为任何比例因子提供无限数量的模式，而不仅仅是SHOW SCHEMAS列出的几个常见的模式。
该微小的架构是比例因子的别名0.01，这是一个非常小的数据集进行测试是有用的。
== 函数和运算符</p>
</div>
</div>
<div class="sect2">
<h3 id="_逻辑运算符">3.10. 逻辑运算符</h3>
<div class="paragraph">
<p><strong>逻辑运算符</strong></p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">运算符</th>
<th class="tableblock halign-left valign-top">描述</th>
<th class="tableblock halign-left valign-top">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AND</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if both values are true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a AND b</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if either value is true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">a OR b</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NOT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True if the value is false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NOT a</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>逻辑运算符中NULL的效果</strong></p>
</div>
<div class="paragraph">
<p>如果AND表达式中有一边或者两边都是null，那么整个AND表达式的结果将会是null。如果AND表达式中至少有一边的值是false，那么整个AND表达式的值都是false。:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT CAST(null AS boolean) AND true; =&gt; null

SELECT CAST(null AS boolean) AND false; =&gt; false

SELECT CAST(null AS boolean) AND CAST(null AS boolean); =&gt; null</pre>
</div>
</div>
<div class="paragraph">
<p>如果OR表达式的一边或者两边都是null，那么整个OR表达式的值就是null。如果OR表达式中只要有一边的值为true，那么整个OR表达式的值就是true。:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT CAST(null AS boolean) OR CAST(null AS boolean); =&gt; null

SELECT CAST(null AS boolean) OR false; =&gt; null

SELECT CAST(null AS boolean) OR true; =&gt; true</pre>
</div>
</div>
<div class="paragraph">
<p>下表说明了AND和OR表达式的计算规则：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">a</th>
<th class="tableblock halign-left valign-top">b</th>
<th class="tableblock halign-left valign-top">a AND b</th>
<th class="tableblock halign-left valign-top">a OR b</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>NULL</code> 的NOT表达式的结果还是 <code>NULL</code>，如下所示：:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT NOT CAST(null AS boolean); =&gt; null</pre>
</div>
</div>
<div class="paragraph">
<p>下表说明了NOT表达式的计算规则：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">a</th>
<th class="tableblock halign-left valign-top">NOT a</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_比较函数和运算符">3.11. 比较函数和运算符</h3>
<div class="paragraph">
<p><strong>比较运算符</strong></p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">运算符</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">小于</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">大于</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8656;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">小于等于</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&gt;=</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">大于等于</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">=</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">等于</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">不等</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">!=</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">不等（不标准的用法，但是很流行这样使用）</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>范围运算符: BETWEEN</strong></p>
</div>
<div class="paragraph">
<p><code>BETWEEN</code> 运算符检测一个值是否在指定的范围。 使用语法 <code>value BETWEEN min AND max</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT 3 BETWEEN 2 AND 6;</pre>
</div>
</div>
<div class="paragraph">
<p>上面的语句和下面的语句等效:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT 3 &gt;= 2 AND 3 &lt;= 6;</pre>
</div>
</div>
<div class="paragraph">
<p>要检测一个值不在指定的范围， 使用 NOT BETWEEN:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT 3 NOT BETWEEN 2 AND 6;</pre>
</div>
</div>
<div class="paragraph">
<p>上面的语句和下面的语句等效:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT 3 &lt; 2 OR 3 &gt; 6;</pre>
</div>
</div>
<div class="paragraph">
<p>如果在 BETWEEN 或 NOT BETWEEN 语句中出现NULL， 将导致结果为NULL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT NULL BETWEEN 2 AND 4; =&gt; null

SELECT 2 BETWEEN NULL AND 6; =&gt; null</pre>
</div>
</div>
<div class="paragraph">
<p><code>BETWEEN</code> 和 <code>NOT BETWEEN</code> 运算符 也可以用于字符串参数:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT 'Paul' BETWEEN 'John' AND 'Ringo'; =&gt; true</pre>
</div>
</div>
<div class="paragraph">
<p>使用 <code>BETWEEN</code> 和 <code>NOT BETWEEN</code> 时， value、min和max参数的类型必须相同。 例如，如果你问John是否在2.3到35.2之间，Presto将会报错。</p>
</div>
<div class="paragraph">
<p><strong>空和非空</strong></p>
</div>
<div class="paragraph">
<p><code>IS NULL</code> 和 <code>IS NOT NULL</code> 运算符检测一个值是否为空（未定义）。 这两个运算符适用于所有数据类型。</p>
</div>
<div class="paragraph">
<p>在 <code>IS NULL</code> 语句中使用 <code>NULL</code> 进行对比 ，结果为true:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>select NULL IS NULL; =&gt; true</pre>
</div>
</div>
<div class="paragraph">
<p>但使用其他常量进行对比，结果都是false:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT 3.0 IS NULL; =&gt; false</pre>
</div>
</div>
<div class="paragraph">
<p><strong>IS DISTINCT FROM 和 IS NOT DISTINCT FROM</strong></p>
</div>
<div class="paragraph">
<p>在SQL中 <code>NULL</code> 表示一个未知的值， 因此，任何比较相关的语句含有 <code>NULL</code> ，结果都是 <code>NULL</code>。 而 <code>IS DISTINCT FROM</code> 和 <code>IS NOT DISTINCT FROM</code> 运算符将 <code>NULL</code> 视为一个已知的值， 这两个运算符保证即使输入中有 NULL ， 结果也是true或false。</p>
</div>
<div class="paragraph">
<p>SELECT NULL IS DISTINCT FROM NULL; &#8658; false</p>
</div>
<div class="paragraph">
<p>SELECT NULL IS NOT DISTINCT FROM NULL; &#8658; true</p>
</div>
<div class="paragraph">
<p>上述示例中， <code>NULL</code> 值与 <code>NULL</code> 没有区别。 当你的比较操作中可能包含 <code>NULL</code> 的值时， 使用这两个运算符可以保证结果只能是 <code>TRUE</code> 或 <code>FALSE</code> 。</p>
</div>
<div class="paragraph">
<p>下表格展示了 <code>NULL</code> 在 <code>IS DISTINCT FROM</code> 和 <code>IS NOT DISTINCT FROM</code> 中是怎样计算的:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">a</th>
<th class="tableblock halign-left valign-top">b</th>
<th class="tableblock halign-left valign-top">a = a</th>
<th class="tableblock halign-left valign-top">a &lt;&gt; b</th>
<th class="tableblock halign-left valign-top">a DISTINCT b</th>
<th class="tableblock halign-left valign-top">a NOT DISTINCT b</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NULL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FALSE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRUE</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>最大和最小</strong></p>
</div>
<div class="paragraph">
<p>这两个函数不是SQL标准函数，他们是常用的扩展。 与Presto的其他数函数相似，任何一个参数为空，则返回空。 但是在某些其他数据库中，例如PostgreSQL， 只有全部参数都为空时，才返回空。</p>
</div>
<div class="paragraph">
<p>支持类型： <code>DOUBLE</code>, <code>BIGINT</code>, <code>VARCHAR</code>, <code>TIMESTAMP</code>, <code>TIMESTAMP WITH TIME ZONE</code>, <code>DATE</code></p>
</div>
<div class="paragraph">
<p><strong>greatest</strong>(value1, value2) → [与输入相同]
返回提供的最大值。</p>
</div>
<div class="paragraph">
<p><strong>least</strong>(value1, value2) → [与输入相同]
返回提供的最小值。</p>
</div>
</div>
<div class="sect2">
<h3 id="_条件表达式">3.12. 条件表达式</h3>
<div class="paragraph">
<p><strong>CASE</strong></p>
</div>
<div class="paragraph">
<p>标准的SQL <code>CASE</code> 表达式有两种模式。 “简单模式”从左向右查找表达式的每个 <code>value</code> ， 直到找出相等的 <code>expression</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CASE expression
    WHEN value THEN result
    [ WHEN ... ]
    [ ELSE result ]
END</pre>
</div>
</div>
<div class="paragraph">
<p>返回匹配 <code>value</code> 的 <code>result</code> 。 如果没有匹配到任何值，则返回 <code>ELSE</code> 子句的 <code>result</code> ； 如果没有 <code>ELSE</code> 子句，则返回空。示例:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT a,
       CASE a
           WHEN 1 THEN 'one'
           WHEN 2 THEN 'two'
           ELSE 'many'
       END</pre>
</div>
</div>
<div class="paragraph">
<p>“查找模式”从左向右判断每个 <code>condition</code> 的布尔值， 直到判断为真，返回匹配 <code>result</code> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CASE
    WHEN condition THEN result
    [ WHEN ... ]
    [ ELSE result ]
END</pre>
</div>
</div>
<div class="paragraph">
<p>如果判断条件都不成立，则返回 <code>ELSE</code> 子句的 <code>result</code> ； 如果没有 <code>ELSE</code> 子句，则返回空。示例:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT a, b,
       CASE
           WHEN a = 1 THEN 'aaa'
           WHEN b = 2 THEN 'bbb'
           ELSE 'ccc'
       END</pre>
</div>
</div>
<div class="paragraph">
<p><strong>IF</strong></p>
</div>
<div class="paragraph">
<p><code>IF</code> 函数是语言结构， 它与下面的 <code>CASE</code> 表达式功能相同:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CASE
    WHEN condition THEN true_value
    [ ELSE false_value ]
END</pre>
</div>
</div>
<div class="paragraph">
<p><strong>if</strong>(condition, true_value)
如果 condition 为真，返回 true_value ； 否则返回空， true_value 不进行计算。</p>
</div>
<div class="paragraph">
<p><strong>if</strong>(condition, true_value, false_value)
如果 condition 为真，返回 true_value ； 否则计算并返回 false_value 。</p>
</div>
<div class="paragraph">
<p><strong>COALESCE</strong></p>
</div>
<div class="paragraph">
<p><strong>coalesce</strong>(value[, &#8230;&#8203;])
返回参数列表中的第一个非空 value 。 与 CASE 表达式相似，仅在必要时计算参数。</p>
</div>
<div class="paragraph">
<p><strong>NULLIF</strong></p>
</div>
<div class="paragraph">
<p><strong>nullif</strong>(value1, value2)
如果 value1 与 value2 相等，返回空；否则返回 value1 。</p>
</div>
</div>
<div class="sect2">
<h3 id="_转换函数">3.13. 转换函数</h3>
<div class="paragraph">
<p>Presto会将数字和字符值隐式转换成正确的类型。 Presto不会把字符和数字类型相互转换。 例如，一个查询期望得到一个varchar类型的值， Presto不会自动将bigint类型的值转换为varchar 类型。</p>
</div>
<div class="paragraph">
<p>如果有必要，可以将值显式转换为指定类型。</p>
</div>
<div class="paragraph">
<p><strong>转换函数</strong></p>
</div>
<div class="paragraph">
<p><strong>cast</strong>(value AS type) → type
显式转换一个值的类型。 可以将varchar类型的值转为数字类型，反过来转换也可以。</p>
</div>
<div class="paragraph">
<p><strong>try_cast</strong>(value AS type) → type
与 cast() 相似，区别是转换失败返回null。</p>
</div>
</div>
<div class="sect2">
<h3 id="_数学函数和运算符">3.14. 数学函数和运算符</h3>
<div class="paragraph">
<p><strong>数学运算符</strong></p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">运算符</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">加</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">减</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">*</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">乘</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">除</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">模（余数）</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>数学函数</strong></p>
</div>
<div class="paragraph">
<p><strong>abs</strong>(x) → [same as input]</p>
</div>
<div class="paragraph">
<p>返回 <code>x</code> 的绝对值</p>
</div>
<div class="paragraph">
<p><strong>cbrt</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回 <code>x</code> 的立方根</p>
</div>
<div class="paragraph">
<p><strong>ceil</strong>(x) → [same as input]</p>
</div>
<div class="paragraph">
<p>是 <code>ceiling()</code> 的同名方法</p>
</div>
<div class="paragraph">
<p><strong>ceiling</strong>(x) → [same as input]</p>
</div>
<div class="paragraph">
<p>返回 <code>x</code> 的向上取整的数值</p>
</div>
<div class="paragraph">
<p><strong>degrees</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>将角度 <code>x</code> 以弧度转换为度</p>
</div>
<div class="paragraph">
<p><strong>e</strong>() → double</p>
</div>
<div class="paragraph">
<p>返回欧拉的常数</p>
</div>
<div class="paragraph">
<p><strong>exp</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>将欧拉的数字提高到 <code>x</code> 的强度</p>
</div>
<div class="paragraph">
<p><strong>floor</strong>(x) → [same as input]</p>
</div>
<div class="paragraph">
<p>返回 <code>x</code> 舍入到最接近的整数</p>
</div>
<div class="paragraph">
<p><strong>from_base</strong>(string, radix) → bigint</p>
</div>
<div class="paragraph">
<p>返回字符串的值为一个base-radix数。</p>
</div>
<div class="paragraph">
<p><strong>ln</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回 <code>x</code> 的自然对数。</p>
</div>
<div class="paragraph">
<p><strong>log2</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回 <code>x</code> 的基数2的对数。</p>
</div>
<div class="paragraph">
<p><strong>log10</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回 <code>x</code> 的基数10的对数。</p>
</div>
<div class="paragraph">
<p><strong>log</strong>(x, b) → double</p>
</div>
<div class="paragraph">
<p>返回基数为b的对数 <code>x</code>。</p>
</div>
<div class="paragraph">
<p><strong>mod</strong>(n, m) → [same as input]</p>
</div>
<div class="paragraph">
<p>返回 <code>n</code> 除以 <code>m</code> 的余数</p>
</div>
<div class="paragraph">
<p><strong>pi</strong>() → double</p>
</div>
<div class="paragraph">
<p>返回常数pi</p>
</div>
<div class="paragraph">
<p><strong>pow</strong>(x, p) → double</p>
</div>
<div class="paragraph">
<p>将x提高到p的幂。</p>
</div>
<div class="paragraph">
<p><strong>radians</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>将角度x以度为单位转换为弧度。</p>
</div>
<div class="paragraph">
<p><strong>rand</strong>() → double</p>
</div>
<div class="paragraph">
<p>随机函数</p>
</div>
<div class="paragraph">
<p><strong>random</strong>() → double</p>
</div>
<div class="paragraph">
<p>返回0到1范围内的伪随机值</p>
</div>
<div class="paragraph">
<p><strong>round</strong>(x) → [same as input]</p>
</div>
<div class="paragraph">
<p>返回x舍入到最接近的整数。</p>
</div>
<div class="paragraph">
<p><strong>round</strong>(x, d) → [same as input]</p>
</div>
<div class="paragraph">
<p>返回X四舍五入到d小数。</p>
</div>
<div class="paragraph">
<p><strong>sqrt</strong>(x) → double</p>
</div>
<div class="literalblock">
<div class="content">
<pre>返回x的算数平方根</pre>
</div>
</div>
<div class="paragraph">
<p><strong>to_base</strong>(x, radix) → varchar</p>
</div>
<div class="paragraph">
<p>返回x的基数</p>
</div>
<div class="paragraph">
<p><strong>三角函数</strong></p>
</div>
<div class="paragraph">
<p>所有三角函数的参数都是以弧度表示。参考单位转换函数degrees() 和 radians()</p>
</div>
<div class="paragraph">
<p><strong>acos</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回x的反余弦。</p>
</div>
<div class="paragraph">
<p><strong>asin</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回x的反正弦</p>
</div>
<div class="paragraph">
<p><strong>atan</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回x的反正切</p>
</div>
<div class="paragraph">
<p><strong>atan2</strong>(y, x) → double</p>
</div>
<div class="paragraph">
<p>返回y/x的反正弦切</p>
</div>
<div class="paragraph">
<p><strong>cos</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回x的余弦</p>
</div>
<div class="paragraph">
<p><strong>cosh</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回x的双曲余弦。</p>
</div>
<div class="paragraph">
<p><strong>sin</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回x的正弦。</p>
</div>
<div class="paragraph">
<p><strong>tan</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回x的正切。</p>
</div>
<div class="paragraph">
<p><strong>tanh</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回x的双曲正切。</p>
</div>
<div class="paragraph">
<p><strong>浮点函数</strong></p>
</div>
<div class="paragraph">
<p><strong>infinity</strong>() → double</p>
</div>
<div class="paragraph">
<p>返回代表正无穷大的常量Returns</p>
</div>
<div class="paragraph">
<p><strong>is_finite</strong>(x) → boolean</p>
</div>
<div class="paragraph">
<p>确定x是否有限。</p>
</div>
<div class="paragraph">
<p><strong>is_infinite</strong>(x) → boolean</p>
</div>
<div class="paragraph">
<p>确定x是无限的。</p>
</div>
<div class="paragraph">
<p><strong>is_nan</strong>(x) → boolean</p>
</div>
<div class="paragraph">
<p>确定x是否不是数字。</p>
</div>
<div class="paragraph">
<p><strong>nan</strong>() → double</p>
</div>
<div class="paragraph">
<p>返回表示not-a-number的常量。</p>
</div>
</div>
<div class="sect2">
<h3 id="_字符串函数和运算符">3.15. 字符串函数和运算符</h3>
<div class="paragraph">
<p><strong>字符串运算符</strong></p>
</div>
<div class="paragraph">
<p>使用运算符： || 完成字符串连接</p>
</div>
<div class="paragraph">
<p><strong>字符串函数</strong></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
目前所有的字符串函数都不能对Unicode（non-ASCII）字符串进行正确处理。例如，方法length()会返回UTF-8格式的字符串中的byte的数目，但是对于UniCode编码的字符串中的byte的个数却不能返回。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>chr</strong>(n) → varchar</p>
</div>
<div class="paragraph">
<p>返回在下标为n的位置的char字符的字符串格式表示</p>
</div>
<div class="paragraph">
<p><strong>concat</strong>(string1, string2) → varchar</p>
</div>
<div class="paragraph">
<p>返回string1和string2的并置。此函数提供与SQL标准连接运算符（||）相同的功能。</p>
</div>
<div class="paragraph">
<p><strong>length</strong>(string) → bigint</p>
</div>
<div class="paragraph">
<p>以字符返回字符串的长度。</p>
</div>
<div class="paragraph">
<p><strong>lower</strong>(string) → varchar</p>
</div>
<div class="paragraph">
<p>将字符串转换为小写</p>
</div>
<div class="paragraph">
<p><strong>ltrim</strong>(string) → varchar</p>
</div>
<div class="paragraph">
<p>从字符串中删除前导空格。</p>
</div>
<div class="paragraph">
<p><strong>replace</strong>(string, search) → varchar</p>
</div>
<div class="paragraph">
<p>从字符串中删除所有搜索实例。</p>
</div>
<div class="paragraph">
<p><strong>replace</strong>(string, search, replace) → varchar</p>
</div>
<div class="paragraph">
<p>替换的所有实例查找与替换的字符串。</p>
</div>
<div class="paragraph">
<p><strong>reverse</strong>(string) → varchar</p>
</div>
<div class="paragraph">
<p>以相反的顺序返回带字符的字符串。</p>
</div>
<div class="paragraph">
<p><strong>rtrim</strong>(string) → varchar</p>
</div>
<div class="paragraph">
<p>从字符串中删除尾随空格。</p>
</div>
<div class="paragraph">
<p><strong>split</strong>(string, delimiter) → array&lt;varchar&gt;</p>
</div>
<div class="paragraph">
<p>在分隔符上分割字符串并返回数组。</p>
</div>
<div class="paragraph">
<p><strong>split</strong>(string, delimiter, limit) → array&lt;varchar&gt;</p>
</div>
<div class="paragraph">
<p>拆分分隔符上的字符串，并返回大小最大限制的数组 。数组中的最后一个元素总是包含字符串中的所有内容。极限必须是正数。</p>
</div>
<div class="paragraph">
<p><strong>split_part</strong>(string, delimiter, index) → varchar</p>
</div>
<div class="paragraph">
<p>在分隔符上分割字符串并返回字段索引。字段索引以1开头。如果索引大于字段数，则返回null。</p>
</div>
<div class="paragraph">
<p><strong>strpos</strong>(string, substring) → bigint</p>
</div>
<div class="paragraph">
<p>返回的第一个实例的起始位置子的 字符串。职位从1开始。如果没有找到，则返回0</p>
</div>
<div class="paragraph">
<p><strong>substr</strong>(string, start) → varchar</p>
</div>
<div class="paragraph">
<p>从起始位置开始返回字符串的其余部分。职位从1开始。负起始位置被解释为相对于字符串的结尾。</p>
</div>
<div class="paragraph">
<p><strong>substr</strong>(string, start, length) → varchar</p>
</div>
<div class="paragraph">
<p>从起始位置开始返回长度为长度的字符串的子串。职位从1开始。负起始位置被解释为相对于字符串的结尾。</p>
</div>
<div class="paragraph">
<p><strong>trim</strong>(string) → varchar</p>
</div>
<div class="paragraph">
<p>从字符串中删除前导和尾随空格。</p>
</div>
<div class="paragraph">
<p><strong>upper</strong>(string) → varchar</p>
</div>
<div class="paragraph">
<p>将字符串转换为大写。</p>
</div>
</div>
<div class="sect2">
<h3 id="_二进制函数">3.16. 二进制函数</h3>
<div class="paragraph">
<p><strong>二进制函数</strong></p>
</div>
<div class="paragraph">
<p><strong>length</strong>(binary) → bigint</p>
</div>
<div class="paragraph">
<p>返回 binary 的字节长度。</p>
</div>
<div class="paragraph">
<p><strong>to_base64</strong>(binary) → varchar</p>
</div>
<div class="paragraph">
<p>将 binary 编码为base64字符串表示。</p>
</div>
<div class="paragraph">
<p><strong>from_base64</strong>(string) → varbinary</p>
</div>
<div class="paragraph">
<p>将base64编码的 string 解码为二进制数据。</p>
</div>
<div class="paragraph">
<p><strong>to_base64url</strong>(binary) → varchar</p>
</div>
<div class="paragraph">
<p>使用URL安全字符，将 binary 编码为base64字符串表示。</p>
</div>
<div class="paragraph">
<p><strong>from_base64url</strong>(string) → varbinary</p>
</div>
<div class="paragraph">
<p>使用URL安全字符，将base64编码的 string 解码为二进制数据。</p>
</div>
<div class="paragraph">
<p><strong>to_hex</strong>(binary) → varchar</p>
</div>
<div class="paragraph">
<p>将 binary 编码为16进制字符串表示。</p>
</div>
<div class="paragraph">
<p><strong>from_hex</strong>(string) → varbinary</p>
</div>
<div class="paragraph">
<p>将16进制编码的 string 解码为二进制数据。</p>
</div>
</div>
<div class="sect2">
<h3 id="_日期时间函数和运算符">3.17. 日期时间函数和运算符</h3>
<div class="paragraph">
<p><strong>日期时间运算符</strong></p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">运算符</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">示例</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">结果</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">date '2012-08-08' + interval '2' day</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2012-08-10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">time '01:00' + interval '3' hour</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">04:00:00.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timestamp '2012-08-08 01:00' + interval '29' hour</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2012-08-09 06:00:00.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timestamp '2012-10-31 01:00' + interval '1' month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2012-11-30 01:00:00.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">interval '2' day + interval '3' hour</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 03:00:00.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">+</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">interval '3' year + interval '5' month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3-5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">date '2012-08-08' - interval '2' day</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2012-08-06</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">time '01:00' - interval '3' hour</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">22:00:00.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timestamp '2012-08-08 01:00' - interval '29' hour</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2012-08-06 20:00:00.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timestamp '2012-10-31 01:00' - interval '1' month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2012-09-30 01:00:00.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">interval '2' day - interval '3' hour</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1 21:00:00.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">interval '3' year - interval '5' month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2-7</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>时区转换</strong></p>
</div>
<div class="paragraph">
<p>运算符：AT TIME ZONE，用于设置一个时间戳的时区:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT timestamp '2012-10-31 01:00 UTC';
2012-10-31 01:00:00.000 UTC

SELECT timestamp '2012-10-31 01:00 UTC' AT TIME ZONE 'America/Los_Angeles';
2012-10-30 18:00:00.000 America/Los_Angeles</pre>
</div>
</div>
<div class="paragraph">
<p><strong>日期时间函数</strong></p>
</div>
<div class="paragraph">
<p><strong>current_date</strong> &#8594; date</p>
</div>
<div class="paragraph">
<p>返回查询开始时的当前日期。</p>
</div>
<div class="paragraph">
<p><strong>current_time</strong> &#8594; time with time zone</p>
</div>
<div class="paragraph">
<p>返回从查询开始的当前时间。</p>
</div>
<div class="paragraph">
<p><strong>current_timestamp</strong> &#8594; timestamp with time zone</p>
</div>
<div class="paragraph">
<p>从查询开始返回当前时间戳。</p>
</div>
<div class="paragraph">
<p><strong>current_timezone</strong>() → varchar</p>
</div>
<div class="paragraph">
<p>以IANA（例如，America / Los_Angeles）定义的格式返回当前时区，或以UTC的固定偏移量（例如+08：35）返回当前时区</p>
</div>
<div class="paragraph">
<p><strong>from_unixtime</strong>(unixtime) → timestamp</p>
</div>
<div class="paragraph">
<p>将UNIX时间戳记unixtime作为时间戳返回。</p>
</div>
<div class="paragraph">
<p><strong>from_unixtime</strong>(unixtime, hours, minutes) → timestamp with time zone</p>
</div>
<div class="paragraph">
<p>返回UNIX时间戳unixtime与使用时区的时间戳小时和分钟的时区偏移量。</p>
</div>
<div class="paragraph">
<p><strong>(localtime</strong> &#8594; time</p>
</div>
<div class="paragraph">
<p>返回从查询开始的当前时间。</p>
</div>
<div class="paragraph">
<p><strong>localtimestamp</strong> &#8594; timestamp</p>
</div>
<div class="paragraph">
<p>从查询开始返回当前时间戳。</p>
</div>
<div class="paragraph">
<p><strong>now</strong>() → timestamp with time zone</p>
</div>
<div class="paragraph">
<p>这是current_timestamp的别名。</p>
</div>
<div class="paragraph">
<p><strong>to_unixtime</strong>(timestamp) → double</p>
</div>
<div class="paragraph">
<p>返回时间戳作为UNIX时间戳。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
下列SQL标准的函数不使用圆括号：
* current_date
* current_time
* current_timestamp
* localtime
* localtimestamp
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>截取函数</strong></p>
</div>
<div class="paragraph">
<p>函数 date_trunc 支持如下单位：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">单位</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Example Truncated Value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">second</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2001-08-22 03:04:05.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">minute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2001-08-22 03:04:00.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hour</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2001-08-22 03:00:00.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">day</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2001-08-22 00:00:00.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">week</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2001-08-20 00:00:00.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2001-08-01 00:00:00.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">quarter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2001-07-01 00:00:00.000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">year</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2001-01-01 00:00:00.000</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>上面的例子使用时间戳： <code>2001-08-22 03:04:05.321</code> 作为输入。</p>
</div>
<div class="paragraph">
<p><strong>date_trunc</strong>(unit, x) → [same as input]</p>
</div>
<div class="paragraph">
<p>返回x截取到单位 <code>unit</code> 之后的值</p>
</div>
<div class="paragraph">
<p><strong>间隔函数</strong></p>
</div>
<div class="paragraph">
<p>本章中的函数支持如下所列的间隔单位：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">second</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Seconds</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">minute</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Minutes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hour</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hours</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">day</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Days</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">week</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Weeks</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">month</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Months</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">quarter</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Quarters of a year</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">year</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Years</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><strong>date_add</strong>(unit, value, timestamp) → [same as input]</p>
</div>
<div class="paragraph">
<p>在timestamp的基础上加上value个unit。如果想要执行相减的操作，可以通过将value赋值为负数来完成。</p>
</div>
<div class="paragraph">
<p><strong>date_diff</strong>(unit, timestamp1, timestamp2) → bigint</p>
</div>
<div class="paragraph">
<p>返回 timestamp2 - timestamp1 之后的值，该值的表示单位是unit。</p>
</div>
<div class="paragraph">
<p><strong>MySQL日期函数</strong></p>
</div>
<div class="paragraph">
<p>在这一章节使用与MySQL <code>date_parse</code> 和 <code>str_to_date</code> 方法兼容的格式化字符串。下面的表格是基于MySQL手册列出的，描述了各种格式化描述符：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifier</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abbreviated weekday name (Sun .. Sat)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%b</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abbreviated month name (Jan .. Dec)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%c</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Month, numeric (0 .. 12)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%D</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Day of the month with English suffix (0th, 1st, 2nd, 3rd, &#8230;&#8203;)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%d</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Day of the month, numeric (00 .. 31)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%e</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Day of the month, numeric (0 .. 31)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%f</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Microseconds (000000 .. 999999)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%H</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hour (00 .. 23)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%h</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hour (01 .. 12)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%I</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hour (01 .. 12)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%i</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Minutes, numeric (00 .. 59)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%j</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Day of year (001 .. 366)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%k</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hour (0 .. 23)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%l</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hour (1 .. 12)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%M</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Month name (January .. December)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%m</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Month, numeric (00 .. 12)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%p</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">AM or PM</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%r</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time, 12-hour (hh:mm:ss followed by AM or PM)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%S</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Seconds (00 .. 59)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%s</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Seconds (00 .. 59)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%T</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time, 24-hour (hh:mm:ss)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%U</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Week (00 .. 53), where Sunday is the first day of the week</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%u</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Week (00 .. 53), where Monday is the first day of the week</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%V</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Week (01 .. 53), where Sunday is the first day of the week; used with %X</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%v</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Week (01 .. 53), where Monday is the first day of the week; used with %x</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%W</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Weekday name (Sunday .. Saturday)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%w</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Day of the week (0 .. 6), where Sunday is the first day of the week</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Year for the week where Sunday is the first day of the week, numeric, four digits; used with %V</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Year for the week, where Monday is the first day of the week, numeric, four digits; used with %v</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Year, numeric, four digits</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Year, numeric (two digits)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%%</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A literal % character</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">%x</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x, for any x not listed above</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
这些格式化描述符现在还不支持：%D %U %u %V %X
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>date_format</strong>(timestamp, format) → varchar</p>
</div>
<div class="paragraph">
<p>使用format指定的格式，将timestamp格式化成字符串。</p>
</div>
<div class="paragraph">
<p><strong>date_parse</strong>(string, format) → timestamp</p>
</div>
<div class="paragraph">
<p>按照format指定的格式，将字符串string解析成timestamp。</p>
</div>
<div class="paragraph">
<p><strong>Java日期函数</strong></p>
</div>
<div class="paragraph">
<p>在这一章节中使用的格式化字符串都是与Java的 SimpleDateFormat样式兼容的。</p>
</div>
<div class="paragraph">
<p><strong>format_datetime</strong>(timestamp, format) → varchar</p>
</div>
<div class="paragraph">
<p>格式时间戳为使用字符串格式。</p>
</div>
<div class="paragraph">
<p>|<strong>parse_datetime</strong>(string, format) → timestamp with time zone</p>
</div>
<div class="paragraph">
<p>使用格式将字符串解析为带有时区的时间戳。</p>
</div>
<div class="paragraph">
<p><strong>抽取函数</strong></p>
</div>
<div class="paragraph">
<p>可以使用抽取函数来抽取如下域：</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Field</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">YEAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">year()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">QUARTER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">quarter()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MONTH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">month()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WEEK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">week()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DAY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">day()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DAY_OF_MONTH</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">day()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DAY_OF_WEEK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">day_of_week()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DOW</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">day_of_week()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DAY_OF_YEAR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">day_of_year()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DOY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">day_of_year()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">YEAR_OF_WEEK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">year_of_week()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">YOW</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">year_of_week()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HOUR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hour()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MINUTE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">minute()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SECOND</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">second()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMEZONE_HOUR</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timezone_hour()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMEZONE_MINUTE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timezone_minute()</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>抽取函数支持的数据类型取决于需要抽取的域。大多数域都支持日期和时间类型。</p>
</div>
<div class="paragraph">
<p><strong>extract</strong>(field FROM x) → bigint</p>
</div>
<div class="paragraph">
<p>从x中返回域field</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
SQL标准的函数一般都会使用特定的语法来指定参数。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>便利的抽取函数</strong></p>
</div>
<div class="paragraph">
<p><strong>day</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>从x返回月份的日期。</p>
</div>
<div class="paragraph">
<p><strong>day_of_month</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>这是day（）的别名。</p>
</div>
<div class="paragraph">
<p><strong>day_of_week</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>从x返回星期的ISO日。取值范围为1（星期一）到7（星期日）。</p>
</div>
<div class="paragraph">
<p><strong>day_of_year</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>从x返回一年中的日期。取值范围为1至366。</p>
</div>
<div class="paragraph">
<p><strong>dow</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>这是day_of_week（）的别名。</p>
</div>
<div class="paragraph">
<p><strong>doy</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>这是day_of_year（）的别名。</p>
</div>
<div class="paragraph">
<p><strong>hour</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>从x返回当天的小时数。取值范围为0到23。</p>
</div>
<div class="paragraph">
<p><strong>minute</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>从x返回小时的分钟。</p>
</div>
<div class="paragraph">
<p><strong>month</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>从x返回一年中的月份。</p>
</div>
<div class="paragraph">
<p><strong>quarter</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>从x返回一年中的季度。取值范围为1至4。</p>
</div>
<div class="paragraph">
<p><strong>second</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>从x返回第二个小时。</p>
</div>
<div class="paragraph">
<p><strong>timezone_hour</strong>(timestamp) → bigint</p>
</div>
<div class="paragraph">
<p>返回从时间戳偏移的时区。</p>
</div>
<div class="paragraph">
<p><strong>timezone_minute</strong>(timestamp) → bigint</p>
</div>
<div class="paragraph">
<p>返回从时间戳偏移的时区的分钟。</p>
</div>
<div class="paragraph">
<p><strong>week</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>从x返回一年中的ISO周。取值范围为1至53。</p>
</div>
<div class="paragraph">
<p><strong>week_of_year</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>这是星期（）的别名。</p>
</div>
<div class="paragraph">
<p><strong>year</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>从x返回年份。</p>
</div>
<div class="paragraph">
<p><strong>year_of_week</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>从x返回ISO周的年份。</p>
</div>
<div class="paragraph">
<p><strong>yow</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>这是year_of_week（）的别名。</p>
</div>
</div>
<div class="sect2">
<h3 id="_正则表达式函数">3.18. 正则表达式函数</h3>
<div class="paragraph">
<p>所有的正则表达式函数都使用Java样式的语法。</p>
</div>
<div class="paragraph">
<p><strong>regexp_extract_all</strong>(string, pattern) → array&lt;varchar&gt;</p>
</div>
<div class="paragraph">
<p>返回由正则表达式匹配的子串（一个或多个）图案 中的字符串。</p>
</div>
<div class="paragraph">
<p><strong>regexp_extract_all</strong>(string, pattern, group) → array&lt;varchar&gt;</p>
</div>
<div class="paragraph">
<p>发现正则表达式中出现的所有图案中的字符串 并返回捕获组号 组。</p>
</div>
<div class="paragraph">
<p><strong>regexp_extract</strong>(string, pattern) → varchar</p>
</div>
<div class="paragraph">
<p>返回由正则表达式匹配的第一子图案 中的字符串。</p>
</div>
<div class="paragraph">
<p><strong>regexp_extract</strong>(string, pattern, group) → varchar</p>
</div>
<div class="paragraph">
<p>发现正则表达式的第一个匹配图案中 的字符串并返回捕获组号 组。</p>
</div>
<div class="paragraph">
<p><strong>regexp_like</strong>(string, pattern) → boolean</p>
</div>
<div class="paragraph">
<p>评估正则表达式模式并确定它是否包含在字符串中。</p>
</div>
<div class="paragraph">
<p>此函数类似于LIKE运算符，期望该模式只需要包含在字符串中，而不是需要匹配所有的字符串。换句话说，这将执行 包含操作而不是匹配操作。您可以通过使用^和$锚定模式来匹配整个字符串。</p>
</div>
<div class="paragraph">
<p><strong>regexp_replace</strong>(string, pattern) → varchar</p>
</div>
<div class="paragraph">
<p>从字符串中删除正则表达式模式匹配的子字符串的每个实例 。</p>
</div>
<div class="paragraph">
<p><strong>regexp_replace</strong>(string, pattern, replacement) → varchar</p>
</div>
<div class="paragraph">
<p>替换由正则表达式匹配的子串的每一个实例 的图案中的字符串与替换。可以使用$ g为编号组或 $ {name} 替换获取组的命名组。替换中的美元符号（$）可能会用反斜杠（\ $）进行转义。</p>
</div>
</div>
<div class="sect2">
<h3 id="_json函数">3.19. JSON函数</h3>
<div class="paragraph">
<p><strong>json_array_contains</strong>(json, value) → boolean</p>
</div>
<div class="paragraph">
<p>判断value是否在json（json格式的字符串）中存在:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT json_array_contains('[1, 2, 3]', 2);</pre>
</div>
</div>
<div class="paragraph">
<p><strong>json_array_length</strong>(json) → bigint</p>
</div>
<div class="paragraph">
<p>返回json的数组长度（包含JSON数组的字符串）。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT json_array_length('[1, 2, 3]');</pre>
</div>
</div>
<div class="paragraph">
<p><strong>json_extract</strong>(json, json_path) → varchar</p>
</div>
<div class="paragraph">
<p>评估json上的JSONPath样表达式json_path （包含JSON的字符串），并将结果作为JSON字符串返回。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT json_extract(json, '$.store.book');</pre>
</div>
</div>
<div class="paragraph">
<p><strong>json_extract_scalar</strong>(json, json_path) → varchar</p>
</div>
<div class="paragraph">
<p>像json_extract（），但返回结果值作为一个字符串（而不是编码为JSON）。json_path引用的值必须是标量（布尔值，数字或字符串）。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT json_extract_scalar('[1, 2, 3]', '$[2]');

SELECT json_extract_scalar(json, '$.store.book[0].author');</pre>
</div>
</div>
<div class="paragraph">
<p><strong>json_array_get</strong>(json_array, index) → varchar</p>
</div>
<div class="paragraph">
<p>将指定索引处的元素返回到json_array中。索引为0。例如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT json_array_get('["a", "b", "c"]', 0); =&gt; "a"
SELECT json_array_get('["a", "b", "c"]', 1); =&gt; "b"</pre>
</div>
</div>
<div class="paragraph">
<p>此函数还支持从数组末尾读取元素索引的负索引。例如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT json_array_get('["c", "b", "a"]', -1); =&gt; "a"
SELECT json_array_get('["c", "b", "a"]', -2); =&gt; "b"</pre>
</div>
</div>
<div class="paragraph">
<p>如果指定索引处的元素不存在，则函数返回null：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT json_array_get('[]', 0); =&gt; null
SELECT json_array_get('["a", "b", "c"]', 10); =&gt; null
SELECT json_array_get('["c", "b", "a"]', -10); =&gt; null</pre>
</div>
</div>
<div class="paragraph">
<p><strong>json_size</strong>(json, json_path) → bigint</p>
</div>
<div class="paragraph">
<p>像json_extract（），但返回值的大小。对象值的大小是字段的数量，数组的大小是元素的数量。标量值的大小为零。例如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT json_size('{ "x": {"a": 1, "b": 2} }', '$.x'); =&gt; 2
SELECT json_size('{ "x": [1, 2, 3] }', '$.x'); =&gt; 2
SELECT json_size('{ "x": {"a": 1, "b": 2} }', '$.x.a'); =&gt; 0</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_url函数">3.20. URL函数</h3>
<div class="paragraph">
<p>URL方法用于从HTTP URLs（或者是任何满足RFC 2396标准的有效URIs）中提取相应的信息。URL方法支持如下的语法：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[protocol:][//host[:port]][path][?query][#fragment]</pre>
</div>
</div>
<div class="paragraph">
<p>被从URLs中提取出来的部分，不会包括URI的语法分隔符（如:或者?）</p>
</div>
<div class="paragraph">
<p><strong>url_extract_fragment</strong>(url) → varchar</p>
</div>
<div class="paragraph">
<p>从url返回片段标识符。</p>
</div>
<div class="paragraph">
<p><strong>url_extract_host</strong>(url) → varchar</p>
</div>
<div class="paragraph">
<p>从url返回主机。</p>
</div>
<div class="paragraph">
<p><strong>url_extract_parameter</strong>(url, name) → varchar</p>
</div>
<div class="paragraph">
<p>从url返回名为name的第一个查询字符串参数的值。参数提取按照指定的典型方式处理RFC 1866。</p>
</div>
<div class="paragraph">
<p><strong>url_extract_path</strong>(url) → varchar</p>
</div>
<div class="paragraph">
<p>从url返回路径。</p>
</div>
<div class="paragraph">
<p><strong>url_extract_port</strong>(url) → bigint</p>
</div>
<div class="paragraph">
<p>从url返回端口号。</p>
</div>
<div class="paragraph">
<p><strong>url_extract_protocol</strong>(url) → varchar</p>
</div>
<div class="paragraph">
<p>从url返回协议。</p>
</div>
<div class="paragraph">
<p><strong>url_extract_query</strong>(url) → varchar</p>
</div>
<div class="paragraph">
<p>从url返回查询字符串。</p>
</div>
</div>
<div class="sect2">
<h3 id="_聚合函数">3.21. 聚合函数</h3>
<div class="paragraph">
<p>聚合函数作用于一个数据集，计算出一个单独的结果。</p>
</div>
<div class="paragraph">
<p>除了 count() 、 count_if() 、 max_by() 和 approx_distinct() ， 所有聚合函数都忽略空值，如果没有输入或全部输入都为空时，返回空。 例如， sum() 返回空，而不是0。
 avg() 会将数据中的空值进行计数。 coalesce 函数可以将空转换为0。</p>
</div>
<div class="paragraph">
<p><strong>一般聚合函数</strong></p>
</div>
<div class="paragraph">
<p><strong>arbitrary</strong>(x) → [与输入相同]</p>
</div>
<div class="paragraph">
<p>返回 x 的任意非空值（如果存在的话）。</p>
</div>
<div class="paragraph">
<p><strong>avg</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回所有输入值的平均数（算术平均数）。</p>
</div>
<div class="paragraph">
<p><strong>bool_and</strong>(boolean) → boolean</p>
</div>
<div class="paragraph">
<p>如果所有输入值都为 TRUE 返回 TRUE ，否则返回 FALSE 。</p>
</div>
<div class="paragraph">
<p><strong>bool_or</strong>(boolean) → boolean</p>
</div>
<div class="paragraph">
<p>如果任何一个输入值为 TRUE 返回 TRUE ，否则返回 FALSE 。</p>
</div>
<div class="paragraph">
<p><strong>count</strong>(*) → bigint</p>
</div>
<div class="paragraph">
<p>返回输入行的数量。</p>
</div>
<div class="paragraph">
<p><strong>count</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>返回非空输入值的数量。</p>
</div>
<div class="paragraph">
<p><strong>count_if</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>返回输入值为 TRUE 的数量。 本函数与 count(CASE WHEN x THEN 1 END) 相同。</p>
</div>
<div class="paragraph">
<p><strong>every</strong>(boolean) → boolean</p>
</div>
<div class="paragraph">
<p>bool_and() 的别名。</p>
</div>
<div class="paragraph">
<p><strong>max_by</strong>(x, y) → [与x相同]</p>
</div>
<div class="paragraph">
<p>返回 x 与 y 的最大值进行关联的结果，通过全部输入值进行关联。</p>
</div>
<div class="paragraph">
<p><strong>min_by</strong>(x, y) → [与x相同]</p>
</div>
<div class="paragraph">
<p>返回 x 与 y 的最小值进行关联的结果，通过全部输入值进行关联。</p>
</div>
<div class="paragraph">
<p><strong>max</strong>(x) → [与输入相同]</p>
</div>
<div class="paragraph">
<p>返回全部输入值的最大值。</p>
</div>
<div class="paragraph">
<p><strong>min</strong>(x) → [与输入相同]</p>
</div>
<div class="paragraph">
<p>返回全部输入值的最小值。</p>
</div>
<div class="paragraph">
<p><strong>sum</strong>(x) → [与输入相同]</p>
</div>
<div class="paragraph">
<p>返回全部输入值的和。</p>
</div>
<div class="paragraph">
<p><strong>Map聚合函数</strong></p>
</div>
<div class="paragraph">
<p><strong>map_agg</strong>(key, value) → map&lt;K,V&gt;</p>
</div>
<div class="paragraph">
<p>返回一个由 key / value 键值对构成的map。</p>
</div>
<div class="paragraph">
<p><strong>近似聚合函数</strong></p>
</div>
<div class="paragraph">
<p><strong>approx_distinct</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>返回不重复输入值的近似数量。 本函数给出 count(DISTINCT x) 的近似值。 如果所有输入值都为空则返回0。</p>
</div>
<div class="paragraph">
<p>本函数会产生2.3%的误差， （近似正态）误差分布的标准偏差会覆盖全部数据集。 对于任意指定的输入， 不保证误差上限。</p>
</div>
<div class="paragraph">
<p><strong>approx_distinct</strong>(x, e) → bigint</p>
</div>
<div class="paragraph">
<p>返回不重复输入值的近似数量。 本函数给出 count(DISTINCT x) 的近似值。 如果所有输入值都为空则返回0。</p>
</div>
<div class="paragraph">
<p>本函数会产生不超过 e 的误差， （近似正态）误差分布的标准偏差会覆盖全部数据集。 对于任意指定的输入， 不保证误差上限。 目前的函数实现要求 e 在[0.01150, 0.26000]范围之间。</p>
</div>
<div class="paragraph">
<p><strong>approx_percentile</strong>(x, p) → [与输入相同]</p>
</div>
<div class="paragraph">
<p>按照百分比 p ，返回所有 x 输入值的近似百分比。 p 的值必须在0到1之间， 并且所有输入行必须为常量。</p>
</div>
<div class="paragraph">
<p><strong>approx_percentile</strong>(x, w, p) → [与输入相同]</p>
</div>
<div class="paragraph">
<p>按照百分比 p ，返回所有 x 输入值的近似百分比。 每一项的宽度使用 w 。 至少有一个宽度为整数。 x 设置有效的百分位。 p 的值必须在0到1之间， 并且所有输入行必须为常量。</p>
</div>
<div class="paragraph">
<p><strong>numeric_histogram</strong>(buckets, value, weight) → map&lt;double, double&gt;</p>
</div>
<div class="paragraph">
<p>按照 buckets 桶的数量，为所有的 value 计算近似直方图， 每一项的宽度使用 weight 。 本算法大体上基于：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Yael Ben-Haim and Elad Tom-Tov, "A streaming parallel decision tree algorithm",

J. Machine Learning Research 11 (2010), pp. 849--872.</pre>
</div>
</div>
<div class="paragraph">
<p>buckets 必须是 bigint 。 value 和 weight 必须是数值。</p>
</div>
<div class="paragraph">
<p><strong>numeric_histogram</strong>(buckets, value) → map&lt;double, double&gt;</p>
</div>
<div class="paragraph">
<p>按照 buckets 桶的数量，为所有的 value 计算近似直方图， 本函数与 numeric_histogram() 相同， 只是没有 weight 参数，每一项的宽度都为 1 。</p>
</div>
<div class="paragraph">
<p><strong>统计聚合函数</strong></p>
</div>
<div class="paragraph">
<p><strong>stddev</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>stddev_samp() 的别名。</p>
</div>
<div class="paragraph">
<p><strong>stddev_pop</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回全部输入值的总体标准偏差。</p>
</div>
<div class="paragraph">
<p><strong>stddev_samp</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回全部输入值的样本标准偏差。</p>
</div>
<div class="paragraph">
<p><strong>variance</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>var_samp() 的别名。</p>
</div>
<div class="paragraph">
<p><strong>var_pop</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回全部输入值的总体方差。</p>
</div>
<div class="paragraph">
<p><strong>var_samp</strong>(x) → double</p>
</div>
<div class="paragraph">
<p>返回全部输入值的样本方差。</p>
</div>
</div>
<div class="sect2">
<h3 id="_窗口函数">3.22. 窗口函数</h3>
<div class="paragraph">
<p>窗口函数主要用于在查询结果的所有行之间进行计算。窗口函数运行在HAVING语句之后，但是运行在ORDER BY语句之前。如果想要调用窗口函数，需要使用OVER语句来指定窗口。
一个窗口有3个组成部分（这里就不做汉化了，因为我感觉直接看英文更清楚一点）：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The partition specification, which separates the input rows into different partitions. This is analogous to how the GROUP BY clause separates rows into different groups for aggregate functions.</p>
</li>
<li>
<p>The ordering specification, which determines the order in which input rows will be processed by the window function.</p>
</li>
<li>
<p>The window frame, which specifies a sliding window of rows to be processed by the function for a given row. If the frame is not specified, it defaults to RANGE UNBOUNDED PRECEDING, which is the same as RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW. This frame contains all rows from the start of the partition up to the last peer of the current row.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>例如：下面的查询将orders表中的信息按照每个出纳员营业额的大小进行排序:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT orderkey, clerk, totalprice,
       rank() OVER (PARTITION BY clerk
                    ORDER BY totalprice DESC) AS rnk
FROM orders
ORDER BY clerk, rnk</pre>
</div>
</div>
<div class="paragraph">
<p><strong>聚合函数</strong></p>
</div>
<div class="paragraph">
<p>所有聚合函数可以通过添加OVER 子句用作窗口函数。为当前行的窗口框架中的行上的每一行计算聚合函数。</p>
</div>
<div class="paragraph">
<p>例如，以下查询为每个店员按日期生成订单价格滚动总和：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT clerk, orderdate, orderkey, totalprice,
       sum(totalprice) OVER (PARTITION BY clerk
                             ORDER BY orderdate) AS rolling_sum
FROM orders
ORDER BY clerk, orderdate, orderkey</pre>
</div>
</div>
<div class="paragraph">
<p><strong>排序函数</strong></p>
</div>
<div class="paragraph">
<p><strong>cume_dist</strong>() → bigint</p>
</div>
<div class="paragraph">
<p>返回一组值中的值的累积分布。结果是窗口分区的窗口排序中的行前面或对等的行数除以窗口分区中的总行数。因此，排序中的任何关联值都将计算为相同的分布值。</p>
</div>
<div class="paragraph">
<p><strong>dense_rank</strong>() → bigint</p>
</div>
<div class="paragraph">
<p>返回一组值中的值的等级。这与rank（）类似 ，除了tie值不会在序列中产生空白。</p>
</div>
<div class="paragraph">
<p><strong>ntile</strong>(n) → bigint</p>
</div>
<div class="paragraph">
<p>将每个窗口分区的行划分为n个桶，范围从1到最多n。桶值将不同于1。如果分区中的行数不会均匀地划分为桶数，则剩余值将从第一个桶开始，每个桶分配一个。</p>
</div>
<div class="paragraph">
<p>例如，6行和4个桶，桶值将如下所示：1 1 2 2 3 4</p>
</div>
<div class="paragraph">
<p><strong>percent_rank</strong>() → bigint</p>
</div>
<div class="paragraph">
<p>返回值组中值的百分比排序。结果是（r - 1） / （n - 1）其中r是行的rank（）， n是窗口分区中的总行数。</p>
</div>
<div class="paragraph">
<p><strong>rank</strong>() → bigint</p>
</div>
<div class="paragraph">
<p>返回一组值中的值的等级。排名是一行加上不与该行对等的行之前的行数。因此，排序中的连接值将在序列中产生间隙。为每个窗口分区执行排名。</p>
</div>
<div class="paragraph">
<p><strong>row_number</strong>() → bigint</p>
</div>
<div class="paragraph">
<p>根据窗口分区中的行的顺序，为每行返回一个唯一的，顺序的数字，从一开始。</p>
</div>
<div class="paragraph">
<p><strong>价值函数</strong></p>
</div>
<div class="paragraph">
<p><strong>first_value</strong>(x) → [same as input]</p>
</div>
<div class="paragraph">
<p>返回窗口的第一个值。</p>
</div>
<div class="paragraph">
<p><strong>last_value</strong>(x) → [same as input]</p>
</div>
<div class="paragraph">
<p>返回窗口的最后一个值。</p>
</div>
<div class="paragraph">
<p><strong>nth_value</strong>(x, offset) → [same as input]</p>
</div>
<div class="paragraph">
<p>从窗口开始返回指定偏移处的值。偏移量从1开始。偏移量可以是任何标量表达式。如果偏移量为空或大于窗口中的值的数量，则返回null。偏移量为零或负值是错误的。</p>
</div>
<div class="paragraph">
<p><strong>lead</strong>(x[, offset[, default_value]]) → [same as input]</p>
</div>
<div class="paragraph">
<p>返回窗口中当前行之后的偏移行的值。偏移量从0开始，这是当前行。偏移量可以是任何标量表达式。默认偏移量为1。如果偏移量为空或大于窗口，则返回default_value，否则返回null。</p>
</div>
<div class="paragraph">
<p><strong>lag</strong>(x[, offset[, default_value]]) → [same as input]</p>
</div>
<div class="paragraph">
<p>返回偏移行之前的值，窗口偏移量中的当前行将从0开始，即当前行。偏移量可以是任何标量表达式。默认偏移量为1。如果偏移量为空或大于窗口，则返回default_value，否则返回null。</p>
</div>
</div>
<div class="sect2">
<h3 id="_颜色函数">3.23. 颜色函数</h3>
<div class="paragraph">
<p><strong>bar</strong>(x, width) → varchar</p>
</div>
<div class="paragraph">
<p>使用默认的low_color（红色）和high_color（绿色），在ANSI条形图中呈现单条 。例如，如果25％的x和40的宽度被传递到该功能。将绘制一个10个字符的红色条形，然后绘制30个空格以创建一个40个字符的栏。</p>
</div>
<div class="paragraph">
<p><strong>bar</strong>(x, width, low_color, high_color) → varchar</p>
</div>
<div class="paragraph">
<p>在指定宽度的ANSI条形图中呈现单行 。参数x是[0,1]之间的双重值。落在范围[0,1]之外的x的值将被截断为0或1值。
的low_color和 HIGH_COLOR捕获要用于水平条形图的任一端的颜色。例如，如果x是0.5，宽度 是80，low_color是0xFF0000，而high_color是0x00FF00，这个函数会返回一个40个字符，
这个字符不同于红色（0xFF0000）和黄色（0xFFFF00），80个字符栏的剩余部分将是填充空间。</p>
</div>
<div class="paragraph">
<p>../_images/functions_color_bar.png</p>
</div>
<div class="paragraph">
<p><strong>color</strong>(string) → color</p>
</div>
<div class="paragraph">
<p>返回从格式“＃000”的4个字符串中捕获解码的RGB值的颜色。输入字符串应为包含CSS样式的短rgb字符串或黑色， 红色，绿色，黄色，蓝色，品红色，青色， 白色之一的varchar 。</p>
</div>
<div class="paragraph">
<p><strong>color</strong>(x, low, high, low_color, high_color) → color</p>
</div>
<div class="paragraph">
<p>使用双参数x，low和high返回在low_color和 high_color之间插值的颜色， 以计算一个分数，然后传递给如下所示的 颜色（fraction，low_color，high_color）函数。如果x超出了由low和high定义的范围， 它的值将被截断以适合此范围。</p>
</div>
<div class="paragraph">
<p><strong>color</strong>(x, low_color, high_color) → color</p>
</div>
<div class="paragraph">
<p>根据0到1.0之间的双参数x返回在low_color和 high_color之间插值的颜色。参数x是[0,1]之间的双重值。落在范围[0,1]之外的x的值将被截断为0或1值。</p>
</div>
<div class="paragraph">
<p><strong>render</strong>(x, color) → varchar</p>
</div>
<div class="paragraph">
<p>使用指定的颜色对 x 渲染，使用ANSI标准颜色代码。 x 可以是double、bigint或varchar类型。</p>
</div>
<div class="paragraph">
<p><strong>render</strong>(b) → varchar</p>
</div>
<div class="paragraph">
<p>接受布尔值b，并使用ANSI颜色代码呈现绿色true或红色false。</p>
</div>
<div class="paragraph">
<p><strong>rgb</strong>(red, green, blue) → color</p>
</div>
<div class="paragraph">
<p>返回一个颜色值，捕获以0到255之间的int参数提供的三分量颜色值的RGB值：红色，绿色，蓝色。</p>
</div>
</div>
<div class="sect2">
<h3 id="_数组函数和运算符">3.24. 数组函数和运算符</h3>
<div class="paragraph">
<p><strong>下标运算符: []</strong></p>
</div>
<div class="paragraph">
<p>[] 运算符用于访问数组中的元素，索引从1开始:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT my_array[1] AS first_element</pre>
</div>
</div>
<div class="paragraph">
<p><strong>连接运算符: ||</strong></p>
</div>
<div class="paragraph">
<p>|| 运算符可以将数组与数组进行连接，或者将数组与一个相同类型的元素进行连接:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT ARRAY [1] || ARRAY [2]; =&gt; [1, 2]
SELECT ARRAY [1] || 2; =&gt; [1, 2]
SELECT 2 || ARRAY [1]; =&gt; [2, 1]</pre>
</div>
</div>
<div class="paragraph">
<p><strong>数组函数</strong></p>
</div>
<div class="paragraph">
<p><strong>cardinality</strong>(x) → bigint</p>
</div>
<div class="paragraph">
<p>返回数组 x 的基数（大小）。</p>
</div>
<div class="paragraph">
<p><strong>contains</strong>(x, y) → boolean</p>
</div>
<div class="paragraph">
<p>如果数组 x 中包含元素 y 返回true。</p>
</div>
<div class="paragraph">
<p><strong>array_sort</strong>(x) → array</p>
</div>
<div class="paragraph">
<p>对数组 x 排序并返回结果。 x 中的元素必须是可排序的。</p>
</div>
<div class="paragraph">
<p><strong>concat</strong>(x, y) → array</p>
</div>
<div class="paragraph">
<p>连接数组 x 和 y 。 x 和 y 中的元素类型必须相同。 本函数与连接符(||)功能相同。</p>
</div>
</div>
<div class="sect2">
<h3 id="_map函数和运算符">3.25. Map函数和运算符</h3>
<div class="paragraph">
<p><strong>下标运算符: []</strong></p>
</div>
<div class="paragraph">
<p>[] 运算符用于取出map中指定键的值:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT name_to_age_map['Bob'] AS bob_age</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Map函数</strong></p>
</div>
<div class="paragraph">
<p><strong>map</strong>(array&lt;K&gt;, array&lt;V&gt;) → map&lt;K,V&gt;</p>
</div>
<div class="paragraph">
<p>返回一个由指定的键/值数组构成的map。:</p>
</div>
<div class="paragraph">
<p><strong>SELECT MAP</strong>(ARRAY[1,3], ARRAY[2,4]); &#8658; {1 &#8594; 2, 3 &#8594; 4}</p>
</div>
<div class="paragraph">
<p>cardinality(x) → bigint
返回map x 的基数（大小）。</p>
</div>
<div class="paragraph">
<p><strong>map_keys</strong>(x&lt;K, V&gt;) → array&lt;K&gt;</p>
</div>
<div class="paragraph">
<p>返回map x 中的全部键。</p>
</div>
<div class="paragraph">
<p><strong>map_values</strong>(x&lt;K, V&gt;) → array&lt;V&gt;</p>
</div>
<div class="paragraph">
<p>返回map x 中的全部值。</p>
</div>
<div class="paragraph">
<p>参见 map_agg() 用于创建map集合。
== SQL语言</p>
</div>
</div>
<div class="sect2">
<h3 id="_数据类型">3.26. 数据类型</h3>
<div class="paragraph">
<p>目前Presto支持有限的数据类型。 这些类型可以进行标准的 类型转换 操作。</p>
</div>
<div class="paragraph">
<p><strong>BOOLEAN</strong></p>
</div>
<div class="paragraph">
<p>此类型获取布尔值 <code>true</code> 和 <code>false</code> 。</p>
</div>
<div class="paragraph">
<p><strong>BIGINT</strong></p>
</div>
<div class="paragraph">
<p>64位有符号整数， 最小值为 <code>-2^63</code> ，最大值为 <code>2^63 - 1</code> 。</p>
</div>
<div class="paragraph">
<p><strong>DOUBLE</strong></p>
</div>
<div class="paragraph">
<p>double是64位不精确，可变精度， 基于IEEE标准754的二进制浮点算法的实现。</p>
</div>
<div class="paragraph">
<p><strong>VARCHAR</strong></p>
</div>
<div class="paragraph">
<p>变长字符数据。</p>
</div>
<div class="paragraph">
<p><strong>VARBINARY</strong></p>
</div>
<div class="paragraph">
<p>变长二进制数据。</p>
</div>
<div class="paragraph">
<p><strong>JSON</strong></p>
</div>
<div class="paragraph">
<p>变长json数据。</p>
</div>
<div class="paragraph">
<p><strong>DATE</strong></p>
</div>
<div class="paragraph">
<p>日历日期（年，月，日）。</p>
</div>
<div class="paragraph">
<p>示例： <code>DATE '2001-08-22'</code></p>
</div>
<div class="paragraph">
<p><strong>TIME</strong></p>
</div>
<div class="paragraph">
<p>一天中的时间（小时，分钟，秒，毫秒），无时区。 此类型的值在会话时区进行解析并转换。</p>
</div>
<div class="paragraph">
<p>示例： <code>TIME '01:02:03.456'</code></p>
</div>
<div class="paragraph">
<p><strong>TIME有时区</strong></p>
</div>
<div class="paragraph">
<p>一天中的时间（小时，分钟，秒，毫秒），有时区。 此类型的值使用指定的时区进行转换。</p>
</div>
<div class="paragraph">
<p>示例： TIME <code>'01:02:03.456 America/Los_Angeles'</code></p>
</div>
<div class="paragraph">
<p><strong>TIMESTAMP</strong></p>
</div>
<div class="paragraph">
<p>一天中的某一瞬间，包括日期和时间，无时区。 此类型的值在会话时区进行解析并转换。</p>
</div>
<div class="paragraph">
<p>示例： <code>TIMESTAMP '2001-08-22 03:04:05.321'</code></p>
</div>
<div class="paragraph">
<p><strong>TIMESTAMP有时区</strong></p>
</div>
<div class="paragraph">
<p>一天中的某一瞬间，包括日期和时间，无时区。 此类型的值使用指定的时区进行转换。</p>
</div>
<div class="paragraph">
<p>示例： <code>TIMESTAMP '2001-08-22 03:04:05.321 America/Los_Angeles'</code></p>
</div>
<div class="paragraph">
<p><strong>INTERVAL YEAR TO MONTH</strong></p>
</div>
<div class="paragraph">
<p>年和月的跨度。</p>
</div>
<div class="paragraph">
<p>示例： <code>INTERVAL '3' MONTH</code></p>
</div>
<div class="paragraph">
<p><strong>INTERVAL DAY TO SECOND</strong></p>
</div>
<div class="paragraph">
<p>天、小时、分钟、秒和毫秒的跨度。</p>
</div>
<div class="paragraph">
<p>示例： <code>INTERVAL '2' DAY</code></p>
</div>
<div class="paragraph">
<p><strong>ARRAY</strong></p>
</div>
<div class="paragraph">
<p>给定类型的数组。</p>
</div>
<div class="paragraph">
<p>示例： <code>ARRAY[1, 2, 3]</code></p>
</div>
<div class="paragraph">
<p><strong>MAP</strong></p>
</div>
<div class="paragraph">
<p>给定类型的map。</p>
</div>
<div class="paragraph">
<p><strong>ROW</strong></p>
</div>
<div class="paragraph">
<p>由名字字段组成的结构。可以是任何SQL类型的字段， 使用字段操作符 <code>. </code>访问。</p>
</div>
<div class="paragraph">
<p>示例： <code>my_column.my_field</code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sql语法声明">4. SQL语法声明</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_修改表">4.1. 修改表</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>ALTER TABLE name RENAME TO new_name</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>改变一个现有表的定义。</p>
</div>
<div class="paragraph">
<p><strong>示例</strong></p>
</div>
<div class="paragraph">
<p>将 <code>users</code> 表重命名为 <code>people</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ALTER TABLE users RENAME TO people;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_建表">4.2. 建表</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE TABLE table_name AS query</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>创建一个包含 <strong>查询</strong> 查询结果的新表。</p>
</div>
<div class="paragraph">
<p><strong>示例</strong></p>
</div>
<div class="paragraph">
<p>创建一个新表 <code>orders_by_date</code> ，内容为 <code>orders</code> 的摘要数据:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE TABLE orders_by_date AS
SELECT orderdate, sum(totalprice) AS price
FROM orders
GROUP BY orderdate</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_建视图">4.3. 建视图</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE [ OR REPLACE ] VIEW view_name AS query</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>创建一个 查询 查询的新视图。视图是一个逻辑表， 可以在将来的查询中使用。视图不包含任何数据。 每当视图被其他查询语句使用时， 存储在视图中的查询语句都会被执行。</p>
</div>
<div class="paragraph">
<p>可以使用 <code>OR REPLACE</code> 子句，替换已经存在的视图， 而不是报错。</p>
</div>
<div class="paragraph">
<p><strong>示例</strong></p>
</div>
<div class="paragraph">
<p>根据 <code>orders</code> 表，创建一个简单的视图 <code>test</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE VIEW test AS
SELECT orderkey, orderstatus, totalprice / 2 AS half
FROM orders</pre>
</div>
</div>
<div class="paragraph">
<p>创建一个视图 <code>orders_by_date</code> ，内容为 <code>orders</code> 的摘要数据:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE VIEW orders_by_date AS
SELECT orderdate, sum(totalprice) AS price
FROM orders
GROUP BY orderdate</pre>
</div>
</div>
<div class="paragraph">
<p>创建一个视图替换现有视图:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>CREATE OR REPLACE VIEW test AS
SELECT orderkey, orderstatus, totalprice / 4 AS quarter
FROM orders</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_查看表结构">4.4. 查看表结构</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>DESCRIBE table_name</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>DESCRIBE 是 <strong>显示列</strong> 的别名。</p>
</div>
<div class="paragraph">
<p><strong>示例</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>presto:default&gt; describe airline_origin_destination;
     Column      |  Type   | Null | Partition Key
-----------------+---------+------+---------------
 itinid          | varchar | true | false
 mktid           | varchar | true | false
 seqnum          | varchar | true | false
 coupons         | varchar | true | false
 year            | varchar | true | false
 quarter         | varchar | true | false
 origin          | varchar | true | false
 originaptind    | varchar | true | false
 origincitynum   | varchar | true | false
(9 rows)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_删表">4.5. 删表</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>DROP TABLE table_name</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>删除一个已经存在的表</p>
</div>
<div class="paragraph">
<p><strong>示例</strong></p>
</div>
<div class="paragraph">
<p>删除 <code>orders_by_date</code> 表:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>DROP TABLE orders_by_date</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_删视图">4.6. 删视图</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>DROP VIEW view_name</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>删除一个已经存在的视图。</p>
</div>
<div class="paragraph">
<p><strong>示例</strong></p>
</div>
<div class="paragraph">
<p>删除 <code>orders_by_date</code> 视图:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>DROP VIEW orders_by_date</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_解释">4.7. 解释</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>EXPLAIN [ ( option [, ...] ) ] statement

option可以为以下之一：

    FORMAT { TEXT | GRAPHVIZ }
    TYPE { LOGICAL | DISTRIBUTED }</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>显示一个语句的逻辑或分布式执行方案。</p>
</div>
<div class="paragraph">
<p><strong>示例</strong></p>
</div>
<div class="paragraph">
<p>逻辑方案：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>presto:tiny&gt; EXPLAIN SELECT regionkey, count(*) FROM nation GROUP BY 1;
                                             Query Plan
----------------------------------------------------------------------------------------------------------
- Output[regionkey, _col1] =&gt; [regionkey:bigint, count:bigint]
         _col1 := count
    - Exchange[GATHER] =&gt; regionkey:bigint, count:bigint
         - Aggregate(FINAL)[regionkey] =&gt; [regionkey:bigint, count:bigint]
                 count := "count"("count_8")
            - Exchange[REPARTITION] =&gt; regionkey:bigint, count_8:bigint
                 - Aggregate(PARTIAL)[regionkey] =&gt; [regionkey:bigint, count_8:bigint]
                         count_8 := "count"(*)
                    - TableScan[tpch:tpch:nation:sf0.01, original constraint=true] =&gt; [regionkey:bigint]
                             regionkey := tpch:tpch:regionkey:2</pre>
</div>
</div>
<div class="paragraph">
<p>分布式方案：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>presto:tiny&gt; EXPLAIN (TYPE DISTRIBUTED) SELECT regionkey, count(*) FROM nation GROUP BY 1;
                                             Query Plan
----------------------------------------------------------------------------------------------
Fragment 2 [SINGLE]
     Output layout: [regionkey, count]
    - Output[regionkey, _col1] =&gt; [regionkey:bigint, count:bigint]
             _col1 := count
        - RemoteSource[1] =&gt; [regionkey:bigint, count:bigint]

Fragment 1 [FIXED]
     Output layout: [regionkey, count]
    - Aggregate(FINAL)[regionkey] =&gt; [regionkey:bigint, count:bigint]
             count := "count"("count_8")
        - RemoteSource[0] =&gt; [regionkey:bigint, count_8:bigint]

Fragment 0 [SOURCE]
    Output layout: [regionkey, count_8]
    Output partitioning: [regionkey]
    - Aggregate(PARTIAL)[regionkey] =&gt; [regionkey:bigint, count_8:bigint]
             count_8 := "count"(*)
        - TableScan[tpch:tpch:nation:sf0.01, original constraint=true] =&gt; [regionkey:bigint]
                 regionkey := tpch:tpch:regionkey:2</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_插入">4.8. 插入</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>INSERT INTO table_name query</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>向表中插入行。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
目前尚不支持指定列名。 因此， 查询语句中的列与要插入的表中的列必须完全匹配。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>示例</strong></p>
</div>
<div class="paragraph">
<p>将 <code>new_orders</code> 表中的数据插入 <code>orders</code> 表:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>INSERT INTO orders
SELECT * FROM new_orders;</pre>
</div>
</div>
<div class="paragraph">
<p>向 <code>cities</code> 表插入一行数据:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>INSERT INTO cities VALUES (1, 'San Francisco');</pre>
</div>
</div>
<div class="paragraph">
<p>向 <code>cities</code> 表插入多行数据:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>INSERT INTO cities VALUES (2, 'San Jose'), (3, 'Oakland');</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_重置会话">4.9. 重置会话</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>RESET SESSION name
RESET SESSION catalog.name</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>将会话的属性值重置为默认值。</p>
</div>
<div class="paragraph">
<p><strong>示例</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>RESET SESSION optimize_hash_generation;
RESET SESSION hive.optimized_reader_enabled;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_查询">4.10. 查询</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>[ WITH with_query [, ...] ]
SELECT [ ALL | DISTINCT ] select_expr [, ...]
[ FROM from_item [, ...] ]
[ WHERE condition ]
[ GROUP BY expression [, ...] ]
[ HAVING condition]
[ UNION [ ALL | DISTINCT ] select ]
[ ORDER BY expression [ ASC | DESC ] [, ...] ]
[ LIMIT count ]</pre>
</div>
</div>
<div class="paragraph">
<p><code>from_item</code> 为以下之一</p>
</div>
<div class="listingblock">
<div class="content">
<pre>table_name [ [ AS ] alias [ ( column_alias [, ...] ) ] ]</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>from_item join_type from_item [ ON join_condition | USING ( join_column [, ...] ) ]</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>从0或多个表获取数据行</p>
</div>
<div class="paragraph">
<p><strong>GROUP BY子句</strong></p>
</div>
<div class="paragraph">
<p><code>GROUP BY</code> 子句对 <code>SELECT</code> 语句的输出进行分组， 分组中是匹配值的数据行。 <code>Group BY</code> 子句支持任意表达式， 包括指定列名或列序号（从1开始）。</p>
</div>
<div class="paragraph">
<p>以下查询是等价的。 他们都对 <code>nationkey</code> 列进行分组， 第一个查询使用列序号， 第二个查询使用列名:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT count(*), nationkey FROM customer GROUP BY 2;

SELECT count(*), nationkey FROM customer GROUP BY nationkey;</pre>
</div>
</div>
<div class="paragraph">
<p>在查询语句中没有指定列名的情况下， <code>GROUP BY</code> 子句也可以将输出进行分组。 例如，以下查询使用列 <code>mktsegment</code> 进行分组， 统计出 <code>customer</code> 表的行数:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT count(*) FROM customer GROUP BY mktsegment;</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre> _col0
-------
 29968
 30142
 30189
 29949
 29752
(5 rows)</pre>
</div>
</div>
<div class="paragraph">
<p>在 <code>SELECT</code> 语句中使用 <code>GROUP BY</code> 子句时， 进行分组的列要么是聚会函数， 要么是 <code>GROUP BY</code> 子句中的列。</p>
</div>
<div class="paragraph">
<p><strong>HAVING子句</strong></p>
</div>
<div class="paragraph">
<p><code>HAVING</code> 子句与聚合函数以及 <code>GROUP BY</code> 子句共同使用， 用来控制选择分组。 <code>HAVING</code> 子句去掉不满足条件的分组。 在分组和聚合计算完成后，<code>HAVING</code> 对分组进行过滤。</p>
</div>
<div class="paragraph">
<p>以下示例查询 <code>customer</code> 表，并进行分组， 查出账户余额大于指定值的记录:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT count(*), mktsegment, nationkey,
       CAST(sum(acctbal) AS bigint) AS totalbal
FROM customer
GROUP BY mktsegment, nationkey
HAVING sum(acctbal) &gt; 5700000
ORDER BY totalbal DESC;</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre> _col0 | mktsegment | nationkey | totalbal
-------+------------+-----------+----------
  1272 | AUTOMOBILE |        19 |  5856939
  1253 | FURNITURE  |        14 |  5794887
  1248 | FURNITURE  |         9 |  5784628
  1243 | FURNITURE  |        12 |  5757371
  1231 | HOUSEHOLD  |         3 |  5753216
  1251 | MACHINERY  |         2 |  5719140
  1247 | FURNITURE  |         8 |  5701952
(7 rows)</pre>
</div>
</div>
<div class="paragraph">
<p><strong>UNION子句</strong></p>
</div>
<div class="paragraph">
<p><code>UNION</code> 子句用于将多个查询语句的结果合并为一个结果集:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>query UNION [ALL | DISTINCT] query</pre>
</div>
</div>
<div class="paragraph">
<p>参数 <code>ALL</code> 或 <code>DISTINCT</code> 控制最终结果集包含哪些行。 如果指定参数 <code>ALL</code> ，则包含全部行，即使行完全相同。
如果指定参数 <code>DISTINCT</code> ， 则合并结果集，结果集只有唯一不重复的行。 如果不指定参数，执行时默认使用 <code>DISTINCT</code> 。</p>
</div>
<div class="paragraph">
<p>以下示例可能是最简单的 UNION 子句之一。 以下查询将返回值 13 与第二个查询的返回值 42 进行结果集连接:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT 13
UNION
SELECT 42;</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre> _col0
-------
    13
    42
(2 rows)</pre>
</div>
</div>
<div class="paragraph">
<p>多个union从左向右执行， 除非用括号明确指定顺序。</p>
</div>
<div class="paragraph">
<p><strong>ORDER BY子句</strong></p>
</div>
<div class="paragraph">
<p><code>ORDER BY</code> 子句按照一个或多个输出表达式对结果集排序：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ORDER BY expression [ ASC | DESC ] [ NULLS { FIRST | LAST } ] [, ...]</pre>
</div>
</div>
<div class="paragraph">
<p>每个表达式由列名或列序号（从1开始）组成。 <code>ORDER BY</code> 子句作为查询的最后一步， 在 <code>GROUP BY</code> 和 <code>HAVING</code> 子句之后。</p>
</div>
<div class="paragraph">
<p><strong>LIMIT子句</strong></p>
</div>
<div class="paragraph">
<p><code>LIMIT</code> 子句限制结果集的行数。 以下示例为查询一个大表， limit子句限制它只输出5行（因为查询没有 <code>ORDER BY</code> ， 所以随意返回几行）:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT orderdate FROM orders LIMIT 5;</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre> o_orderdate
-------------
 1996-04-14
 1992-01-15
 1995-02-01
 1995-11-12
 1992-04-26
(5 rows)</pre>
</div>
</div>
<div class="paragraph">
<p><strong>TABLESAMPLE</strong></p>
</div>
<div class="paragraph">
<p>有多种抽样方法:</p>
</div>
<div class="paragraph">
<p><strong>BERNOULLI</strong></p>
</div>
<div class="paragraph">
<p>查出的每行记录都源于表样本，使用样本百分比概率。 当使用Bernoulli方法对表进行抽样时， 会扫描表的所有物理块， 并跳过某些行。 （基于样本百分比与运行时随机计算之间的比较）</p>
</div>
<div class="paragraph">
<p>结果中每行记录的概率都是独立的。 这不会减少从磁盘读取抽样表所需要的时间。 如果对抽样输出做处理， 它可能对整体查询时间有影响。</p>
</div>
<div class="paragraph">
<p><strong>SYSTEM</strong></p>
</div>
<div class="paragraph">
<p>这种抽样方法将表划分为逻辑数据段， 并按此粒度进行抽样。 这种抽样方法要么从特定数据段查询全部行， 要么跳过它。 （基于样本百分比与运行时随机计算之间的比较）</p>
</div>
<div class="paragraph">
<p>系统抽样选取哪些行，取决于使用哪种连接器。 例如，使用Hive， 它取决于HDFS上的数据是怎样存储的。 这种方法无法保证独立抽样概率。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
这两种方法都不能确定返回行数的范围。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>示例:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT *
FROM users TABLESAMPLE BERNOULLI (50);

SELECT *
FROM users TABLESAMPLE SYSTEM (75);</pre>
</div>
</div>
<div class="paragraph">
<p>通过join进行抽样:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT o.*, i.*
FROM orders o TABLESAMPLE SYSTEM (10)
JOIN lineitem i TABLESAMPLE BERNOULLI (40)
  ON o.orderkey = i.orderkey;</pre>
</div>
</div>
<div class="paragraph">
<p><strong>UNNEST</strong></p>
</div>
<div class="paragraph">
<p><code>UNNEST</code> 用于展开 数组类型 或 map类型 的子查询。 数组展开为单列，map展开为双列（键，值）。 <code>UNNEST</code> 可以使用多个参数，它们展开为多列， 行数与最大的基础参数一样（其他列填空）。
 <code>UNNEST</code> 通常与 <code>JOIN</code> 一起使用 也可以引用join左侧的关系列。</p>
</div>
<div class="paragraph">
<p>使用单列:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT student, score
FROM tests
CROSS JOIN UNNEST(scores) AS t (score);</pre>
</div>
</div>
<div class="paragraph">
<p>使用多列:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT numbers, animals, n, a
FROM (
  VALUES
    (ARRAY[2, 5], ARRAY['dog', 'cat', 'bird']),
    (ARRAY[7, 8, 9], ARRAY['cow', 'pig'])
) AS x (numbers, animals)
CROSS JOIN UNNEST(numbers, animals) AS t (n, a);</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>  numbers  |     animals      |  n   |  a
-----------+------------------+------+------
 [2, 5]    | [dog, cat, bird] |    2 | dog
 [2, 5]    | [dog, cat, bird] |    5 | cat
 [2, 5]    | [dog, cat, bird] | NULL | bird
 [7, 8, 9] | [cow, pig]       |    7 | cow
 [7, 8, 9] | [cow, pig]       |    8 | pig
 [7, 8, 9] | [cow, pig]       |    9 | NULL
(6 rows)</pre>
</div>
</div>
<div class="paragraph">
<p>WITH ORDINALITY clause:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT numbers, n, a
FROM (
  VALUES
    (ARRAY[2, 5]),
    (ARRAY[7, 8, 9])
) AS x (numbers)
CROSS JOIN UNNEST(numbers) WITH ORDINALITY AS t (n, a);</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>  numbers  | n | a
-----------+---+---
 [2, 5]    | 2 | 1
 [2, 5]    | 5 | 2
 [7, 8, 9] | 7 | 1
 [7, 8, 9] | 8 | 2
 [7, 8, 9] | 9 | 3
(5 rows)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_设置会话">4.11. 设置会话</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>SET SESSION name = 'value'
SET SESSION catalog.name = 'value'</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>设置会话属性值。</p>
</div>
<div class="paragraph">
<p><strong>示例</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>SET SESSION optimize_hash_generation = 'true';
SET SESSION hive.optimized_reader_enabled = 'true';</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_显示catalog">4.12. 显示CATALOG</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW CATALOGS</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>列出可用的catalog。</p>
</div>
</div>
<div class="sect2">
<h3 id="_显示列">4.13. 显示列</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW COLUMNS FROM table</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>列出 表 中的列及其数据类型和其他属性。</p>
</div>
</div>
<div class="sect2">
<h3 id="_显示函数">4.14. 显示函数</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW FUNCTIONS</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>列出全部可用于查询的函数</p>
</div>
</div>
<div class="sect2">
<h3 id="_显示分区">4.15. 显示分区</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW PARTITIONS FROM table [ WHERE ... ] [ ORDER BY ... ] [ LIMIT ... ]</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>列出 <code>表</code> 中的分区，可以使用 <code>WHERE</code> 子句进行过滤， 使用 <code>ORDER BY</code> 子句排序，使用 <code>LIMIT</code> 子句限制。 这些子句与他们的在 <strong>查询</strong> 中的工作方式相同。</p>
</div>
<div class="paragraph">
<p><strong>示例</strong></p>
</div>
<div class="paragraph">
<p>列出 <code>orders</code> 表的全部分区:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW PARTITIONS FROM orders;</pre>
</div>
</div>
<div class="paragraph">
<p>列出 <code>orders</code> 表中的全部分区，起始时间为 <code>2013</code> 年， 并按日期倒序排序:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW PARTITIONS FROM orders WHERE ds &gt;= '2013-01-01' ORDER BY ds DESC;</pre>
</div>
</div>
<div class="paragraph">
<p>列出 <code>orders</code> 表中最新的分区:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW PARTITIONS FROM orders ORDER BY ds DESC LIMIT 10;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_显示库">4.16. 显示库</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW SCHEMAS [ FROM catalog ]</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>列出 <code>catalog</code> 或当前catalog中的库。</p>
</div>
<div class="paragraph">
<p><strong>示例</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>presto:default&gt; show schemas;
       Schema
--------------------
 information_schema
 jmx
 sys
(3 rows)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_显示会话">4.17. 显示会话</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW SESSION</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>列出当前会话属性。</p>
</div>
</div>
<div class="sect2">
<h3 id="_显示表">4.18. 显示表</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>SHOW TABLES [ FROM schema ] [ LIKE pattern ]</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>列出指定 库 或当前库中的表。 可以用 <code>LIKE</code> 子句控制列出的表名。</p>
</div>
</div>
<div class="sect2">
<h3 id="_使用">4.19. 使用</h3>
<div class="paragraph">
<p><strong>概述</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>USE catalog.schema
USE schema</pre>
</div>
</div>
<div class="paragraph">
<p><strong>说明</strong></p>
</div>
<div class="paragraph">
<p>更新会话，以便使用指定的catalog和schema。 如果不指定catalog， schema将关联到当前的catalog。</p>
</div>
<div class="paragraph">
<p><strong>示例</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>USE hive.finance;
USE information_schema;</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_迁移">5. 迁移</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_从hive迁移">5.1. 从Hive迁移</h3>
<div class="paragraph">
<p>Presto使用ANSI SQL的语法和语义，而Hive使用的是一种名为HiveQL的类似SQL的语言，它模仿MySQL（与ANSI SQL有许多差异）。</p>
</div>
<div class="paragraph">
<p>使用下标访问动态数组索引来替代udf</p>
</div>
<div class="paragraph">
<p>SQL中的下标运算符支持完整的表达式，与Hive（它只支持常量）不同。因此，你可以像这样写查询语句:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT my_array[CARDINALITY(my_array)] as last_element
FROM ...</pre>
</div>
</div>
<div class="paragraph">
<p><strong>避免越界访问数组</strong></p>
</div>
<div class="paragraph">
<p>越界访问数组元素会导致发生异常。你可以像下面这样，使用 <code>if</code> 来避免:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT IF(CARDINALITY(my_array) &gt;= 3, my_array[3], NULL)
FROM ...</pre>
</div>
</div>
<div class="paragraph">
<p><strong>使用ANSI SQL语法操作数组</strong></p>
</div>
<div class="paragraph">
<p>数组索引从1开始，而不是0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT my_array[1] AS first_element
FROM ...</pre>
</div>
</div>
<div class="paragraph">
<p>使用ANSI语法建立数组:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT ARRAY[1, 2, 3] AS my_array</pre>
</div>
</div>
<div class="paragraph">
<p>使用ANSI SQL语法操作标识符和字符串</p>
</div>
<div class="paragraph">
<p>字符串用单引号括起来，标识符用双引号括起来，而不是反引号:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT name AS "User Name"
FROM "7day_active"
WHERE name = 'foo'</pre>
</div>
</div>
<div class="paragraph">
<p><strong>引用以数字打头的标示符</strong></p>
</div>
<div class="paragraph">
<p>以数字开头的标识符在ANSI SQL中不合法，必须用双引号括起来:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT *
FROM "7day_active"</pre>
</div>
</div>
<div class="paragraph">
<p><strong>使用标准的字符串连接运算符</strong></p>
</div>
<div class="paragraph">
<p>使用ANSI SQL字符串连接运算符:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT a || b || c
FROM ...</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">使用标准的类型去转换目标</dt>
<dd>
<p>以下标准类型支持 转换 目标:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT
  CAST(x AS varchar)
, CAST(x AS bigint)
, CAST(x AS double)
, CAST(x AS boolean)
FROM ...</pre>
</div>
</div>
<div class="paragraph">
<p>特别注意，使用 <code>VARCHAR</code> 而不是 <code>STRING</code> 。</p>
</div>
<div class="paragraph">
<p><strong>在整数除法中使用转换</strong></p>
</div>
<div class="paragraph">
<p>Presto按照标准的方法进行整数除法运算。例如， <code>7</code> 除以 <code>2</code> 的结果是 <code>3</code> 而不是 <code>3.5</code> 。 对两个整数进行浮点除法运算，需要将其中的一个转为double类型:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT CAST(5 AS DOUBLE) / 2</pre>
</div>
</div>
<div class="paragraph">
<p><strong>在复杂的表达式或查询中使用WITH</strong></p>
</div>
<div class="paragraph">
<p>当你要重复使用一个复杂的表达式做过滤器时，可以使用内联子查询或使用 <code>WITH</code> 子句:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>WITH a AS (
  SELECT substr(name, 1, 3) x
  FROM ...
)
SELECT *
FROM a
WHERE x = 'foo'</pre>
</div>
</div>
<div class="paragraph">
<p><strong>使用UNNEST展开数组和map</strong></p>
</div>
<div class="paragraph">
<p>Presto支持使用 UNNEST 展开数组和map。 使用 UNNEST 代替 LATERAL VIEW explode() 。</p>
</div>
<div class="paragraph">
<p>Hive查询:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT student, score
FROM tests
LATERAL VIEW explode(scores) t AS score;</pre>
</div>
</div>
<div class="paragraph">
<p>Presto查询:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT student, score
FROM tests
CROSS JOIN UNNEST(scores) AS t (score);</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Outer Join的差异</strong></p>
</div>
<div class="paragraph">
<p>按照ANSI SQL规则，Presto认为 整个 <code>ON</code> 语句的作用就是判定左边的表中的一行是否要和右边的表中的行进行关联操作。
在 <code>LEFT JOIN</code> 中，左边表中的所有行都会显示在最终的查询结果中；在 <code>RIGHT JOIN</code> 操作中是相反的。相反，Hive 首先 在 <code>ON</code> 子句中使用常量过滤， 然后 执行join。
当使用 <code>ON</code> 子句关联外部表时，这会使结果会产生非常大的差别。</p>
</div>
<div class="paragraph">
<p>当你要将Hive的 <code>OUTER_JOIN</code> 查询转为Presto查询时，注意Hive认为 <code>ON</code> 子句是 <code>WHERE</code> 子句的一部分。因此为了在Presto中得到同样的效果，你需要将 <code>ON</code> 子句放到 <code>WHERE</code> 子句中。</p>
</div>
<div class="paragraph">
<p>Hive查询:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT a.id, b.userid
FROM a
LEFT JOIN b
ON a.id = b.id AND a.ds = '2013-11-11'</pre>
</div>
</div>
<div class="paragraph">
<p>Presto查询:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SELECT a.id, b.userid
FROM a
LEFT JOIN b
ON a.id = b.id
WHERE a.ds = '2013-11-11'</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_开发者指南">6. 开发者指南</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_spi概述">6.1. SPI概述</h3>
<div class="paragraph">
<p>如果你想要开发一个新的Presto的插件，那么你必须实现SPI定义的接口和方法。</p>
</div>
<div class="paragraph">
<p>插件能够提供connector（Presto中所有查询的数据都是通过connector提供的）。 即使你的数据源中没有任何基础数据表，但是只要你的数据源实现了Presto中要求的API，你照样可以从你自己定义的数据源中进行查询。</p>
</div>
<div class="paragraph">
<p>这一章我们将会了解Presto SPI中常用的一些服务接口,以及如果调整这些API来适应你自己的数据源</p>
</div>
<div class="paragraph">
<p><strong>代码</strong></p>
</div>
<div class="paragraph">
<p>Presto的SPI源码在Presto source文件夹的 <code>presto-spi</code> 目录下：</p>
</div>
<div class="paragraph">
<p>元数据插件</p>
</div>
<div class="paragraph">
<p>每个插件都代表一个入口点：<code>Plugin</code> 接口的实现。
插件的类名通过标准 <code>ServiceLoader</code> 接口提供给给Presto：在classpath中必须包含一个位于 <code>META-INF/services</code> 目录下的名为 <code>com.facebook.presto.spi.Plugin</code> 的源文件。
这个文件的内容其实只有一行，这一行就是plugin插件的类名，如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>com.facebook.presto.example.ExamplePlugin</pre>
</div>
</div>
<div class="paragraph">
<p><strong>插件</strong></p>
</div>
<div class="paragraph">
<p><code>Plugin</code> 接口是新手学习使用Presto SPI的一个很好的入手点。当Presto想要创建某个catalog对应的connector的时候，首先会调用 <code>getServices()</code> 方法获得一个 <code>ConnectorFactory</code> 对象。</p>
</div>
<div class="paragraph">
<p><strong>ConnectorFactory</strong></p>
</div>
<div class="paragraph">
<p><code>ConnectorFactory</code> 的实例是Presto通过调用Plugin中的 <code>getServices()</code> 方法获得的。<code>ConnectorFactory</code> 实例就代表一个类型为ConnectorFactory的服务。<code>connector</code> 实例就是通过ConnectorFactory创建的。
ConnectorFactory使用单例模式创建Connector的实例，可以返回以下几种类型：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ConnectorMetadata</p>
</li>
<li>
<p>ConnectorSplitManager</p>
</li>
<li>
<p>ConnectorHandleResolver</p>
</li>
<li>
<p>ConnectorRecordSetProvider</p>
</li>
<li>
<p>ConnectorMetdata</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ConnectorMetadata中有大量的方法，Presto就是使用ConnectorMetadata中的这些方法对一个特定的data source进行如下操作：遍历所有的schema；遍历所有的table；遍历所有的列；遍历其他的元数据信息</p>
</div>
<div class="paragraph">
<p>这个接口中的方法太多了，以至于文档中没有全部罗列出来。如果你对这个接口的实现类感兴趣，你可以去看下 <mark>Example HTTP Connector</mark> 和Cassandra connector的实现。
如果你的基础数据源支持schema，table和column，那么这个接口是很容易实现的。
如果你打算使用非传统的数据库[英文原话：If you are attempting to adapt something that is not a relational database (as the Example HTTP connector does)，
不知道翻译的对不对，<sup>-</sup>],（就像Example HTTP Connector那样），那么你的实现中需要考虑怎样将的你的数据源映射到Presto的schema，table和列。</p>
</div>
<div class="paragraph">
<p><strong>ConnectorSplitManger</strong></p>
</div>
<div class="paragraph">
<p>ConnectorSplitManger的作用就是将一个表中的数据分成独立的数据分片，这些数据分片会被分发到各个worker去处理。
例如，Hive connector列出每个Hive分区中的文件，并且针对于每个文件创建一个或者多个分片。对于那些没有分区数据的数据源，一个比较好的处理策略就是将一个table中的数据作为一个split处理。
这也是Example HTTP connector使用的处理策略。</p>
</div>
<div class="paragraph">
<p><strong>ConnectorRecordSetProvider</strong></p>
</div>
<div class="paragraph">
<p>获得了Split数据和表的Column信息之后，ConnectorRecordSetProvider就会针对Split和Columnin信息创建一个RecordCursor对象，Presto就是使用RecordCoursor来读取每一行中对应的Column中的值的。</p>
</div>
</div>
<div class="sect2">
<h3 id="_http连接器示例">6.2. HTTP连接器示例</h3>
<div class="paragraph">
<p>Example HTTP connector 的作用很简单：读取通过HTTP协议传递过来的以逗号分隔的数据。 例如，如果你有大量的CSV格式的数据，那么你可以使用Example HTTP Connector来进行这些数据的处理。
通过Example HTTP Connector你可以方便的通过SQL查询来处理这些数据。</p>
</div>
<div class="paragraph">
<p><strong>代码</strong></p>
</div>
<div class="paragraph">
<p>Example HTTP Connector的源码可以在Presto源代码根目录下的presto-example-http目录下找到。</p>
</div>
<div class="paragraph">
<p><strong>Maven工程</strong></p>
</div>
<div class="paragraph">
<p>Example HTTP connector通过位于plugin工程根目录下的pom.xml文件来使用Maven进行编译。 Example HTTP connector可以通过Maven进行编译。其Maven配置文件是位于plugin根目录的pom.xml</p>
</div>
<div class="paragraph">
<p><strong>工程依赖</strong></p>
</div>
<div class="paragraph">
<p>Plugins依赖于Presto的SPI：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;dependency&gt;
    &lt;groupId&gt;com.facebook.presto&lt;/groupId&gt;
    &lt;artifactId&gt;presto-spi&lt;/artifactId&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>上面的scope之所以是provided是因为Presto已经提供运行时所使用的类，所以plugin不应该再将这些类重新编译打包。</p>
</div>
<div class="paragraph">
<p>除了上面的依赖之外，还需要Presto提供的一些其他依赖，例如：javax.inject和Jackson。 Jackson主要用于序列化处理，因此plugin必须使用Presto提供的版本。</p>
</div>
<div class="paragraph">
<p>根据自定义的plugin具体实现过程中使用到的类来添加其他依赖。Plugin使用独立的类加载器进行加载，这样plugin和其他的类是隔离的，因此plugin可以使用与Presto内部使用的类库不同版本的类库。</p>
</div>
<div class="paragraph">
<p><strong>Plugin实现类</strong></p>
</div>
<div class="paragraph">
<p>Example HTTP connector与其他的plugin相比，其实现非常的简单。在其实现中大部分的方法都在处理各种配置项，唯一一个关键的方法如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Override
public &lt;T&gt; List&lt;T&gt; getServices(Class&lt;T&gt; type)
{
    if (type == ConnectorFactory.class) {
        return ImmutableList.of(type.cast(new ExampleConnectorFactory(getOptionalConfig())));
    }
    return ImmutableList.of();
}</pre>
</div>
</div>
<div class="paragraph">
<p>ImmutableList 是Guava的一个工具类。</p>
</div>
<div class="paragraph">
<p>和所有的plugin一样，Example HTTP connector重写了getServices()方法，并且针对于请求ConnectorFactory类型服务的请求返回一个ExampleConnectorFactory实例。</p>
</div>
<div class="paragraph">
<p><strong>ConnectorFactory Implementation</strong></p>
</div>
<div class="paragraph">
<p>在Presto中，Connetor是通过ConnectorFactory创建的。并且Presto就是使用Connetor建立与各种数据源之间的连接的。</p>
</div>
<div class="paragraph">
<p>在ExampleConnectorFactory实现中，要做的第一件事情就是为connector指定名称。这个名称的作用与在Presto的配置文件中指定connector名称的作用是一样的。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@Override
public String getName()
{
    return "example-http";
}</pre>
</div>
</div>
<div class="paragraph">
<p>connector factory中的实际工作实在create()方法中完成的。 在ExampleConnectorFactory类中,create()方法配置相应的connector，然后使用Guice创建相应的对象。
下面就是一个没有参数验证和异常处理的create方法的简单实现：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>// A plugin is not required to use Guice; it is just very convenient
Bootstrap app = new Bootstrap(
        new JsonModule(),
        new ExampleModule(connectorId));

Injector injector = app
        .strictConfig()
        .doNotInitializeLogging()
        .setRequiredConfigurationProperties(requiredConfig)
        .setOptionalConfigurationProperties(optionalConfig)
        .initialize();

return injector.getInstance(ExampleConnector.class);</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Connector: ExampleConnector</strong></p>
</div>
<div class="paragraph">
<p>Presto通过使用该类来获得connector提供的各种服务。</p>
</div>
<div class="paragraph">
<p><strong>Metadata: ExampleMetadata</strong></p>
</div>
<div class="paragraph">
<p>这个类的主要作用就是：获得table names，table metadata，column names，column metadata和connector提供的相关的schema信息。Presto也会使用ConnectorMetadata确保connector可以识别和处理给定的表名</p>
</div>
<div class="paragraph">
<p>该ExampleMetadata执行代表许多这些调用的 ExampleClient，实现多的连接器的核心功能的类。</p>
</div>
<div class="paragraph">
<p><strong>Split Manager: ExampleSplitManager</strong></p>
</div>
<div class="paragraph">
<p>split manager将一个表中的数据切分成一个或者多个split，并且分发给各个worker进行处理。在ExampleHTTPConnector中，每个表中包含一个或者多个指向实际数据的URI。
ExampleSplitManager会针对于每个URI创建一个Split。</p>
</div>
<div class="paragraph">
<p><strong>Record Set Provider: ExampleRecordSetProvider</strong></p>
</div>
<div class="paragraph">
<p>record set provider 会创建一个record set，然后Record Set会创建一个Record cursor，而Record Cursor又会去获得实际的数据，最终返回给Presto。
ExampleRecordCursor通过HTTP从一个指定的URI中读取数据。每一行数据都被逗号分成相应的列，然后返回给Presto。</p>
</div>
</div>
<div class="sect2">
<h3 id="_类型系统">6.3. 类型系统</h3>
<div class="paragraph">
<p>Presto中的Type接口用于实现SQL语言中的类型。Presto拥有许多内置类型，如VarcharType和BigintType。一个插件可以通过从getServices（）返回来提供新的类型。
以下是类型界面的高级概述，有关详细信息，请参阅JavaDocs for Type。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>本机容器类型：</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>所有类型都定义了getJavaType（）方法，通常称为“本机容器类型”。这是用于在执行期间保存值并将其存储在块中的Java类型。例如，这是用于实现生成或使用此类型的函数的Java代码中使用的类型。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>本地编码：</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>其本机容器类型形式的值的解释由其类型定义 。对于某些类型，例如BigintType，它匹配本机容器类型（64位2的补码）的Java解释。然而，对于诸如TimestampWithTimeZoneType之类的其他类型，它们对其本机容器类型也使用long，存储在long中的值是8位二进制值，它结合了从unix纪元开始的时区和毫秒。特别地，这意味着您无法比较两个本机值，并希望获得有意义的结果，而无需了解本机编码。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>类型签名：</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>类型的签名定义其身份，并且还编码关于类型的一些一般信息，例如其类型参数（如果它是参数的）及其字面参数。文字参数用于类似于 VARCHAR（10）。</p>
</div>
</div>
<div class="sect2">
<h3 id="_函数">6.4. 函数</h3>
<div class="paragraph">
<p>函数框架用于实现SQL函数。Presto包含许多内置函数，并且内部插件（对presto-main有依赖性的插件）可以通过从getServices（）返回一个FunctionFactory来提供新的功能 。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@ScalarFunction("is_null")
@Description("Returns TRUE if the argument is NULL")
@SqlType(StandardTypes.Boolean)
public static boolean isNull(@Nullable @SqlType(StandardTypes.VARCHAR) Slice string)
{
    return (string == null);
}</pre>
</div>
</div>
<div class="paragraph">
<p>上面的代码实现了一个新的函数is_null，它接受一个VARCHAR 参数，并返回一个BOOLEAN，指示该参数是否为NULL。请注意，该函数的参数类型为Slice。
VARCHAR使用 Slice，它本质上是byte []的包装器，而不是String 的本机容器类型。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@SqlType：</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>该@SqlType注解用于声明的返回类型和参数类型。请注意，Java代码的返回类型和参数必须与相应注释的本机容器类型相匹配。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@Nullable：</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>该@Nullable注解表明该参数可以是NULL。如果没有这个注释框架假定所有的函数返回NULL如果有他们的论据是NULL。当与一个工作类型具有原始本机容器类型，例如BigintType，使用对象包装器的本机容器型使用时@Nullable。必须使用@Nullable注释该方法， 如果参数不为null ，则返回NULL。</p>
</div>
<div class="paragraph">
<p><strong>聚合函数</strong></p>
</div>
<div class="paragraph">
<p>聚合函数使用与标量函数相似的框架，但是涉及到更多的复杂性。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>蓄能器状态：</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>所有聚合函数将输入行累加到状态对象中; 此对象必须实现AccumulatorState。对于简单的聚合，只需将AccumulatorState扩展到您需要的getter和setter的新界面，框架就会为您生成所有的实现和序列化。如果需要更复杂的状态对象，则需要实现AccumulatorStateFactory和AccumulatorStateSerializer， 并通过AccumulatorStateMetadata注释提供这些对象。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>@AggregationFunction("avg")
public final class AverageAggregation
{
    @InputFunction
    public static void input(LongAndDoubleState state, @SqlType(StandardTypes.DOUBLE) double value)
    {
        state.setLong(state.getLong() + 1);
        state.setDouble(state.getDouble() + value);
    }

    @CombineFunction
    public static void combine(LongAndDoubleState state, LongAndDoubleState otherState)
    {
        state.setLong(state.getLong() + otherState.getLong());
        state.setDouble(state.getDouble() + otherState.getDouble());
    }

    @OutputFunction(StandardTypes.DOUBLE)
    public static void output(LongAndDoubleState state, BlockBuilder out)
    {
        long count = state.getLong();
        if (count == 0) {
            out.appendNull();
        }
        else {
            double value = state.getDouble();
            DOUBLE.writeDouble(out, value / count);
        }
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>上述代码实现了计算DOUBLE列平均值的聚合函数avg。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@InputFunction：</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>所述@InputFunction注解声明其接收输入的行和将它们存储在所述函数AccumulatorState。与标量函数类似，您必须使用@SqlType对参数进行注释。
在这个例子中，输入函数只是跟踪运行的行数（通过setLong（））和运行总和（通过setDouble（））。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@CombineFunction：</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>该@CombineFunction注解声明用于在两个状态对象进行组合的功能。此函数用于合并所有部分聚合状态。它需要两个状态对象，并将结果合并到第一个对象中（在上面的示例中，只是将它们添加在一起）。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>@输出功能：</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>该@OutputFunction是计算聚合时调用的最后一个函数。它需要最终状态对象（合并所有部分状态的结果），并将结果写入BlockBuilder。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>序列化发生在哪里，什么是@GroupedAccumulatorState？</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>该@InputFunction通常是从不同的工人跑 @CombineFunction，所以状态对象被序列化并通过聚合框架这些工人之间的运输。
 执行GROUP BY聚合时使用@GroupedAccumulatorState，如果未指定AccumulatorStateFactory，将自动为您生成一个实现</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
最后更新时间 2017-07-14 15:10:31 CST
</div>
</div>
</body>
</html>