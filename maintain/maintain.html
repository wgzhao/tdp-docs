<!DOCTYPE html>
<html lang="zh_cn">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="keywords" content="HDP, Hadoop, bigdata, Spark">
<meta name="author" content="方正证券股份有限公司">
<title>Hortonworks HDP V3.0: 集群维护手册</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
.listingblock .pygments .hll { background-color: #ffffcc }
.listingblock .pygments, .listingblock .pygments code { background: #f8f8f8; }
.listingblock .pygments .tok-c { color: #408080; font-style: italic } /* Comment */
.listingblock .pygments .tok-err { border: 1px solid #FF0000 } /* Error */
.listingblock .pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
.listingblock .pygments .tok-o { color: #666666 } /* Operator */
.listingblock .pygments .tok-ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.listingblock .pygments .tok-cm { color: #408080; font-style: italic } /* Comment.Multiline */
.listingblock .pygments .tok-cp { color: #BC7A00 } /* Comment.Preproc */
.listingblock .pygments .tok-cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.listingblock .pygments .tok-c1 { color: #408080; font-style: italic } /* Comment.Single */
.listingblock .pygments .tok-cs { color: #408080; font-style: italic } /* Comment.Special */
.listingblock .pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
.listingblock .pygments .tok-ge { font-style: italic } /* Generic.Emph */
.listingblock .pygments .tok-gr { color: #FF0000 } /* Generic.Error */
.listingblock .pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
.listingblock .pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
.listingblock .pygments .tok-go { color: #888888 } /* Generic.Output */
.listingblock .pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.listingblock .pygments .tok-gs { font-weight: bold } /* Generic.Strong */
.listingblock .pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.listingblock .pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
.listingblock .pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.listingblock .pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.listingblock .pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.listingblock .pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
.listingblock .pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.listingblock .pygments .tok-kt { color: #B00040 } /* Keyword.Type */
.listingblock .pygments .tok-m { color: #666666 } /* Literal.Number */
.listingblock .pygments .tok-s { color: #BA2121 } /* Literal.String */
.listingblock .pygments .tok-na { color: #7D9029 } /* Name.Attribute */
.listingblock .pygments .tok-nb { color: #008000 } /* Name.Builtin */
.listingblock .pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
.listingblock .pygments .tok-no { color: #880000 } /* Name.Constant */
.listingblock .pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
.listingblock .pygments .tok-ni { color: #999999; font-weight: bold } /* Name.Entity */
.listingblock .pygments .tok-ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.listingblock .pygments .tok-nf { color: #0000FF } /* Name.Function */
.listingblock .pygments .tok-nl { color: #A0A000 } /* Name.Label */
.listingblock .pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.listingblock .pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
.listingblock .pygments .tok-nv { color: #19177C } /* Name.Variable */
.listingblock .pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.listingblock .pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
.listingblock .pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
.listingblock .pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
.listingblock .pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
.listingblock .pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
.listingblock .pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
.listingblock .pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
.listingblock .pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
.listingblock .pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
.listingblock .pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
.listingblock .pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.listingblock .pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
.listingblock .pygments .tok-se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.listingblock .pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
.listingblock .pygments .tok-si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.listingblock .pygments .tok-sx { color: #008000 } /* Literal.String.Other */
.listingblock .pygments .tok-sr { color: #BB6688 } /* Literal.String.Regex */
.listingblock .pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
.listingblock .pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
.listingblock .pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
.listingblock .pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
.listingblock .pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
.listingblock .pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
.listingblock .pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
.listingblock .pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
.listingblock .pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Hortonworks HDP V3.0: 集群维护手册</h1>
<div class="details">
<span id="author" class="author">方正证券股份有限公司</span><br>
<span id="revdate">2018</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">目录</div>
<ul class="sectlevel1">
<li><a href="#_ambari_管理">1. Ambari 管理</a>
<ul class="sectlevel2">
<li><a href="#_修改admin密码">1.1. 修改admin密码</a></li>
<li><a href="#_更改_jdk_版本">1.2. 更改 JDK 版本</a></li>
<li><a href="#_更换集群名称">1.3. 更换集群名称</a></li>
<li><a href="#_迁移_ambari_server">1.4. 迁移 Ambari Server</a></li>
<li><a href="#_使用oracle_作为_ambari_的数据库">1.5. 使用Oracle 作为 Ambari 的数据库</a></li>
<li><a href="#_配置网络端口">1.6. 配置网络端口</a></li>
<li><a href="#_ambari_性能调优">1.7. Ambari 性能调优</a></li>
<li><a href="#_删除_ambari_server_历史数据">1.8. 删除 Ambari Server 历史数据</a></li>
</ul>
</li>
<li><a href="#_hdfs_运维">2. HDFS 运维</a>
<ul class="sectlevel2">
<li><a href="#_优化数据存储空间">2.1. 优化数据存储空间</a></li>
<li><a href="#_hdfs_性能优化">2.2. HDFS 性能优化</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>该手册主要提供HDP集群在日常维护过程中进场用到的操作以及维护方法</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ambari_管理">1. Ambari 管理</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_修改admin密码">1.1. 修改admin密码</h3>
<div class="paragraph">
<p>在Ambari管理页面，可以修改默认账号admin以及自行创建的账号密码，步骤如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在 <strong>Admin/Users</strong> ，找到需要修改的账号，如何点击 <strong>Action&#8594;Edit</strong></p>
</li>
<li>
<p>在 <strong>Users/[UERNAME]</strong>，点击 <strong>Change password</strong></p>
</li>
<li>
<p>点击 <strong>change password</strong></p>
</li>
<li>
<p>在 <strong>Change password for [username]</strong> 一栏，输入该账号的当前密码以及新的密码两次。</p>
</li>
<li>
<p>点击 <strong>OK</strong></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_更改_jdk_版本">1.2. 更改 JDK 版本</h3>
<div class="paragraph">
<p>Ambari 在安装过程既可以使用默认的 JDK 版本，也可以指定一个 JDK版本。安装完成后，如果 JDK 已经升级，则可能需要更换 JDK 版本。
更换 JDK 的前提是集群所有节点都已经安装了需要替换的 JDK 版本，并且设置该 JDK 为默认 JDK 版本。
改换 JDK 版本步骤如下</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>登陆到 Ambari Server 节点，用 root 账号执行 <code>ambari-server setup</code></p>
</li>
<li>
<p>当提示 <code>change the JDK ?</code> 时，输入 <code>y</code></p>
</li>
<li>
<p>当提示 <code>Do you want to change Oracle JDK[y/n] (n)?</code> 时，输入 <code>y</code></p>
</li>
<li>
<p>当提示 `choose a JDK: ` 时，输入 3 ，使用自定义的 JDK</p>
</li>
<li>
<p>输入更换版本的 JDK 路径</p>
<div class="dlist">
<dl>
<dt class="hdlist1">NOTE</dt>
<dd>
<p>如果自定义 JDK，且集群启用了 Kerberos，务必对 JDK 增加 JCE 补丁。具体方法参考集群安装手册的环境准备章节</p>
</dd>
</dl>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>完成替换后，还需要执行两个步骤：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>登陆到 Ambari web 界面，然后重启所有的服务，确保所有的服务使用更换的 JDK 启动服务</p>
</li>
<li>
<p>重启 Ambari Server  <code>ambari-server restart</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_更换集群名称">1.3. 更换集群名称</h3>
<div class="paragraph">
<p>创建集群后，你可以修改创建时定义的集群名称，步骤如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在 Ambari 管理界面，在 <strong>Cluster Information&#8594;Cluster name</strong> , 输入新的集群名称，长度不超过80个字符 image::https://docs.hortonworks.com/HDPDocuments/Ambari-2.7.1.0/administering-ambari/how-to/images/amb_rename_cluster.png[change cluster name]</p>
</li>
<li>
<p>点击 <strong>Save</strong></p>
</li>
<li>
<p>确认新的集群名称</p>
</li>
<li>
<p>重启 Ambari Server 和 Ambari Agent</p>
</li>
<li>
<p>如果有涉及到利用 Ambari API 调用的程序，记得同时调整 API 调用路径</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_迁移_ambari_server">1.4. 迁移 Ambari Server</h3>
<div class="paragraph">
<p>将当前的 Ambari Server 迁移到另外一个节点主要包括两个步骤，一是在新节点上安装 Ambari Server 软件包；二是将老的Ambari Server 数据传输到新节点上并做必要的配置，将步骤细化如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>备份当前的 Ambari  Server 数据</p>
</li>
<li>
<p>更新所有的 Ambari Agent</p>
</li>
<li>
<p>安装新的 Ambari Server</p>
</li>
<li>
<p>导入 Ambari Server 数据</p>
</li>
<li>
<p>启动新的 Ambari Server 和 Agent</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>下面分别描述</p>
</div>
<div class="sect3">
<h4 id="_备份当前的_ambari_server_数据">1.4.1. 备份当前的 Ambari Server 数据</h4>
<div class="paragraph">
<p>备份步骤如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>登陆 Ambari Server 节点，停止 Ambari Server 服务 <code>ambari-server stop</code></p>
</li>
<li>
<p>创建备份文件的存储目录</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /tmp
mkdir dbdumps/
chmod <span class="tok-m">777</span> dbdumps/
<span class="tok-nb">cd</span> dbdumps</code></pre>
</div>
</div>
</li>
<li>
<p>创建数据库备份</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>pg_dump -U <span class="tok-o">[</span>AMBARI_DB_USERNAME<span class="tok-o">]</span> -f ambari.sql
password: <span class="tok-o">[</span>AMBARI_DB_PASSWORD<span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 1. 数据备份变量一览表</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">变量</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">描述</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">默认值</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">[AMBARI_DB_USERNAME]</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">数据库名称</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ambari</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">[AMBARI_DB_PASSWORD]</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">数据库密码</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">bigdata</p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>创建 Ambari Server 元数据库信息备份 <code>ambari-server backup</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_更新所有的_ambari_agent">1.4.2. 更新所有的 Ambari Agent</h4>
<div class="paragraph">
<p>更新步骤如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在每个集群节点上停止 Ambari Agent <code>ambari-agent stop</code></p>
</li>
<li>
<p>删除原来的 Agent 证书 <code>rm -rf /var/lib/ambari-agent/*</code></p>
</li>
<li>
<p>编辑 <em>/etc/ambari-agent/conf/ambari-agent.ini</em> 文件，修改 <code>hostname=</code> 的值为新 Ambari Server 节点主机名</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[server]</span>
<span class="tok-na">hostname</span><span class="tok-o">=</span><span class="tok-s">{NEW_AMBARI_SERVER_FQDN} </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-na">url_post</span><span class="tok-o">=</span><span class="tok-s">8440</span>
<span class="tok-na">secured_url_port</span><span class="tok-o">=</span><span class="tok-s">8441</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>新的 Ambari Server 节点主机名</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_安装新的_ambari_server">1.4.3. 安装新的 Ambari Server</h4>
<div class="paragraph">
<p>在节点上安装 Ambari Server，删除老的 Ambari 数据库，增加新的 Ambari 数据库，步骤如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在新节点上安装新的 Ambari Server <code>yum install -y ambari-server</code></p>
</li>
<li>
<p>配置新的节点 <code>ambari-setup setup -j &lt;jdk path&gt; -q</code></p>
</li>
<li>
<p>重启 PostgreSQL 进程 <code>systemctl postgresql restart</code></p>
</li>
<li>
<p>删除刚创建的 <code>ambari</code> 数据库</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>su - postgres
psql -e <span class="tok-s2">&quot;drop database ambari&quot;</span>
psql -e <span class="tok-s2">&quot;create database ambari owner ambari charset utf8&quot;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_导入备份数据到新的_ambari_server">1.4.4. 导入备份数据到新的 Ambari Server</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>拷贝老的 Ambari Server 上备份的数据(<em>/tmp/dbdumps/ambari.sql</em>)到新节点</p>
</li>
<li>
<p>导入数据 `su - postgres -c "psql -d ambari -f /tmp/dbdumps/ambari.sql `</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_启动新的_ambari_server_和_agent">1.4.5. 启动新的 Ambari Server 和 Agent</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>启动新的 Server <code>ambari-server start</code></p>
</li>
<li>
<p>所有节点启动 Agent <code>ambari-agent start</code></p>
</li>
<li>
<p>打开浏览器，浏览 <a href="http://&lt;your" class="bare">http://&lt;your</a> new ambari server&gt;:8080</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_使用oracle_作为_ambari_的数据库">1.5. 使用Oracle 作为 Ambari 的数据库</h3>
<div class="paragraph">
<p>默认情况下，Ambari 使用嵌入式 PostgreSQL 作为后端数据库。当然我们也可以使用其他数据库作为 Ambari 的元数据存储库。
这里用 Oracle 作为例子来描述如何使用配置，其他数据库的配置流程相似。</p>
</div>
<div class="paragraph">
<p>在使用 Oracle 作为后端数据库之前，需要获得对应的 JDBC 驱动包，以及在 Oracle 上创建有权限的账号以及对应的数据库。
如果 Oracle 是11g，则使用 <code>ojdbc6.jar</code> 包，如果是 12c ，则使用 <code>ojdbc7.jar</code> 包。</p>
</div>
<div class="paragraph">
<p>配置步骤如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在 Ambari Server 节点上获取正确的 JDBC 包，并拷贝到对应的目录</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cp ojdbc6.jar /usr/share/java
chmod <span class="tok-m">644</span> /usr/share/java/ojdbc6.jar</code></pre>
</div>
</div>
</li>
<li>
<p>在 Oracle 上创建 Ambari Server 的连接账号，并授权</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span></span><span class="tok-o">#</span> <span class="tok-n">sqlplus</span> <span class="tok-n">sys</span><span class="tok-o">/</span><span class="tok-n">root</span> <span class="tok-k">as</span> <span class="tok-n">sysdba</span>
<span class="tok-k">CREATE</span> <span class="tok-k">USER</span> <span class="tok-p">[</span><span class="tok-n">AMBARI_USER</span><span class="tok-p">]</span> <span class="tok-n">IDENTIFIED</span> <span class="tok-k">BY</span> <span class="tok-p">[</span><span class="tok-n">AMBARI_PASSWORD</span><span class="tok-p">]</span> <span class="tok-k">default</span>
 <span class="tok-n">tablespace</span> <span class="tok-ss">&quot;USERS&quot;</span> <span class="tok-k">temporary</span> <span class="tok-n">tablespace</span> <span class="tok-ss">&quot;TEMP&quot;</span><span class="tok-p">;</span>
<span class="tok-k">GRANT</span> <span class="tok-n">unlimited</span> <span class="tok-n">tablespace</span> <span class="tok-k">to</span> <span class="tok-p">[</span><span class="tok-n">AMBARI_USER</span><span class="tok-p">];</span>
<span class="tok-k">GRANT</span> <span class="tok-k">create</span> <span class="tok-k">session</span> <span class="tok-k">to</span> <span class="tok-p">[</span><span class="tok-n">AMBARI_USER</span><span class="tok-p">];</span>
<span class="tok-k">GRANT</span> <span class="tok-k">create</span> <span class="tok-k">TABLE</span> <span class="tok-k">to</span> <span class="tok-p">[</span><span class="tok-n">AMBARI_USER</span><span class="tok-p">];</span>
<span class="tok-k">GRANT</span> <span class="tok-k">create</span> <span class="tok-n">SEQUENCE</span> <span class="tok-k">to</span> <span class="tok-p">[</span><span class="tok-n">AMBARI_USER</span><span class="tok-p">];</span>
<span class="tok-n">QUIT</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里 <code>[AMBARI_USER]</code> 是 Ambari Server 连接的账号，一般是 <code>ambari</code>，<code>AMBARI_PASSWORD</code> 是密码</p>
</div>
</li>
<li>
<p>加载 Ambari Server 数据库结构 <code>sqlplus [AMBARI_USER]/[AMBARI_PASSWORD] Ambari-DDL-Oracle-CREATE.sql</code>，其中 <code>Ambari-DDL-Oracle-CREATE.sql</code> 位于 <em>/var/lib/ambari-server/resources/</em> 目录</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>接下来执行 <code>ambari-server setup</code> ，等到出现
<code>select Advanced Database Configuration ] Option [2] Oracle</code> 时，选择2，然后按照提示进行后续操作。</p>
</div>
</div>
<div class="sect2">
<h3 id="_配置网络端口">1.6. 配置网络端口</h3>
<div class="paragraph">
<p>Ambari 安装向导默认会针对 Server 和 Agent 分配默认的端口，后期我们可以修改，默认情况下，Ambari 使用到以下端口：</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">服务</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">节点</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">默认端口</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">协议</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">描述</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Ambari Server</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Ambari Server 节点</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">8080</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">http</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Ambari web 服务以及 REST API 服务</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Ambari Server</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Ambari Server 节点</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">8440</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">https</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Ambari Server 和 Agent 的握手端口</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Ambari Server</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Ambari Sever 节点</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">8441</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">https</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">Ambari Agent 向 Server 的注册端口以及两者通讯的心跳端口</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">Ambari Agent</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">所有运行 Agent 的节点</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">8670</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">tcp</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">ping 端口，用来检查 Agent 的状态并发出警告</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_修改_ambari_web_端口">1.6.1. 修改 Ambari web 端口</h4>
<div class="paragraph">
<p>我们可以修改 Ambari web 的默认8080 端口为其他端口，方法如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>登陆到 Ambari Server 节点，打开 <em>/etc/ambari-server/conf/ambari.properties</em> 文件</p>
</li>
<li>
<p>增加 <code>client.api.port=[PORT]</code> 一行到文件的最后，<code>[PORT]</code> 是你想更改的端口号</p>
</li>
<li>
<p>重启服务 <code>ambari-server restart</code></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ambari_性能调优">1.7. Ambari 性能调优</h3>
<div class="paragraph">
<p>默认配置下，Ambari 运行不会有任何问题，如果你的集群节点超过100台，可以考虑从以下几个方面进行调优</p>
</div>
<div class="ulist">
<ul>
<li>
<p>增加 Ambari Server 的 heap size</p>
</li>
<li>
<p>设置更大的 cache size</p>
</li>
<li>
<p>调整 JDBC 连接池配置</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>下面分别描述</p>
</div>
<div class="sect3">
<h4 id="_增加_heap_size">1.7.1. 增加 heap size</h4>
<div class="paragraph">
<p>打开 Ambari Server 节点上的 <em>/var/lib/ambari-server/ambari-env.sh</em> 文件，找到 <code>AMBARI_JVM_ARGS</code> 变量，根据集群节点数量情况，替代
<code>-Xmx2048m</code> 参数，一般来说</p>
</div>
<div class="ulist">
<ul>
<li>
<p>100-800节点，配置为4G 内存</p>
</li>
<li>
<p>800-1200节点，配置为 8G 内存</p>
</li>
<li>
<p>1200以上，配置为 16G 内存</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_增加_cache_size">1.7.2. 增加 cache size</h4>
<div class="paragraph">
<p>cache size 的大致计算公式是 <code>60 * [CLUSTER_SIZE]</code>, <code>CLUSTER_SIZE</code> 是集群节点数量。
打开 Ambari Server 节点上的 <em>/etc/ambari-server/conf/ambari.properties</em> 文件，增加下面一行</p>
</div>
<div class="paragraph">
<p><code>server.ecCacheSize=[EC_CACHE_SIZE_VALUE]</code></p>
</div>
<div class="paragraph">
<p><code>EC_CACHE_SIZE_VALUE</code> 是依据前面计算公式得到的值</p>
</div>
</div>
<div class="sect3">
<h4 id="_调整jdbc连接池">1.7.3. 调整JDBC连接池</h4>
<div class="paragraph">
<p>打开 Ambari Server 节点上的 <em>/etc/ambari-server/conf/ambari.properties</em> 文件，增加以下几行</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 2. JDBC 连接池配置</caption>
<colgroup>
<col style="width: 66.6666%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">属性</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">值</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">server.jdbc.connection-pool.acquisition-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">server.jdbc.connection-pool.max-age</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">server.jdbc.connection-pool.max-idle-time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14400</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">server.jdbc.connection-pool.max-idle-time-excess</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">server.jdbc.connection-pool.idle-test-interval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7200</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_删除_ambari_server_历史数据">1.8. 删除 Ambari Server 历史数据</h3>
<div class="paragraph">
<p>为了减少性能损耗，可以使用 Ambari 命令行工具自动删除 Ambari 数据库中的历史数据，步骤如下：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>停止服务 <code>ambari-server stop</code></p>
</li>
<li>
<p>运行 purge 命令</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># ambari-server db-purge-history --cluster-name fzzq --from-date 2018-11-01</span>
Using python  /usr/bin/python
Purge database history...
Ambari Server configured <span class="tok-k">for</span> Embedded Postgres. Confirm you have made a backup of the Ambari Server database <span class="tok-o">[</span>y/n<span class="tok-o">]</span>y
Ambari server is using db <span class="tok-nb">type</span> Embedded Postgres. Cleanable database entries older than <span class="tok-m">2018</span>-11-01 will be purged. Proceed <span class="tok-o">[</span>y/n<span class="tok-o">]</span>y
Purging historical data from the database ...
Error output from database purge-history command:
Dec <span class="tok-m">04</span>, <span class="tok-m">2018</span> <span class="tok-m">10</span>:30:56 AM com.google.inject.assistedinject.FactoryProvider2 isValidForOptimizedAssistedInject
WARNING: AssistedInject factory org.apache.ambari.server.state.cluster.ClusterFactory will be slow because class org.apache.ambari.server.state.cluster.ClusterImpl has assisted Provider dependencies or injects the Injector. Stop injecting @Assisted Provider&lt;T&gt; <span class="tok-o">(</span>instead use @Assisted T<span class="tok-o">)</span> or Injector to speed things up. <span class="tok-o">(</span>It will be a ~6500% speed bump!<span class="tok-o">)</span>  The exact offending deps are: <span class="tok-o">[</span>Key<span class="tok-o">[</span><span class="tok-nv">type</span><span class="tok-o">=</span>com.google.inject.Injector, <span class="tok-nv">annotation</span><span class="tok-o">=[</span>none<span class="tok-o">]]</span>@org.apache.ambari.server.state.cluster.ClusterImpl.&lt;init&gt;<span class="tok-o">()[</span><span class="tok-m">1</span><span class="tok-o">]]</span>

... ...

Purging historical data completed. Check the ambari-server.log <span class="tok-k">for</span> details.
Ambari Server <span class="tok-s1">&#39;db-purge-history&#39;</span> completed successfully.</code></pre>
</div>
</div>
</li>
<li>
<p>启动服务 <code>ambari-server start</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>上述删除的命令执行的结果是会将以下数据记录进行删除</p>
</div>
<div class="ulist">
<ul>
<li>
<p>AlertCurrent</p>
</li>
<li>
<p>AlertNotice</p>
</li>
<li>
<p>ExecutionCommand</p>
</li>
<li>
<p>HostRoleCommand</p>
</li>
<li>
<p>Request</p>
</li>
<li>
<p>RequestOperationLevel</p>
</li>
<li>
<p>RequestResourceFilter</p>
</li>
<li>
<p>RoleSuccessCriteria</p>
</li>
<li>
<p>Stage</p>
</li>
<li>
<p>TopologyHostRequest</p>
</li>
<li>
<p>TopologyHostTask</p>
</li>
<li>
<p>TopologyLogicalTask</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hdfs_运维">2. HDFS 运维</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_优化数据存储空间">2.1. 优化数据存储空间</h3>
<div class="paragraph">
<p>针对存储在 HDFS 上的数据库，我们可以从以下几个方面提升存储的效率和访问性能</p>
</div>
<div class="ulist">
<ul>
<li>
<p>单个节点上多磁盘的存储空间平衡</p>
</li>
<li>
<p>集群内跨节点的存储空间平衡</p>
</li>
<li>
<p>通过纠删码提升存储空间</p>
</li>
<li>
<p>针对归档的冷数据应用存储策略</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>下面分别描述</p>
</div>
<div class="sect3">
<h4 id="_单个节点上多磁盘的存储空间平衡">2.1.1. 单个节点上多磁盘的存储空间平衡</h4>
<div class="paragraph">
<p>HDFS 磁盘平衡是一个命令行工具，用来达到单个节点上移动不同磁盘上的数据以获得每块磁盘上数据使用占比大致相同的功能。
在使用该命令之前，先要保证 <code>hdfs-site.xml</code> 文件中 <code>dfs.disk.balancer.enabled</code> 属性设置为 <code>true</code></p>
</div>
<div class="paragraph">
<p>然后先执行下面的命令生成计划配置文件</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>hdfs diskbalancer -plan <span class="tok-o">[</span>NODE<span class="tok-o">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>[NODE]</code> 是集群中节点的主机名、IP 地址或者 UUID。
如果程序认为已经达到了平衡，则给出下面的提示：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-m">18</span>/12/04 <span class="tok-m">13</span>:08:38 INFO balancer.KeyManager: Block token params received from NN: update <span class="tok-nv">interval</span><span class="tok-o">=</span>10hrs, 0sec, token <span class="tok-nv">lifetime</span><span class="tok-o">=</span>10hrs, 0sec
<span class="tok-m">18</span>/12/04 <span class="tok-m">13</span>:08:38 INFO block.BlockTokenSecretManager: Setting block keys
<span class="tok-m">18</span>/12/04 <span class="tok-m">13</span>:08:38 INFO balancer.KeyManager: Update block keys every 2hrs, 30mins, 0sec
<span class="tok-m">18</span>/12/04 <span class="tok-m">13</span>:08:39 INFO planner.GreedyPlanner: Starting plan <span class="tok-k">for</span> Node : data-hdp-0001:8010
<span class="tok-m">18</span>/12/04 <span class="tok-m">13</span>:08:39 INFO planner.GreedyPlanner: Compute Plan <span class="tok-k">for</span> Node : data-hdp-0001:8010 took <span class="tok-m">22</span> ms
<span class="tok-m">18</span>/12/04 <span class="tok-m">13</span>:08:39 INFO command.Command: No plan generated. DiskBalancing not needed <span class="tok-k">for</span> node: data-hdp-0001 threshold used: <span class="tok-m">10</span>.0
No plan generated. DiskBalancing not needed <span class="tok-k">for</span> node: data-hdp-0001 threshold used: <span class="tok-m">10</span>.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>否则会生成两个文件</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">&lt;nodename&gt;.before.json</dt>
<dd>
<p>表示执行平衡之前该节点的磁盘空间状态</p>
</dd>
<dt class="hdlist1">&lt;nodename&gt;.plan.json</dt>
<dd>
<p>包含了详细了需要移动的数据情况</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>默认情况下，上述文件会保存在 HDFS 的 <em>/system/diskbalancer/&lt;creation-timestamp&gt;</em> 目录下， 这里的 <code>create-timestamp</code> 是执行上述命令的时间戳</p>
</div>
<div class="paragraph">
<p>接下来，通过下面的命令，真正开始移动数据已达到平衡</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>hdfs diskbalancer -execute /system/diskbalancer/&lt;creation-timestamp&gt;/nodename.plan.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>上述命令还可以指定几个参数，更详细的情况，请看
<code>hdfs diskbalancer -help plan</code>
和 <code>hdfs diskbalancer -help execute</code>
的输出结果</p>
</div>
</div>
<div class="sect3">
<h4 id="_集群内跨节点的存储空间平衡">2.1.2. 集群内跨节点的存储空间平衡</h4>
<div class="paragraph">
<p>应用程序生成数据时并没有让所有存储节点参与会导致集群内节点间的数据不平衡；新增数据节点也会导致这种情况。因此随着集群的时候增加，节点之间的不平衡率会增加，如果超过了
一定的阈值（默认是10%），则需要通过人工来调整平衡。</p>
</div>
<div class="paragraph">
<p><code>hdfs balancer</code> 命令有不少配置属性来控制或者影响平衡的效率以及对集群使用的影响，说明如下：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">dfs.datanode.balance.max.concurrent.moves</dt>
<dd>
<p>单个节点上数据移动进程的最大数据量，默认值是5。你可以配置为当前节点磁盘的数量</p>
</dd>
<dt class="hdlist1">dfs.datanode.balance.bandwidthPerSec</dt>
<dd>
<p>数据平衡命令所能使用的最高带宽，默认是 1048576（1MB/s)，这个值对大部分集群来说都太小，如果你是在集群空闲时运行，建议设置到节点间最大带宽的80%</p>
</dd>
<dt class="hdlist1">dfs.balancer.max-size-to-move</dt>
<dd>
<p>在每一个批次里，数据节点间能移动的数据大小，默认是10737418240(10GB)</p>
</dd>
<dt class="hdlist1">dfs.balancer.getBlocks.size</dt>
<dd>
<p>getBlocks()方法返回的大小，默认是214783648（2GB）</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>同时，<code>hdfs balancer</code> 还可以指定一些参数，描述如下：</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">[-policy &lt;policy&gt;]</dt>
<dd>
<p>指定如何判断集群内数据是否平衡的策略；目前支持两种策略：<code>blockpool</code> 和 <code>datanode</code> 前者表示如果每个节点的 pool 是平衡的，则集群是平衡的，
后者表示如果集群内每个节点是平衡的，则集群是平衡的，默认策略是 <code>datanode</code></p>
</dd>
<dt class="hdlist1">[-threshold &lt;threhold&gt;]</dt>
<dd>
<p>表示可接受的数据节点间存储占比的差值，范围为 <code>[1.0,100.0]</code> 之间，比如 指定值为 5，则表示两个节点间存盘使用空间比率差值可以在
<code>[-5%,0.5%]</code> 之间，也即是两者最多相差10%。默认值是 10</p>
</dd>
<dt class="hdlist1">[-exclude [-f &lt;hosts-file&gt; | &lt;comma-separated list of hosts&gt;]]</dt>
<dd>
<p>指明哪些 datanode 参与本次数据调整，这些指明的 datanode，既不会拷贝数据出去，也不会传输数据进来。
默认为空</p>
</dd>
<dt class="hdlist1">[-include [-f &lt;hosts-file&gt; | &lt;comma-separated list of hosts&gt;]]</dt>
<dd>
<p>指明只有哪些 datenode 参与本次数据调整。默认为空</p>
</dd>
<dt class="hdlist1">[-source [-f &lt;hosts-file&gt; | &lt;comma-separated list of hosts&gt;]]</dt>
<dd>
<p>指明哪些 datenode 作为数据的复制源，一旦指明这些节点，则本次数据调整仅从这些节点拷贝数据出去。
默认为空。该参数在特定的数据倾斜下有减少数据移动次数。
考虑下面的集群数据存储情况</p>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 3. 集群数据存储利用率</caption>
<colgroup>
<col style="width: 42.8571%;">
<col style="width: 28.5714%;">
<col style="width: 28.5715%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">节点</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">利用率</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">机架</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">D1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">95%</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">D2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">30%</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">B</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">D3,D4,D5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0%</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">B</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>通过上表，我们知道该就集群的存储平均利用率是 $ (0.95*1 + 0.30*1+3*0)/5 = 25% $， 而 D2 节点是在默认阈值 10% 范围内，因此理论上做数据平衡时，D2节点可以不用参与。
但是，当不指定 <code>-source</code> 参数时，所有的 datanodes 都会参与。而且因为 D2节点和 D3-D5节点是在同一个机架上。因此会优先从 D2传输数据到 D3-D5，然后再从 D1 传输数据到
其他节点。因此，当我们使用 <code>-source D1</code> 后，就只有 D1 参与数据移动，本例中，D1数据直接移动到 D3-D5节点，节省了移动次数。</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>依据配置的参数不同，HDFS Balancer 可以作为后台模式运行，也可以作为快速模式运行。后台运行模式不影响集群上的其他任务。快速模式则尽可能占用集群资源。
以下是两者的参数对比</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 40%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">属性</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">默认值</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">后台模式值</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">快速模式值</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dfs.datanode.balance.max.concurrent.moves</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 x 磁盘数量</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 * 磁盘数量</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dfs.datanode.balance.max.bandwidthPerSec</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1048576（1MB/s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1048576（1MB/s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10737418240 (10 GB)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dfs.balancer.MoverThreads</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20000</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dfs.balancer.max-size-to-move</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10737418240 (10 GB)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1073741824(1GB)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">107374182400(100GB)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dfs.balancer.getBlocks.min-block-size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10485760（10MB/s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10485760（10MB/s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">104857600（100MB/s)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>HDFS Balancer 进程完成或退出时给出特定的返回码来表明本次执行的状态以及可能的出错原因，列表如下：</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">表 4. HDFS Balancer退出码</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 10%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">状态</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">值</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">描述</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SUCCESS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">集群处于平衡状态，利用率差异都在指定的阈值范围内。</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ALREADY_RUNNING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">已经有一个 HDFS Balancer 正在运行</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NO_MOVE_BLOCK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HDFS Balancer 无法执行移动操作</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NO_MOVE_PROGRESS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">连续5个批次的移动操作都失败了</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IO_EXCEPTION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">发生 IOException 异常</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ILLEGAL_ARGUMENTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">参数异常</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">INTERUPTED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HDFS Balancer 进程被中断</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNFINALIZED_UPGRADE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">集群正在升级</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_通过纠删码提升存储空间">2.1.3. 通过纠删码提升存储空间</h4>
<div class="paragraph">
<p>HDFS 纠删码（Erasure Coding， EC）用来减低对负数数量的要求，从而达到减少存储空间的目标。
默认情况下，HDFS 采取3副本策略，这意味着需要增加200%的额外存储空间来确保数据的安全。而采取纠删码后，
在不降低数据安全等级的情况下，需要的额外存储空间不超过50%。
HDFS 通过数据条带化技术支持在目录层级实现纠删码。同时不同的目录可以采取不同的策略，每一个策略由以下两组信息组成：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>EC Schema: 包括在一个 EC 组里的数据和对等数据的数量，以及编码算法（比如Reed-Solomon)</p>
</li>
<li>
<p>条带单元大小: 决定了条带读写的大小，包括缓存大小以及编码工作量</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>HDFS 支持 Reed-Solomon 纠删算法，这也是系统的默认算法，其配置参数为6个数据块，3个对等块，条带大小为1024K（RS-6-3-1024k)</p>
</div>
<div class="paragraph">
<p>另外，HDFS 还支持以下算法
* RS-3-2-1024k
* RS-LEGACY-6-3-1024k
* XOR-2-1-1024k</p>
</div>
<div class="paragraph">
<p>注意，纠删码只针对启用后写入的数据有效，已经写入的文件夹和目录即便在启用纠删码后，依然采取默认的3副本策略。
另外，纠删码因为需要消耗一定的 CPU 和网络带宽，因此对集群的性能有一定的影响。</p>
</div>
<div class="paragraph">
<p><code>hdfs ec</code> 命令提供了配置纠删码的功能，下面我们举一个实际的例子来说明如何使用：</p>
</div>
<div class="paragraph">
<p>首先我们查看当前有哪些策略以及是否启用</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>$ hdfs ec -listPolicies
Erasure Coding Policies:
<span class="tok-nv">ErasureCodingPolicy</span><span class="tok-o">=[</span><span class="tok-nv">Name</span><span class="tok-o">=</span>RS-10-4-1024k, <span class="tok-nv">Schema</span><span class="tok-o">=[</span><span class="tok-nv">ECSchema</span><span class="tok-o">=[</span><span class="tok-nv">Codec</span><span class="tok-o">=</span>rs, <span class="tok-nv">numDataUnits</span><span class="tok-o">=</span><span class="tok-m">10</span>, <span class="tok-nv">numParityUnits</span><span class="tok-o">=</span><span class="tok-m">4</span><span class="tok-o">]]</span>, <span class="tok-nv">CellSize</span><span class="tok-o">=</span><span class="tok-m">1048576</span>, <span class="tok-nv">Id</span><span class="tok-o">=</span><span class="tok-m">5</span><span class="tok-o">]</span>, <span class="tok-nv">State</span><span class="tok-o">=</span>DISABLED
<span class="tok-nv">ErasureCodingPolicy</span><span class="tok-o">=[</span><span class="tok-nv">Name</span><span class="tok-o">=</span>RS-3-2-1024k, <span class="tok-nv">Schema</span><span class="tok-o">=[</span><span class="tok-nv">ECSchema</span><span class="tok-o">=[</span><span class="tok-nv">Codec</span><span class="tok-o">=</span>rs, <span class="tok-nv">numDataUnits</span><span class="tok-o">=</span><span class="tok-m">3</span>, <span class="tok-nv">numParityUnits</span><span class="tok-o">=</span><span class="tok-m">2</span><span class="tok-o">]]</span>, <span class="tok-nv">CellSize</span><span class="tok-o">=</span><span class="tok-m">1048576</span>, <span class="tok-nv">Id</span><span class="tok-o">=</span><span class="tok-m">2</span><span class="tok-o">]</span>, <span class="tok-nv">State</span><span class="tok-o">=</span>DISABLED
<span class="tok-nv">ErasureCodingPolicy</span><span class="tok-o">=[</span><span class="tok-nv">Name</span><span class="tok-o">=</span>RS-6-3-1024k, <span class="tok-nv">Schema</span><span class="tok-o">=[</span><span class="tok-nv">ECSchema</span><span class="tok-o">=[</span><span class="tok-nv">Codec</span><span class="tok-o">=</span>rs, <span class="tok-nv">numDataUnits</span><span class="tok-o">=</span><span class="tok-m">6</span>, <span class="tok-nv">numParityUnits</span><span class="tok-o">=</span><span class="tok-m">3</span><span class="tok-o">]]</span>, <span class="tok-nv">CellSize</span><span class="tok-o">=</span><span class="tok-m">1048576</span>, <span class="tok-nv">Id</span><span class="tok-o">=</span><span class="tok-m">1</span><span class="tok-o">]</span>, <span class="tok-nv">State</span><span class="tok-o">=</span>ENABLED
<span class="tok-nv">ErasureCodingPolicy</span><span class="tok-o">=[</span><span class="tok-nv">Name</span><span class="tok-o">=</span>RS-LEGACY-6-3-1024k, <span class="tok-nv">Schema</span><span class="tok-o">=[</span><span class="tok-nv">ECSchema</span><span class="tok-o">=[</span><span class="tok-nv">Codec</span><span class="tok-o">=</span>rs-legacy, <span class="tok-nv">numDataUnits</span><span class="tok-o">=</span><span class="tok-m">6</span>, <span class="tok-nv">numParityUnits</span><span class="tok-o">=</span><span class="tok-m">3</span><span class="tok-o">]]</span>, <span class="tok-nv">CellSize</span><span class="tok-o">=</span><span class="tok-m">1048576</span>, <span class="tok-nv">Id</span><span class="tok-o">=</span><span class="tok-m">3</span><span class="tok-o">]</span>, <span class="tok-nv">State</span><span class="tok-o">=</span>DISABLED
<span class="tok-nv">ErasureCodingPolicy</span><span class="tok-o">=[</span><span class="tok-nv">Name</span><span class="tok-o">=</span>XOR-2-1-1024k, <span class="tok-nv">Schema</span><span class="tok-o">=[</span><span class="tok-nv">ECSchema</span><span class="tok-o">=[</span><span class="tok-nv">Codec</span><span class="tok-o">=</span>xor, <span class="tok-nv">numDataUnits</span><span class="tok-o">=</span><span class="tok-m">2</span>, <span class="tok-nv">numParityUnits</span><span class="tok-o">=</span><span class="tok-m">1</span><span class="tok-o">]]</span>, <span class="tok-nv">CellSize</span><span class="tok-o">=</span><span class="tok-m">1048576</span>, <span class="tok-nv">Id</span><span class="tok-o">=</span><span class="tok-m">4</span><span class="tok-o">]</span>, <span class="tok-nv">State</span><span class="tok-o">=</span>DISABLED</code></pre>
</div>
</div>
<div class="paragraph">
<p>从上述输出结果来看，我们知道有些策略没有启动，如果希望启用，则使用下面的命令：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>$ hdfs ec -enablePolicy -policy RS-3-2-1024k
Erasure coding policy RS-3-2-1024k is enabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>接下来我们针对某一个目录进行策略设置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>hdfs ec -setPolicy -path /user -policy RS-6-3-1024k
Set RS-6-3-1024k erasure coding policy on /user
Warning: setting erasure coding policy on a non-empty directory will not automatically convert existing files to RS-6-3-1024k erasure coding policy</code></pre>
</div>
</div>
<div class="paragraph">
<p>我们可以通过下面的命令来确认策略是否已经正确设置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>$ hdfs ec -getPolicy -path /user
RS-6-3-1024k</code></pre>
</div>
</div>
<div class="paragraph">
<p>设置后，我们可以通过运行 <code>hdfs fsck</code> 来检查块数据来查看纠删码块的状态：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>$ hdfs fsck /user
.
.
.
Erasure Coded Block Groups:
 Total size:    <span class="tok-m">0</span> B
 Total files:   <span class="tok-m">0</span>
 Total block groups <span class="tok-o">(</span>validated<span class="tok-o">)</span>:        <span class="tok-m">0</span>
 Minimally erasure-coded block groups:  <span class="tok-m">0</span>
 Over-erasure-coded block groups:       <span class="tok-m">0</span>
 Under-erasure-coded block groups:      <span class="tok-m">0</span>
 Unsatisfactory placement block groups: <span class="tok-m">0</span>
 Average block group size:      <span class="tok-m">0</span>.0
 Missing block groups:          <span class="tok-m">0</span>
 Corrupt block groups:          <span class="tok-m">0</span>
 Missing internal blocks:       <span class="tok-m">0</span>
FSCK ended at Thu Dec <span class="tok-m">06</span> <span class="tok-m">09</span>:46:17 CST <span class="tok-m">2018</span> in <span class="tok-m">7</span> milliseconds

The filesystem under path <span class="tok-s1">&#39;/user&#39;</span> is HEALTHY</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_针对归档的冷数据应用存储策略">2.1.4. 针对归档的冷数据应用存储策略</h4>
<div class="paragraph">
<p>归档存储能够提升存储密度，同时降低处理资源。
HDFS 的存储的类型可以分为这么几类：
* DISK: 磁盘存储（默认存储类型）
* ARCHIVE: 归档存储
* SSD: 固态磁盘存储
* RAM_DISK: DataNode 内存存储</p>
</div>
<div class="paragraph">
<p>同时 HDFS 也内置了集中存储策略，描述如下：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>HOT: 存储和计算同时使用。用此策略的数据表示会用到后续的处理中。如果一个数据标志为 HOT，则会在 DISK(磁盘)上存储所有的副本。</p>
</li>
<li>
<p>WARM: 兼顾 HOT 和 COLD。当块标志位 WARM 时，第一个副本会存储在 DISK 上，剩下的副本存储在 ARCHIVE 上。</p>
</li>
<li>
<p>COLD: 仅用于存储，或者参与非常有限的计算。当数据块标志为 COLD 时，所有的副本都存储在 ARCHIVE 上。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>下表给出了不同策略下的副本情况：</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">策略编号</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">策略名称</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">副本策略（n 个副本下）</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">回撤机制</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">回撤副本存储策略</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">12</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HOT (默认)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disk: n</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARCHIVE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">WARM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Disk:1 , ARCHIVE:n-1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DISK,ARCHIVE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DISK,ARCHIVE</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">COLD</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ARCHIVE:n</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>如果我们需要希望在某一个 DataNode 上启用归档策略，首先必须在该节点上设置 ARCHIVE 存储类型，然后移动对应的数据块，在设置类型之前，
需要停止 datanode 进程，然后进行设置，首先修改 <em>/etc/hadoop/conf/hdfs-site.xml</em> 文件，找到 <code>dfs.datanode.data.dir</code> 属性，将该属性值中的 <code>[DISK]</code> 替换成
<code>[ARCHIVE]</code> ，类似如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;property&gt;</span>
  <span class="tok-nt">&lt;name&gt;</span>dfs.datanode.data.dir<span class="tok-nt">&lt;/name&gt;</span>
  <span class="tok-nt">&lt;value&gt;</span>[ARCHIVE]/grid/1/tmp/data_trunk<span class="tok-nt">&lt;/value&gt;</span>
<span class="tok-nt">&lt;/property&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>然后启动 datanode 进程，最后执行 <code>hdfs mover</code> ，该命令会是扫描 HDFS 上的特性文件，看是否满足存储策略，然后进行必要数据移动操作。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hdfs_性能优化">2.2. HDFS 性能优化</h3>
<div class="paragraph">
<p>HDFS 的性能优化可以从以下几个方面考虑：
. 缓存数据
. 配置机架感知
. 定制 HDFS
. 用 Hadoop 归档优化NameNode 磁盘空间
. 识别较慢的 DataNode，并优化
. 利用 DataNode 的内存作为存储来优化小数据写操作
. 实现短路读(short-circuit reads)</p>
</div>
<div class="sect3">
<h4 id="_配置集中的缓存管理提升性能">2.2.1. 配置集中的缓存管理提升性能</h4>
<div class="paragraph">
<p>集中缓存管理通过指定 HDFS 的某一个目录作为存储，那些需要重复访问同一个数据的应用由此可以提升性能；其架构如下：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://docs.hortonworks.com/HDPDocuments/HDP3/HDP-3.0.1/data-storage/concepts/images/dsg_caching.png" alt="centralized cache management architecture">
</div>
</div>
<div class="paragraph">
<p>要启用集中缓存管理，首先必须启用 JNI，另外还需要修改一些列配置属性，配置参数大部分在 <code>hdfs-site.xml</code> 文件中，其中必须设定的属性是 <code>dfs.datanode.max.locked.memory</code>，
该属性决定了一个 DataNode 能用来当做缓存的最大内存是多少（字节单位）。
下面列举的是可选属性配置：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>dfs.namenode.path.based.cache.refresh.interval.ms</code> NameNode 扫描的间隔时间，默认是 300000，即5分钟</p>
</li>
<li>
<p><code>dfs.time.between.resending.caching.directives.ms</code> NameNode 发起清理缓存的间隔时间</p>
</li>
<li>
<p><code>dfs.datanode.fsdatasetcache.max.threads.per.volume</code> DataNode 用来针对每个卷（volume）缓存数据时的最大线程数，默认是4</p>
</li>
<li>
<p><code>dfs.cachereport.intervalMsec</code> DataNode 发送一次完整缓存状态报给NameNode 的间隔时间，默认是10000，即10秒</p>
</li>
<li>
<p><code>dfs.namenode.path.based.cache.block.map.allocation.percent</code> Java heap size 比例，默认是 0.25</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>我们可以使用 <code>hdfs cacheadmin</code> 命令集来创建、修改、打印缓存池，以及通过其子命令执行缓存操作，详细命令如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>Usage: bin/hdfs cacheadmin <span class="tok-o">[</span>COMMAND<span class="tok-o">]</span>
          <span class="tok-o">[</span>-addDirective -path &lt;path&gt; -pool &lt;pool-name&gt; <span class="tok-o">[</span>-force<span class="tok-o">]</span> <span class="tok-o">[</span>-replication &lt;replication&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-ttl &lt;time-to-live&gt;<span class="tok-o">]]</span>
          <span class="tok-o">[</span>-modifyDirective -id &lt;id&gt; <span class="tok-o">[</span>-path &lt;path&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-force<span class="tok-o">]</span> <span class="tok-o">[</span>-replication &lt;replication&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-pool &lt;pool-name&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-ttl &lt;time-to-live&gt;<span class="tok-o">]]</span>
          <span class="tok-o">[</span>-listDirectives <span class="tok-o">[</span>-stats<span class="tok-o">]</span> <span class="tok-o">[</span>-path &lt;path&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-pool &lt;pool&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-id &lt;id&gt;<span class="tok-o">]]</span>
          <span class="tok-o">[</span>-removeDirective &lt;id&gt;<span class="tok-o">]</span>
          <span class="tok-o">[</span>-removeDirectives -path &lt;path&gt;<span class="tok-o">]</span>
          <span class="tok-o">[</span>-addPool &lt;name&gt; <span class="tok-o">[</span>-owner &lt;owner&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-group &lt;group&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-mode &lt;mode&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-limit &lt;limit&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-defaultReplication &lt;defaultReplication&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-maxTtl &lt;maxTtl&gt;<span class="tok-o">]]</span>
          <span class="tok-o">[</span>-modifyPool &lt;name&gt; <span class="tok-o">[</span>-owner &lt;owner&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-group &lt;group&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-mode &lt;mode&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-limit &lt;limit&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-defaultReplication &lt;defaultReplication&gt;<span class="tok-o">]</span> <span class="tok-o">[</span>-maxTtl &lt;maxTtl&gt;<span class="tok-o">]]</span>
          <span class="tok-o">[</span>-removePool &lt;name&gt;<span class="tok-o">]</span>
          <span class="tok-o">[</span>-listPools <span class="tok-o">[</span>-stats<span class="tok-o">]</span> <span class="tok-o">[</span>&lt;name&gt;<span class="tok-o">]]</span>
          <span class="tok-o">[</span>-help &lt;command-name&gt;<span class="tok-o">]</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_配置_hdfs_机架感知">2.2.2. 配置 HDFS 机架感知</h4>
<div class="paragraph">
<p>HDFS 中的 NameNode 维护所有 DataNode 的机架 ID，当需要在网络间传输数据库时，NameNode 会优选选择“更靠近”的DataNode 来完成这个任务以提升效率。而 NameNode 判断 DataNode 之间的距离便是通过位置，而这个位置使用机架 ID 来标示的，比如同一个机架的下 DataNode 就比不同机架之间的 DataNode 更近。</p>
</div>
<div class="paragraph">
<p>在 HDP 集群上配置机架感知，要创建一个机架拓扑脚本，然后在 <code>core-site.xml</code> 文件中指明该文件，并重启 HDFS，最后校验是否正确。详细描述如下：</p>
</div>
<div class="paragraph">
<div class="title">创建机架拓扑脚本</div>
<p>在 <em>/etc/hadoop/conf</em> 下，创建名为 <code>rack_topology.sh</code> 脚本，内如类似如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/bash</span>
<span class="tok-c1"># Adjust/Add the property &quot;net.topology.script.file.name&quot;</span>
<span class="tok-c1"># to core-site.xml with the &quot;absolute&quot; path the this</span>
<span class="tok-c1"># file. ENSURE the file is &quot;executable&quot;.</span>
<span class="tok-c1"># Supply appropriate rack prefix</span>
<span class="tok-nv">RACK_PREFIX</span><span class="tok-o">=</span>default
<span class="tok-c1"># To test, supply a hostname as script input:</span>
<span class="tok-k">if</span> <span class="tok-o">[</span> <span class="tok-nv">$#</span> -gt <span class="tok-m">0</span> <span class="tok-o">]</span><span class="tok-p">;</span> <span class="tok-k">then</span>
<span class="tok-nv">CTL_FILE</span><span class="tok-o">=</span><span class="tok-si">${</span><span class="tok-nv">CTL_FILE</span><span class="tok-k">:-</span><span class="tok-s2">&quot;rack_topology.data&quot;</span><span class="tok-si">}</span>
<span class="tok-nv">HADOOP_CONF</span><span class="tok-o">=</span><span class="tok-si">${</span><span class="tok-nv">HADOOP_CONF</span><span class="tok-k">:-</span><span class="tok-s2">&quot;/etc/hadoop/conf&quot;</span><span class="tok-si">}</span>
<span class="tok-k">if</span> <span class="tok-o">[</span> ! -f <span class="tok-si">${</span><span class="tok-nv">HADOOP_CONF</span><span class="tok-si">}</span>/<span class="tok-si">${</span><span class="tok-nv">CTL_FILE</span><span class="tok-si">}</span> <span class="tok-o">]</span><span class="tok-p">;</span> <span class="tok-k">then</span>
 <span class="tok-nb">echo</span> -n <span class="tok-s2">&quot;/</span><span class="tok-nv">$RACK_PREFIX</span><span class="tok-s2">/rack &quot;</span>
 <span class="tok-nb">exit</span> <span class="tok-m">0</span>
<span class="tok-k">fi</span>
<span class="tok-k">while</span> <span class="tok-o">[</span> <span class="tok-nv">$#</span> -gt <span class="tok-m">0</span> <span class="tok-o">]</span> <span class="tok-p">;</span> <span class="tok-k">do</span>
 <span class="tok-nv">nodeArg</span><span class="tok-o">=</span><span class="tok-nv">$1</span>
 exec&lt; <span class="tok-si">${</span><span class="tok-nv">HADOOP_CONF</span><span class="tok-si">}</span>/<span class="tok-si">${</span><span class="tok-nv">CTL_FILE</span><span class="tok-si">}</span>
 <span class="tok-nv">result</span><span class="tok-o">=</span><span class="tok-s2">&quot;&quot;</span>
 <span class="tok-k">while</span> <span class="tok-nb">read</span> line <span class="tok-p">;</span> <span class="tok-k">do</span>
 <span class="tok-nv">ar</span><span class="tok-o">=(</span> <span class="tok-nv">$line</span> <span class="tok-o">)</span>
 <span class="tok-k">if</span> <span class="tok-o">[</span> <span class="tok-s2">&quot;</span><span class="tok-si">${</span><span class="tok-nv">ar</span><span class="tok-p">[0]</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;</span><span class="tok-nv">$nodeArg</span><span class="tok-s2">&quot;</span> <span class="tok-o">]</span> <span class="tok-p">;</span> <span class="tok-k">then</span>
 <span class="tok-nv">result</span><span class="tok-o">=</span><span class="tok-s2">&quot;</span><span class="tok-si">${</span><span class="tok-nv">ar</span><span class="tok-p">[1]</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span>
 <span class="tok-k">fi</span>
 <span class="tok-k">done</span>
 <span class="tok-nb">shift</span>
 <span class="tok-k">if</span> <span class="tok-o">[</span> -z <span class="tok-s2">&quot;</span><span class="tok-nv">$result</span><span class="tok-s2">&quot;</span> <span class="tok-o">]</span> <span class="tok-p">;</span> <span class="tok-k">then</span>
 <span class="tok-nb">echo</span> -n <span class="tok-s2">&quot;/</span><span class="tok-nv">$RACK_PREFIX</span><span class="tok-s2">/rack &quot;</span>
 <span class="tok-k">else</span>
 <span class="tok-nb">echo</span> -n <span class="tok-s2">&quot;/</span><span class="tok-nv">$RACK_PREFIX</span><span class="tok-s2">/rack_</span><span class="tok-nv">$result</span><span class="tok-s2"> &quot;</span>
 <span class="tok-k">fi</span>
<span class="tok-k">done</span>
<span class="tok-k">else</span>
 <span class="tok-nb">echo</span> -n <span class="tok-s2">&quot;/</span><span class="tok-nv">$RACK_PREFIX</span><span class="tok-s2">/rack &quot;</span>
<span class="tok-k">fi</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>接下来在同样的目录下创建 <code>rack_topology.data</code> 文件，该文件包含了集群中每个节点的机架位置（机架 ID）</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-c1"># This file should be:</span>
<span class="tok-c1"># - Placed in the /etc/hadoop/conf directory</span>
<span class="tok-c1"># - On the Namenode (and backups IE: HA, Failover, etc)</span>
<span class="tok-c1"># - On the Job Tracker OR Resource Manager (and any Failover JT&#39;s/RM&#39;s)</span>
<span class="tok-c1"># This file should be placed in the /etc/hadoop/conf directory.</span>
<span class="tok-c1"># Add Hostnames to this file. Format &lt;host ip&gt; &lt;rack_location&gt;</span>
<span class="tok-na">192.168.2.10 01</span>
<span class="tok-na">192.168.2.11 02</span>
<span class="tok-na">192.168.2.12 03</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>运行第一个脚本，检查输出输出是否正确，正确无误后，将上述两个文件拷贝到每个节点的对应目录。</p>
</div>
<div class="paragraph">
<div class="title">增加拓扑脚本属性到core-site.xml中</div>
<p>首先停止 HDFS 集群，然后在 <em>/etc/hadoop/conf/core-site.xml</em> 中，添加下面的属性</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;property&gt;</span>
  <span class="tok-nt">&lt;name&gt;</span>net.topology.script.file.name<span class="tok-nt">&lt;/name&gt;</span>
  <span class="tok-nt">&lt;value&gt;</span>/etc/hadoop/conf/rack-topology.sh<span class="tok-nt">&lt;/value&gt;</span>
<span class="tok-nt">&lt;/property&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>默认情况下下，脚本一次最多处理100个请求，你可以通过下面的属性进行配置</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-nt">&lt;property&gt;</span>
  <span class="tok-nt">&lt;name&gt;</span>net.topology.script.number.args<span class="tok-nt">&lt;/name&gt;</span>
  <span class="tok-nt">&lt;value&gt;</span>75<span class="tok-nt">&lt;/value&gt;</span>
<span class="tok-nt">&lt;/property&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">校验</div>
<p>上述步骤完成后，重启 HDFS 以及 MapReduce 服务。查看 <em>/var/log/hadoop/hdfs</em> 下的日志，看是否有类似下面的输出：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>2018-11-13 15:58:08,495 INFO org.apache.hadoop.net.NetworkTopology: Adding a new node: /rack01/&lt;ipaddres&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>继续执行 <code>hdfs fsck</code> 来确保没有不一致的情况发生，对于有两个机架的集群，该命令的输出的最后几行类似如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code>Status: HEALTHY  Total size: 123456789 B  Total dirs: 0  Total files: 1
Total blocks (validated): 1 (avg. block size 123456789 B)
Minimally replicated blocks: 1 (100.0 %)  Over-replicated blocks: 0 (0.0 %)
Under-replicated blocks: 0 (0.0 %)  Mis-replicated blocks: 0 (0.0 %)
Default replication factor: 3  Average block replication: 3.0  Corrupt
blocks: 0  Missing replicas: 0 (0.0 %)  Number of data-nodes: 40  Number of
racks: 2  FSCK ended at Mon Nov 13 17:10:51 UTC 2018 in 1 milliseconds</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
最后更新时间 2018-12-19 14:18:08 +0800
</div>
</div>
</body>
</html>